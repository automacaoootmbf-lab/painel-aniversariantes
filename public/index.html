<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Aniversariantes</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="/firebase-config.js"></script>

  <style>
    :root {
      --eletro-blue: #003366;
      --eletro-teal: #009a74;
      --muted: #6b7280;
      --bg-page: #f8fafc;
      --card-bg: #ffffff;
      --text-color: #0f172a;
      --soft-border: #e2e8f0;
      --shadow-1: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius: 12px;
    }

    html.dark {
      --muted: #9ca3af;
      --bg-page: #111827;
      --card-bg: #1f2937;
      --text-color: #f9fafb;
      --soft-border: #374151;
      --shadow-1: 0 4px 6px -1px rgb(255 255 255 / 0.05), 0 2px 4px -2px rgb(255 255 255 / 0.05);
    }

    html, body {
      height: 100%; margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Arial;
      background: var(--bg-page); color: var(--text-color); transition: background 0.3s ease, color 0.3s ease;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 28px 20px; position: relative; z-index: 10; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 18px; padding-bottom: 18px; border-bottom: 1px solid var(--soft-border); margin-bottom: 22px; }
    .title-group { display: flex; gap: 12px; align-items: center; }
    svg.logo-icon { width: 56px; height: 56px; border-radius: 8px; padding: 6px; background: linear-gradient(135deg, var(--eletro-blue), var(--eletro-teal)); color: white; }
    h1 { font-size: 22px; margin: 0; color: var(--text-color); font-weight: 600; }
    html.dark h1 { color: var(--eletro-teal); }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    #theme-toggle-btn { background: none; border: none; cursor: pointer; color: var(--muted); padding: 4px; display: flex; align-items: center; justify-content: center; }
    #theme-toggle-btn svg { width: 22px; height: 22px; }
    .sun-icon { display: none; }
    .moon-icon { display: block; }
    html.dark .sun-icon { display: block; }
    html.dark .moon-icon { display: none; }
    #tabs-container { position: relative; display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; border-bottom: 1px solid var(--soft-border); }
    #active-tab-underline { position: absolute; bottom: -1px; height: 2px; background-color: var(--eletro-blue); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    html.dark #active-tab-underline { background-color: var(--eletro-teal); }
    .tab-btn { background: transparent; border: none; padding: 10px 14px; color: var(--muted); font-weight: 600; cursor: pointer; transition: color 0.2s ease-in-out; z-index: 1; }
    .tab-btn:hover { color: var(--text-color); }
    .tab-btn.active { color: var(--eletro-blue); }
    html.dark .tab-btn.active { color: var(--eletro-teal); }
    .tab-panel { margin-top: 12px; }
    .bg-card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow-1); border: 1px solid var(--soft-border); transition: background 0.3s ease, border-color 0.3s ease; }
    #today-panel-grid, #upcoming-panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .birthday-card { display: flex; align-items: center; gap: 16px; padding: 16px; }
    .avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 18px; flex-shrink: 0; }
    .card-info .name { font-weight: 600; display: block; }
    .card-info .sector, .card-info .date { font-size: 14px; color: var(--muted); }
    .table-avatar-cell { display: flex; align-items: center; gap: 12px; }
    table { border-collapse: collapse; width: 100%; }
    thead th { background: #f8fafc; padding: 14px; text-align: left; font-size: 14px; color: #475569; cursor: pointer; user-select: none; }
    thead th:hover { background: #f1f5f9; }
    html.dark thead th { background: #374151; color: #d1d5db; }
    html.dark thead th:hover { background: #4b5563; }
    tbody tr { border-bottom: 1px solid var(--soft-border); }
    tbody tr:last-child { border-bottom: none; }
    tbody td { padding: 12px 14px; }
    .search-input { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--soft-border); background-color: var(--bg-page); margin-bottom: 16px; color: var(--text-color); }
    .search-input:focus { outline: none; border-color: var(--eletro-blue); box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.2); }
    html.dark .search-input:focus { border-color: var(--eletro-teal); box-shadow: 0 0 0 2px rgba(0, 154, 116, 0.2); }
    #calendar-grid .day-cell { background-color: rgba(0, 154, 116, 0.05); cursor: pointer; }
    #calendar-grid .day-cell[data-count="1"] { background-color: rgba(0, 154, 116, 0.2); }
    #calendar-grid .day-cell[data-count="2"] { background-color: rgba(0, 154, 116, 0.5); }
    #calendar-grid .day-cell[data-count="3"] { background-color: rgba(0, 154, 116, 0.8); }
    .admin-only { display: none !important; }
    body.admin-mode .admin-only { display: block !important; }
    .admin-only-table-cell { display: none !important; }
    body.admin-mode .admin-only-table-cell { display: table-cell !important; }
    .hidden { display: none !important; }
    #notification-toast { position: fixed; right: 20px; bottom: 20px; padding: 12px 16px; border-radius: 8px; color: white; opacity: 0; transform: translateY(10px); transition: all .25s ease; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); z-index: 1000000; }
    #fullscreen-celebration { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; overflow: hidden; z-index: 999999; }
    canvas#confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .balloon { position: absolute; bottom: -120px; width: 60px; height: 80px; border-radius: 80% 80% 70% 70%; opacity: 0.95; animation: rise 10s ease-in forwards; z-index: 1000; }
    .balloon::before { content: ''; position: absolute; width: 1px; height: 50px; background-color: rgba(0, 0, 0, 0.4); bottom: -50px; left: 50%; transform: translateX(-50%); }
    .balloon::after { content: ''; position: absolute; border-style: solid; border-width: 0 8px 12px 8px; border-color: transparent transparent inherit transparent; bottom: -10px; left: calc(50% - 8px); }
    @keyframes rise { 0% { transform: translateY(0) scale(0.8) rotate(5deg); } 100% { transform: translateY(-120vh) scale(1.2) rotate(-5deg); opacity: 0; } }
    #calendar-tooltip { position: absolute; display: none; padding: 8px 12px; background-color: var(--card-bg); border: 1px solid var(--soft-border); border-radius: 8px; box-shadow: var(--shadow-1); z-index: 10000; pointer-events: none; font-size: 14px; max-width: 250px; transition: opacity 0.2s; }
    #calendar-tooltip ul { margin: 0; padding: 0; list-style: none; } #calendar-tooltip li { white-space: nowrap; margin-bottom: 4px; } #calendar-tooltip li:last-child { margin-bottom: 0; } #calendar-tooltip .name { font-weight: 600; } #calendar-tooltip .sector { color: var(--muted); }
    #loading-indicator { display: flex; justify-content: center; align-items: center; padding: 40px; font-weight: 500; color: var(--muted); }
    /* Modal Styles */
    #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; }
    #modal-content { background: var(--card-bg); padding: 24px; border-radius: var(--radius); width: 90%; max-width: 400px; }
    #modal-content h2 { margin-top: 0; }
    #modal-form .form-group { margin-bottom: 16px; }
    #modal-form label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
    #modal-form input, #modal-form select { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--soft-border); background-color: var(--bg-page); color: var(--text-color); }
    #modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
    #modal-actions button { padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    #modal-save-btn { background: var(--eletro-blue); color: white; border: none; }
    #modal-cancel-btn { background: transparent; border: 1px solid var(--soft-border); color: var(--text-color); }

    /* Responsive Table to Cards */
    @media (max-width: 768px) {
      table thead { display: none; }
      table tbody, table tr, table td { display: block; width: 100%; }
      table tr { border: 1px solid var(--soft-border); border-radius: var(--radius); margin-bottom: 16px; }
      table td { border: none; padding-left: 16px; padding-right: 16px; display: flex; justify-content: space-between; align-items: center; }
      table td:first-child { padding-top: 16px; }
      table td:last-child { padding-bottom: 16px; }
      table td::before { content: attr(data-label); font-weight: 600; padding-right: 12px; }
      .table-avatar-cell { flex-direction: column; align-items: flex-start !important; gap: 4px !important; }
      .table-avatar-cell .avatar { display: none; } /* Oculta avatar na vista de cartão para simplicidade */
      table td[data-label="Ações"]::before { display: none; }
      table td[data-label="Ações"] { justify-content: flex-start; gap: 8px; }
    }
  </style>
</head>

<body>
  <div id="fullscreen-celebration"><canvas id="confetti-canvas"></canvas></div>
  <div id="calendar-tooltip"></div>
  
  <div class="container">
    <header>
      <div class="title-group">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.975M15 10a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        <div>
          <h1>Painel de Aniversariantes</h1>
          <p style="margin:0; color:var(--muted); font-size:13px">Celebre com a nossa equipe.</p>
        </div>
      </div>
      <div class="header-actions">
          <button id="theme-toggle-btn" aria-label="Toggle dark mode">
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
          </button>
        <button id="auth-btn" class="tertiary text-sm">🔒 Acesso Restrito</button>
      </div>
    </header>

    <div id="tabs-container">
      <button data-tab="today" class="tab-btn">🎂 Hoje</button>
      <button data-tab="upcoming" class="tab-btn">🎉 Próximos</button>
      <button data-tab="calendar" class="tab-btn">🗓️ Calendário</button>
      <button data-tab="list" class="tab-btn">📋 Lista Completa</button>
      <button data-tab="chart" class="tab-btn admin-only">📊 Gestão</button>
      <div id="active-tab-underline"></div>
    </div>

    <main id="tab-panels-container">
      <div id="loading-indicator">
          <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H8v-2h3V6l4 4-4 4z"></path></svg>
          Carregando dados...
      </div>
      <div id="content-wrapper" class="hidden">
        <div id="today-panel" class="tab-panel"></div>
        <div id="upcoming-panel" class="tab-panel hidden"></div>
        <div id="calendar-panel" class="tab-panel hidden">
          <div class="bg-card p-4 rounded-lg">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
              <h2 style="margin:0; font-size:18px">Calendário Heatmap</h2>
              <div>
                <button id="prev-month-btn" style="margin-right:6px">◀</button>
                <span id="calendar-month-year"></span>
                <button id="next-month-btn" style="margin-left:6px">▶</button>
              </div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
          </div>
        </div>
        <div id="list-panel" class="tab-panel hidden">
          <div class="bg-card p-4 rounded-lg">
              <div style="display:flex; flex-wrap: wrap; justify-content:space-between; align-items:center; margin-bottom:12px; gap: 12px;">
                  <h2 style="margin:0; font-size:18px">Lista Completa</h2>
                  <div class="admin-only" style="display:flex; gap: 8px;">
                      <button id="import-csv-btn" style="background:var(--eletro-teal); color:#fff; padding:8px 12px; border-radius:8px">Importar CSV</button>
                      <button id="export-csv-btn" style="background:var(--eletro-teal); color:#fff; padding:8px 12px; border-radius:8px">Exportar CSV</button>
                      <button id="add-person-btn" style="background:var(--eletro-blue); color:#fff; padding:8px 12px; border-radius:8px">+ Adicionar</button>
                      <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                  </div>
              </div>
              <input type="search" id="search-input" placeholder="Buscar por nome ou setor..." class="search-input">
              <div style="overflow:auto">
                  <table>
                      <thead><tr>
                        <th data-sort="name">Nome <span></span></th>
                        <th data-sort="sector">Setor <span></span></th>
                        <th data-sort="date">Data <span></span></th>
                        <th class="admin-only-table-cell" data-sort="none">Ações</th>
                      </tr></thead>
                      <tbody id="birthday-table-body"></tbody>
                  </table>
                  <div id="no-results" class="hidden" style="padding:18px; color:var(--muted)">Nenhum resultado encontrado.</div>
              </div>
          </div>
        </div>
        <div id="chart-panel" class="tab-panel hidden admin-only">
          <div class="bg-card p-6 rounded-lg">
            <h2 style="margin:0 0 18px 0; font-size:20px; font-weight: 600;">Análises de Dados</h2>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
              <div class="lg:col-span-3 bg-gray-50/50 dark:bg-gray-800/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700"><canvas id="birthday-chart"></canvas></div>
              <div class="lg:col-span-2 bg-gray-50/50 dark:bg-gray-800/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700"><canvas id="sector-chart"></canvas></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="notification-toast"></div>

  <div id="modal-overlay" class="hidden">
    <div id="modal-content">
      <h2 id="modal-title">Adicionar Aniversariante</h2>
      <form id="modal-form">
        <input type="hidden" id="modal-person-id">
        <div class="form-group">
          <label for="person-name">Nome</label>
          <input type="text" id="person-name" required>
        </div>
        <div class="form-group">
          <label for="person-sector">Setor</label>
          <input type="text" id="person-sector" required>
        </div>
        <div style="display: flex; gap: 16px;">
          <div class="form-group" style="flex: 1;">
            <label for="person-day">Dia</label>
            <input type="number" id="person-day" required min="1" max="31">
          </div>
          <div class="form-group" style="flex: 1;">
            <label for="person-month">Mês</label>
            <input type="number" id="person-month" required min="1" max="12">
          </div>
        </div>
        <div id="modal-actions">
          <button type="button" id="modal-cancel-btn">Cancelar</button>
          <button type="submit" id="modal-save-btn">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
      // ... (declaração de constantes de elementos DOM) ...
      const authBtn = document.getElementById('auth-btn');
      const tabsContainer = document.getElementById('tabs-container');
      const activeTabUnderline = document.getElementById('active-tab-underline');
      const todayPanel = document.getElementById('today-panel');
      const upcomingPanel = document.getElementById('upcoming-panel');
      const calendarGrid = document.getElementById('calendar-grid');
      const calendarMonthYear = document.getElementById('calendar-month-year');
      const prevMonthBtn = document.getElementById('prev-month-btn');
      const nextMonthBtn = document.getElementById('next-month-btn');
      const tableBody = document.getElementById('birthday-table-body');
      const searchInput = document.getElementById('search-input');
      const noResults = document.getElementById('no-results');
      const notificationToast = document.getElementById('notification-toast');
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      const confettiCanvas = document.getElementById('confetti-canvas');
      const celebrationContainer = document.getElementById('fullscreen-celebration');
      const calendarTooltip = document.getElementById('calendar-tooltip');
      const confettiCannon = confetti.create(confettiCanvas, { resize: true });
      const loadingIndicator = document.getElementById('loading-indicator');
      const contentWrapper = document.getElementById('content-wrapper');

      // Modal elements
      const modalOverlay = document.getElementById('modal-overlay');
      const modalForm = document.getElementById('modal-form');
      const modalTitle = document.getElementById('modal-title');
      const modalPersonId = document.getElementById('modal-person-id');
      const modalCancelBtn = document.getElementById('modal-cancel-btn');
      const addPersonBtn = document.getElementById('add-person-btn');
      const tableHeader = document.querySelector('#list-panel thead');
      
      // CSV elements
      const importCsvBtn = document.getElementById('import-csv-btn');
      const exportCsvBtn = document.getElementById('export-csv-btn');
      const csvFileInput = document.getElementById('csv-file-input');

      // ... (declaração de variáveis globais) ...
      const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      const avatarColors = ['#003366', '#009a74', '#f0b400', '#dc2626', '#3b82f6', '#f43f5e', '#a855f7'];
      let db, auth, dbCollection, dataUnsub = null;
      let birthdayData = [];
      let currentDate = new Date();
      let isAdmin = false;
      let birthdayChart = null;
      let sectorChart = null;
      let sortConfig = { key: 'date', direction: 'ascending' };

      // ... (funções helper: showNotification, getInitials, getColorForName, createAvatar) ...
      const showNotification = (msg, isError = false) => { /* ... (código original sem alterações) ... */ };
      const getInitials = (name) => { /* ... (código original sem alterações) ... */ };
      const getColorForName = (name) => { /* ... (código original sem alterações) ... */ };
      const createAvatar = (name) => { /* ... (código original sem alterações) ... */ };
      const createBalloons = () => { /* ... (código original sem alterações) ... */ };
      const triggerCelebration = () => { /* ... (código original sem alterações) ... */ };

      const mapFirebaseDoc = (doc) => ({
          id: doc.id, name: doc.data().name || "", sector: doc.data().sector || "",
          day: Number(doc.data().day) || 0, month: Number(doc.data().month) || 0,
      });

      // ... (Funções do Firebase: initFirebase, fetchAndRenderData, attachRealtimeListener, setupAuthListener) ...
      const initFirebase = () => { /* ... (código original sem alterações) ... */ };
      const fetchAndRenderData = async () => {
        try {
          const snap = await getDocs(dbCollection);
          birthdayData = snap.docs.map(mapFirebaseDoc);
          renderAll();
        } catch (err) {
          showNotification("Não foi possível carregar os dados.", true);
        } finally {
          loadingIndicator.classList.add('hidden');
          contentWrapper.classList.remove('hidden');
          attachRealtimeListener();
        }
      };
      const attachRealtimeListener = () => { /* ... (código original sem alterações) ... */ };
      const setupAuthListener = () => { /* ... (código original sem alterações) ... */ };


      // ===== RENDER FUNCTIONS =====
      const renderAll = (searchTerm = '') => {
        // Sort data based on config
        birthdayData.sort((a, b) => {
          const dir = sortConfig.direction === 'ascending' ? 1 : -1;
          const valA = sortConfig.key === 'date' ? a.month * 100 + a.day : a[sortConfig.key];
          const valB = sortConfig.key === 'date' ? b.month * 100 + b.day : b[sortConfig.key];
          if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
          return (valA - valB) * dir;
        });

        renderToday();
        renderUpcoming();
        renderTable(searchTerm);
        renderCalendar();
      };
      
      const renderToday = () => { /* ... (código original sem alterações) ... */ };

      const renderUpcoming = () => {
        upcomingPanel.innerHTML = '';
        const today = new Date();
        const upcomingBdays = [];
        const todayDayOfYear = Math.ceil((today - new Date(today.getFullYear(), 0, 1)) / 86400000);

        for(let i=1; i <= 15; i++) {
          const futureDate = new Date();
          futureDate.setDate(today.getDate() + i);
          const day = futureDate.getDate();
          const month = futureDate.getMonth() + 1;
          const todays = birthdayData.filter(p => p.day === day && p.month === month);
          if(todays.length > 0) upcomingBdays.push(...todays);
        }
        
        if (upcomingBdays.length === 0) {
          upcomingPanel.innerHTML = `<div class="bg-card p-4 text-center rounded-lg">Nenhum aniversário nos próximos 15 dias.</div>`;
        } else {
          const grid = document.createElement('div');
          grid.id = 'upcoming-panel-grid';
          upcomingBdays.forEach(p => {
            const card = document.createElement('div');
            card.className = 'birthday-card bg-card';
            const avatar = createAvatar(p.name);
            const info = document.createElement('div');
            info.className = 'card-info';
            info.innerHTML = `<span class="name">${p.name}</span><span class="sector">${p.sector}</span><span class="date">Dia: ${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}</span>`;
            card.append(avatar, info);
            grid.appendChild(card);
          });
          upcomingPanel.appendChild(grid);
        }
      };

      const renderTable = (searchTerm = '') => {
        tableBody.innerHTML = '';
        const lowerCaseSearch = searchTerm.toLowerCase();
        const filteredData = searchTerm ? birthdayData.filter(p => p.name.toLowerCase().includes(lowerCaseSearch) || p.sector.toLowerCase().includes(lowerCaseSearch)) : birthdayData;

        noResults.classList.toggle('hidden', filteredData.length > 0);
        
        filteredData.forEach(p => {
          const tr = document.createElement('tr');
          const nameCell = document.createElement('td');
          nameCell.dataset.label = "Nome";
          nameCell.className = 'table-avatar-cell';
          const avatar = createAvatar(p.name);
          const nameSpan = document.createElement('span');
          nameSpan.textContent = p.name;
          nameCell.append(avatar, nameSpan);
          
          const actionsCell = document.createElement('td');
          actionsCell.dataset.label = "Ações";
          actionsCell.className = "admin-only-table-cell";
          actionsCell.innerHTML = `
            <button class="edit-btn" style="color:var(--eletro-blue)">Editar</button>
            <button class="delete-btn" style="color:#dc2626">Excluir</button>`;
          
          actionsCell.querySelector('.edit-btn').onclick = () => openModal(p);
          actionsCell.querySelector('.delete-btn').onclick = () => deletePerson(p.id, p.name);

          tr.innerHTML = `
            <td data-label="Setor">${p.sector}</td>
            <td data-label="Data">${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}</td>`;
          tr.prepend(nameCell);
          tr.appendChild(actionsCell);
          tableBody.appendChild(tr);
        });
        updateSortIndicators();
      };
      
      const renderCalendar = () => { /* ... (código original sem alterações) ... */ };
      const renderCharts = () => { /* ... (código original sem alterações) ... */ };

      // ===== CRUD & Modal Functions =====
      const openModal = (person = null) => {
        modalForm.reset();
        if(person) {
          modalTitle.textContent = "Editar Aniversariante";
          modalPersonId.value = person.id;
          document.getElementById('person-name').value = person.name;
          document.getElementById('person-sector').value = person.sector;
          document.getElementById('person-day').value = person.day;
          document.getElementById('person-month').value = person.month;
        } else {
          modalTitle.textContent = "Adicionar Aniversariante";
          modalPersonId.value = '';
        }
        modalOverlay.classList.remove('hidden');
      };
      const closeModal = () => modalOverlay.classList.add('hidden');
      const savePerson = async (e) => {
        e.preventDefault();
        const id = modalPersonId.value;
        const personData = {
          name: document.getElementById('person-name').value,
          sector: document.getElementById('person-sector').value,
          day: Number(document.getElementById('person-day').value),
          month: Number(document.getElementById('person-month').value),
        };
        // Simple validation
        if(!personData.name || !personData.sector || !personData.day || !personData.month) {
          return showNotification("Todos os campos são obrigatórios.", true);
        }
        try {
          if(id) {
            await updateDoc(doc(db, 'aniversariantes', id), personData);
            showNotification("Dados atualizados com sucesso!");
          } else {
            await addDoc(dbCollection, personData);
            showNotification("Aniversariante adicionado com sucesso!");
          }
          closeModal();
        } catch (err) {
          showNotification("Erro ao salvar. Tente novamente.", true);
        }
      };
      const deletePerson = async (id, name) => {
        if(confirm(`Tem certeza que deseja excluir ${name}?`)){
          try {
            await deleteDoc(doc(db, 'aniversariantes', id));
            showNotification(`${name} foi excluído.`);
          } catch(err) {
            showNotification("Erro ao excluir. Tente novamente.", true);
          }
        }
      };

      // ===== CSV Functions =====
      const exportToCSV = () => {
        let csvContent = "data:text/csv;charset=utf-8,Nome,Setor,Dia,Mês\n";
        birthdayData.forEach(p => {
          csvContent += `${p.name},${p.sector},${p.day},${p.month}\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "aniversariantes.csv");
        document.body.appendChild(link);
        link.click();
        link.remove();
        showNotification("Dados exportados para CSV.");
      };
      const importFromCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (event) => {
          const text = event.target.result;
          const rows = text.split('\n').slice(1); // Ignora cabeçalho
          const newEntries = [];
          rows.forEach(row => {
            const cols = row.split(',');
            if(cols.length === 4) {
              const [name, sector, day, month] = cols;
              if (name && sector && !isNaN(parseInt(day)) && !isNaN(parseInt(month))) {
                newEntries.push({ name: name.trim(), sector: sector.trim(), day: parseInt(day), month: parseInt(month) });
              }
            }
          });
          if(confirm(`${newEntries.length} registros válidos encontrados. Deseja adicioná-los ao banco de dados?`)) {
            try {
              for (const entry of newEntries) {
                await addDoc(dbCollection, entry);
              }
              showNotification("Dados importados com sucesso!");
            } catch (err) {
              showNotification("Erro durante a importação.", true);
            }
          }
        };
        reader.readAsText(file);
        e.target.value = ''; // Limpa o input para permitir re-upload do mesmo arquivo
      };

      // ===== Sort Function =====
      const updateSortIndicators = () => {
        tableHeader.querySelectorAll('th').forEach(th => {
          const span = th.querySelector('span');
          if (!span) return;
          if (th.dataset.sort === sortConfig.key) {
            span.textContent = sortConfig.direction === 'ascending' ? ' ▲' : ' ▼';
          } else {
            span.textContent = '';
          }
        });
      };
      
      // ===== EVENT LISTENERS =====
      authBtn.addEventListener('click', () => { /* ... (código original sem alterações) ... */ });
      prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
      searchInput.addEventListener('input', (e) => renderTable(e.target.value));
      tabsContainer.addEventListener('click', (ev) => { /* ... (código original sem alterações) ... */ });
      themeToggleBtn.addEventListener('click', () => { /* ... (código original sem alterações) ... */ });
      
      // New CRUD Listeners
      addPersonBtn.addEventListener('click', () => openModal());
      modalCancelBtn.addEventListener('click', closeModal);
      modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) closeModal(); });
      modalForm.addEventListener('submit', savePerson);

      // New CSV Listeners
      importCsvBtn.addEventListener('click', () => csvFileInput.click());
      csvFileInput.addEventListener('change', importFromCSV);
      exportCsvBtn.addEventListener('click', exportToCSV);

      // New Sort Listener
      tableHeader.addEventListener('click', (e) => {
        const th = e.target.closest('th');
        if (!th || th.dataset.sort === 'none') return;
        const key = th.dataset.sort;
        if (sortConfig.key === key) {
          sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
        } else {
          sortConfig.key = key;
          sortConfig.direction = 'ascending';
        }
        renderAll(searchInput.value);
      });

      // Calendar Tooltip Listeners (original)
      calendarGrid.addEventListener('mouseover', (e) => { /* ... (código original sem alterações) ... */ });
      calendarGrid.addEventListener('mouseout', () => { /* ... (código original sem alterações) ... */ });
      calendarGrid.addEventListener('mousemove', (e) => { /* ... (código original sem alterações) ... */ });

      // ===== INITIALIZATION =====
      const initTheme = () => { /* ... (código original sem alterações) ... */ };
      
      initTheme();
      initFirebase();
      const firstTab = tabsContainer.querySelector('.tab-btn');
      if (firstTab) {
          firstTab.click();
          setTimeout(() => {
              activeTabUnderline.style.width = `${firstTab.offsetWidth}px`;
              activeTabUnderline.style.left = `${firstTab.offsetLeft}px`;
          }, 50);
      }
    });
  </script>
</body>
</html>
