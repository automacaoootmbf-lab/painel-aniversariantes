<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Aniversariantes ‚Äî Dashboard (v1.0.3)</title>
  <meta name="description" content="Painel responsivo de aniversariantes com tema claro/escuro, export/import CSV, calend√°rio e celebra√ß√£o com confetes + bal√µes." />
  <meta name="version" content="1.0.3">
  <meta name="theme-color" content="#10b981">

  <style>
  :root{
    --bg-light: #f7fefa;
    --card-light: #ffffff;
    --text-light: #06121a;
    --muted-light: #32474f;
    --bg-dark: #06121a;
    --card-dark: #0b1b24;
    --text-dark: #e8faf5;
    --muted-dark: #9fbfc7;
    --accent-green: #10b981;
    --accent-blue: #0ea5e9;
    --danger: #ef4444;
    --contrast-border-light: rgba(2,6,23,0.08);
    --contrast-border-dark: rgba(255,255,255,0.06);
    --elevation: 0 10px 36px rgba(2,6,23,0.18);
    --radius-lg: 16px;
    --radius-md: 10px;
  }

  [data-theme="light"]{
    --bg: var(--bg-light);
    --card: var(--card-light);
    --text: var(--text-light);
    --muted: var(--muted-light);
    --accent: var(--accent-green);
    --accent2: var(--accent-blue);
    --contrast-border: var(--contrast-border-light);
  }

  [data-theme="dark"]{
    --bg: var(--bg-dark);
    --card: var(--card-dark);
    --text: var(--text-dark);
    --muted: var(--muted-dark);
    --accent: var(--accent-green);
    --accent2: var(--accent-blue);
    --contrast-border: var(--contrast-border-dark);
  }

  /* === NOVO: deixa o select leg√≠vel em ambos os temas === */
  select{
    background-color: var(--card);
    color: var(--text);
  }

  select option{
    background-color: var(--card);
    color: var(--text);
  }

  [data-theme="dark"] select{
    background-color: var(--card-dark);
    color: var(--text-dark);
  }

  [data-theme="dark"] select option{
    background-color: var(--card-dark);
    color: var(--text-dark);
  }
  /* === FIM DO BLOCO NOVO === */

  *,*::before,*::after{box-sizing:border-box}
  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    line-height:1.35
  }
  :focus{
    outline:3px solid color-mix(in srgb, var(--accent) 36%, transparent);
    outline-offset:3px
  }
  @media (prefers-reduced-motion: reduce){
    *{
      animation-duration:0.001ms !important;
      transition-duration:0.001ms !important
    }
  }

  .container{max-width:1180px;margin:20px auto;padding:18px}
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px;
    border-radius:var(--radius-lg);
    background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
    box-shadow:var(--elevation);
    border:1px solid var(--contrast-border)
  }
  .branding{display:flex;gap:12px;align-items:center}
  .logo{
    width:56px;
    height:56px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(135deg,var(--accent2),var(--accent));
    color:white;
    font-weight:700;
    font-size:18px
  }
  h1{margin:0;font-size:18px}
  .sub{margin:0;color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{
    appearance:none;
    border:0;
    padding:10px 12px;
    border-radius:10px;
    background:linear-gradient(90deg,var(--accent2),var(--accent));
    color:white;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(2,6,23,0.08)
  }
  .btn.ghost{
    background:transparent;
    color:var(--accent);
    border:1px solid var(--contrast-border);
    box-shadow:none
  }
  .btn.small{padding:8px 10px;font-size:13px}
  .tab-row{display:flex;gap:8px;margin:18px 0;flex-wrap:wrap}
  .tab{
    padding:8px 14px;
    border-radius:10px;
    background:transparent;
    border:1px solid transparent;
    cursor:pointer;
    color:var(--muted)
  }
  .tab[aria-selected="true"]{
    background:var(--accent);
    color:white;
    box-shadow:0 8px 24px rgba(2,6,23,0.08)
  }
  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .bg-card{
    background:var(--card);
    border-radius:var(--radius-md);
    padding:16px;
    border:1px solid var(--contrast-border);
    box-shadow:0 6px 18px rgba(0,0,0,0.04)
  }
  .card{
    border-radius:12px;
    padding:12px;
    background:linear-gradient(180deg,transparent,rgba(0,0,0,0.01));
    border:1px solid var(--contrast-border)
  }
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .day{
    min-height:100px;
    border-radius:10px;
    padding:12px;
    border:1px dashed var(--contrast-border);
    position:relative;
    background:linear-gradient(180deg,transparent,rgba(0,0,0,0.01))
  }
  .day .num{
    position:absolute;
    right:10px;
    top:8px;
    color:var(--muted);
    font-size:13px;
    font-weight:600
  }
  table{width:100%;border-collapse:collapse}
  th,td{
    padding:12px;
    border-bottom:1px solid var(--contrast-border);
    text-align:left
  }
  th{color:var(--accent);font-weight:700}
  tr:hover{background:linear-gradient(90deg,rgba(0,0,0,0.02),transparent)}
  .small{font-size:13px;color:var(--muted)}
  #toast{
    position:fixed;
    right:20px;
    bottom:20px;
    padding:12px 16px;
    border-radius:12px;
    background:var(--accent);
    color:white;
    box-shadow:0 6px 24px rgba(0,0,0,0.25);
    transform:translateY(12px);
    opacity:0;
    transition:all .28s;
    z-index:10010
  }
  #toast.show{opacity:1;transform:translateY(0)}
  dialog{border:none}
  .dialog{
    padding:16px;
    background:var(--card);
    border-radius:12px;
    min-width:320px
  }
  #confetti-canvas{
    position:fixed;
    left:0;
    top:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:9999
  }
  #balloon-wrap{
    position:fixed;
    left:0;
    top:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:9980
  }
  .skeleton{
    background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border-radius:8px;
    height:14px
  }
  .fade-in{animation:fadeIn .36s ease both}
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(6px)}
    to{opacity:1;transform:none}
  }
  .admin-only{display:none}
  .admin-visible{display:inline-flex}
  [data-theme="dark"] .small{color:var(--muted-dark)}
</style>
</head>
<body data-theme="light" lang="pt-BR">
  <!-- firebase-config.js should set window.__firebase_config if you want real Firebase -->
  <script src="/firebase-config.js"></script>

  <canvas id="confetti-canvas" aria-hidden="true"></canvas>
  <div id="balloon-wrap" aria-hidden="true"></div>
  <div id="toast" role="status" aria-live="polite"></div>

  <div class="container">
    <header>
      <div class="branding">
        <div class="logo" aria-hidden="true">AA</div>
        <div>
          <h1 id="title-main">Painel de Aniversariantes</h1>
          <p id="subtitle" class="sub">Vis√£o r√°pida ‚Ä¢ Calend√°rio ‚Ä¢ Estat√≠sticas ‚Ä¢ Export/Import</p>
        </div>
      </div>

      <div class="controls">
        <button id="theme-toggle" class="btn ghost" aria-pressed="false" title="Alternar modo claro/escuro">üåô</button>
        <button id="celebrate-btn" class="btn" title="Celebrar aniversariantes">üéâ Celebrar</button>
        <button id="auth-btn" class="btn ghost" title="Entrar/Admin">üîí Entrar</button>
      </div>
    </header>

    <nav class="tab-row" role="tablist" aria-label="Navega√ß√£o do painel">
      <button class="tab" role="tab" aria-selected="true" data-tab="today" id="tab-today">üéÇ Hoje</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="calendar" id="tab-calendar">üóì Calend√°rio</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="list" id="tab-list">üìã Lista</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="future" id="tab-future">üîÆ Futuros</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="stats" id="tab-stats">üìä Gr√°ficos</button>
    </nav>

    <main class="grid" id="main-grid">
      <section id="left-col">
        <div id="today-panel" class="bg-card fade-in" role="region" aria-labelledby="today-title">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2 id="today-title">Hoje</h2>
            <div class="small" id="today-count">‚Äî</div>
          </div>
          <div id="today-content" style="margin-top:12px">Carregando...</div>
        </div>

        <div id="future-panel" class="bg-card fade-in" style="margin-top:14px;" role="region" aria-labelledby="future-title">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 id="future-title">Pr√≥ximos aniversariantes</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <label for="days-ahead" class="small" id="label-days">Pr√≥ximos</label>
              <input id="days-ahead" type="number" min="1" max="365" value="30" style="width:70px;padding:6px;border-radius:8px;border:1px solid var(--contrast-border);background:transparent;color:var(--text)" />
              <button id="refresh-future" class="btn ghost small">Atualizar</button>
            </div>
          </div>
          <div id="future-list" style="margin-top:12px">Carregando...</div>
        </div>

        <div id="stats-panel" class="bg-card fade-in" style="margin-top:14px;" role="region" aria-labelledby="stats-title">
          <h3 id="stats-title">Distribui√ß√£o por m√™s</h3>
          <canvas id="chart-monthly" style="width:100%;height:220px;margin-top:10px"></canvas>
        </div>
      </section>

      <aside id="right-col">
        <div id="actions-card" class="card bg-card" style="margin-bottom:12px" aria-labelledby="actions-title">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 id="actions-title">A√ß√µes r√°pidas</h3>
              <p class="small" id="actions-sub">Importe, exporte ou adicione manualmente.</p>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <input id="csv-file" class="admin-only" type="file" accept=".csv" aria-label="Importar CSV" />
              <div style="display:flex;gap:8px">
                <button id="import-sample" class="btn ghost small admin-only">Importar Exemplo</button>
                <button id="export-csv" class="btn ghost small">Exportar CSV</button>
              </div>
            </div>
          </div>
        </div>

        <div id="list-panel" class="bg-card" role="region" aria-labelledby="list-title">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3 id="list-title">Lista completa</h3>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
              <select id="filter-month" aria-label="Filtrar por m√™s"
                      style="padding:8px;border-radius:8px;border:1px solid var(--contrast-border);background:transparent;color:var(--text)">
                <option value="0">Todos os meses</option>
                <option value="1">Jan</option>
                <option value="2">Fev</option>
                <option value="3">Mar</option>
                <option value="4">Abr</option>
                <option value="5">Mai</option>
                <option value="6">Jun</option>
                <option value="7">Jul</option>
                <option value="8">Ago</option>
                <option value="9">Set</option>
                <option value="10">Out</option>
                <option value="11">Nov</option>
                <option value="12">Dez</option>
              </select>

              <input id="search-input" type="search" placeholder="Buscar por nome ou setor"
                     aria-label="Buscar aniversariantes"
                     style="padding:8px;border-radius:8px;border:1px solid var(--contrast-border);background:transparent;color:var(--text)" />

              <button id="add-btn" class="btn ghost small admin-only">‚ûï Novo</button>
            </div>
          </div>
          <div id="list-wrapper">Carregando...</div>
          <div style="display:flex;justify-content:center;margin-top:8px"><button id="load-more" class="btn ghost small">Carregar mais</button></div>
        </div>

        <div id="version-card" class="bg-card" style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <h4 style="margin:0">Vers√£o</h4>
            <div class="small" id="ver-info">v1.0.3 ‚Ä¢ Internacionaliza√ß√£o pronta</div>
          </div>
          <div style="text-align:right">
            <div class="small">Tema: <span id="current-theme">Claro</span></div>
            <div class="small">Idioma:
              <select id="locale-select" aria-label="Selecionar idioma">
                <option value="pt-BR">pt-BR</option>
                <option value="en-US">en-US</option>
              </select>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <dialog id="login-modal" aria-labelledby="login-heading">
      <div class="dialog">
        <h3 id="login-heading">Login Admin</h3>
        <form id="login-form">
          <label class="small">E-mail
            <input id="login-email" type="email" required style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid var(--contrast-border);background:transparent;color:var(--text)">
          </label>
          <label class="small" style="margin-top:8px">Senha
            <input id="login-pass" type="password" required style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid var(--contrast-border);background:transparent;color:var(--text)">
          </label>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
            <button type="button" id="close-login" class="btn ghost">Fechar</button>
            <button type="submit" class="btn">Entrar</button>
          </div>
        </form>
      </div>
    </dialog>

  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <script>
    /* -------------------------
       App script (v1.0.2)
       - confetti with side reflection, balloons
       - i18n, admin gating, Firebase dynamic init
       - ajustes: fallback textoData -> mes, deduplica√ß√£o, filtros
       ------------------------- */

    const DEFAULT_LOCALE = 'pt-BR';
    let locale = localStorage.getItem('locale') || DEFAULT_LOCALE;
    let dataArr = []; // { id, nome, setor, dia, mes }
    let page = 0;
    const PAGE_SIZE = 20;
    let chart = null;
    let celebratedDate = null;

    // firebase state
    let firebaseInitialized = false;
    let firebaseDb = null;
    let firebaseAuth = null;

    // translations minimal
    const i18n = {
      "pt-BR": {
        title: "Painel de Aniversariantes",
        subtitle: "Vis√£o r√°pida ‚Ä¢ Calend√°rio ‚Ä¢ Estat√≠sticas ‚Ä¢ Export/Import",
        tab_today: "üéÇ Hoje",
        tab_calendar: "üóì Calend√°rio",
        tab_list: "üìã Lista",
        tab_future: "üîÆ Futuros",
        tab_stats: "üìä Gr√°ficos",
        actions_quick: "A√ß√µes r√°pidas",
        import_example: "Importar Exemplo",
        export_csv: "Exportar CSV",
        add_new: "‚ûï Novo",
        search_placeholder: "Buscar por nome ou setor",
        next_upcoming: "Pr√≥ximos aniversariantes",
        distribute: "Distribui√ß√£o por m√™s",
        login: "Entrar",
        logout: "Sair",
        celebrate: "üéâ Celebrar",
        admin_only_note: "A√ß√µes administrativas dispon√≠veis somente para usu√°rios autenticados."
      },
      "en-US": {
        title: "Birthday Dashboard",
        subtitle: "Quick view ‚Ä¢ Calendar ‚Ä¢ Stats ‚Ä¢ Export/Import",
        tab_today: "üéÇ Today",
        tab_calendar: "üóì Calendar",
        tab_list: "üìã List",
        tab_future: "üîÆ Upcoming",
        tab_stats: "üìä Charts",
        actions_quick: "Quick actions",
        import_example: "Import Example",
        export_csv: "Export CSV",
        add_new: "‚ûï New",
        search_placeholder: "Search by name or team",
        next_upcoming: "Upcoming birthdays",
        distribute: "Distribution by month",
        login: "Sign in",
        logout: "Sign out",
        celebrate: "üéâ Celebrate",
        admin_only_note: "Administrative actions only appear for authenticated users."
      }
    };

    function applyTranslations(){
      const t = i18n[locale] || i18n['pt-BR'];
      document.getElementById('title-main').textContent = t.title;
      document.getElementById('subtitle').textContent = t.subtitle;
      document.getElementById('tab-today').textContent = t.tab_today;
      document.getElementById('tab-calendar').textContent = t.tab_calendar;
      document.getElementById('tab-list').textContent = t.tab_list;
      document.getElementById('tab-future').textContent = t.tab_future;
      document.getElementById('tab-stats').textContent = t.tab_stats;
      document.getElementById('actions-title').textContent = t.actions_quick;
      document.getElementById('import-sample').textContent = t.import_example;
      document.getElementById('export-csv').textContent = t.export_csv;
      document.getElementById('add-btn').textContent = t.add_new;
      document.getElementById('search-input').placeholder = t.search_placeholder;
      document.getElementById('future-title').textContent = t.next_upcoming;
      document.getElementById('stats-title').textContent = t.distribute;
      document.getElementById('celebrate-btn').textContent = t.celebrate;
      const authBtn = document.getElementById('auth-btn');
      if(firebaseAuth && firebaseAuth.currentUser){
        authBtn.textContent = t.logout;
      } else {
        authBtn.textContent = t.login;
      }
      document.getElementById('actions-sub').textContent = t.admin_only_note;
    }

    function toast(msg, error=false){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.background = error ? 'var(--danger)' : 'var(--accent)';
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 3500);
    }

    function uid(){ return 'id-'+Math.random().toString(36).slice(2,9); }
    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function initials(name){ return (name||'').split(' ').map(p=>p.charAt(0)).join('').slice(0,2).toUpperCase(); }
    function nextDate(rec, from=new Date()){ const y = from.getFullYear(); let d = new Date(y, rec.mes-1, rec.dia, 12); if(d<from) d = new Date(y+1, rec.mes-1, rec.dia, 12); return d; }

    // ---------- helper para chave √∫nica (deduplica√ß√£o) ----------
    function makeKeyFromRecord(rec){
      const nome  = (rec.nome  || '').trim().toLowerCase();
      const setor = (rec.setor || '').trim().toLowerCase();
      const dia   = String(Number(rec.dia));
      const mes   = String(Number(rec.mes));
      return `${nome}|${setor}|${dia}|${mes}`;
    }

    /* -------- renders -------- */
    function renderToday(){
      const el = document.getElementById('today-content');
      const now = new Date();
      const d = now.getDate(), m = now.getMonth()+1;
      const matches = dataArr.filter(p => Number(p.dia) === d && Number(p.mes) === m);
      const countEl = document.getElementById('today-count');
      if(countEl) countEl.textContent = matches.length + ' encontrado(s)';
      el.innerHTML = '';
      if(!matches.length){
        const next = nextUpcoming();
        if(next){
          const days = Math.ceil((next.date - now)/(1000*60*60*24));
          el.innerHTML = `<p>Nenhum hoje ‚Äî pr√≥ximo: <strong>${escapeHTML(next.nome)}</strong> em ${String(next.dia).padStart(2,'0')}/${String(next.mes).padStart(2,'0')} (${days} dias)</p>`;
        } else {
          el.innerHTML = '<p>Nenhum aniversariante cadastrado.</p>';
        }
        return;
      }
      matches.forEach(p => {
        const row = document.createElement('div');
        row.style.display = 'flex'; row.style.gap = '12px'; row.style.alignItems = 'center'; row.style.marginBottom = '12px';
        const avatar = document.createElement('div');
        avatar.className = 'logo';
        avatar.style.width='48px'; avatar.style.height='48px'; avatar.style.borderRadius='10px'; avatar.style.fontSize='16px';
        avatar.textContent = initials(p.nome);
        const info = document.createElement('div');
        info.innerHTML = `<strong style="font-size:15px">${escapeHTML(p.nome)}</strong><div class="small" style="color:var(--muted)">${escapeHTML(p.setor||'')}</div>`;
        row.appendChild(avatar); row.appendChild(info);
        el.appendChild(row);
      });

      const todayKey = new Date().toISOString().slice(0,10);
      if(matches.length > 0 && celebratedDate !== todayKey){
        celebratedDate = todayKey;
        setTimeout(()=> { celebrateNow({ sideBurst: true, auto: true }); }, 700);
      }
    }

    function renderFuture(daysOverride){
      const input = document.getElementById('days-ahead');
      const daysAhead = typeof daysOverride === 'number'
        ? daysOverride
        : Number(input?.value || 30);

      const now = new Date();
      const end = new Date(now.getTime()+daysAhead*24*60*60*1000);

      const arr = dataArr
        .map(p=>({...p, date: nextDate(p, now)}))
        .filter(x=>x.date>now && x.date<=end)
        .sort((a,b)=>a.date-b.date);

      const wrap = document.getElementById('future-list');
      const fc = document.getElementById('future-count');
      if(fc) fc.textContent = arr.length + ' encontrados';

      if(!arr.length){
        if(wrap) wrap.innerHTML = `<p>Nenhum nos pr√≥ximos ${daysAhead} dias.</p>`;
        return;
      }
      if(wrap) wrap.innerHTML = '';
      arr.forEach(p=>{
        const row = document.createElement('div');
        row.style.padding='8px 0';
        row.style.borderBottom='1px solid var(--contrast-border)';
        row.innerHTML = `<strong>${escapeHTML(p.nome)}</strong> ¬∑ ${escapeHTML(p.setor||'')} ¬∑ ${String(p.dia).padStart(2,'0')}/${String(p.mes).padStart(2,'0')}<div class="small" style="color:var(--muted)">Em ${Math.ceil((p.date-new Date())/(1000*60*60*24))} dia(s) ‚Äî ${formatDate(p.date)}</div>`;
        wrap.appendChild(row);
      });
    }

    function renderCalendar(month = (new Date()).getMonth(), year = (new Date()).getFullYear()){
      let calendarPanel = document.getElementById('calendar-panel');
      if(!calendarPanel){
        calendarPanel = document.createElement('section'); calendarPanel.id = 'calendar-panel'; calendarPanel.className = 'bg-card fade-in'; calendarPanel.style.marginTop = '14px';
        document.getElementById('left-col').appendChild(calendarPanel);
      }
      calendarPanel.innerHTML = '';
      const wrap = document.createElement('div'); wrap.className = 'calendar-grid';
      const daysInMonth = new Date(year, month+1, 0).getDate();
      for(let d=1;d<=daysInMonth;d++){
        const day = document.createElement('div'); day.className='day'; day.tabIndex=0;
        const num = document.createElement('div'); num.className='num'; num.textContent = d; day.appendChild(num);
        const matches = dataArr.filter(p=>Number(p.dia)===d && Number(p.mes)===month+1);
        matches.forEach(m=>{ const el = document.createElement('div'); el.textContent = `üéÇ ${m.nome}`; el.title = m.nome; day.appendChild(el); });
        wrap.appendChild(day);
      }
      calendarPanel.appendChild(wrap);
    }

    function renderList(reset=false){
      if(reset) page = 0;
      const start = page*PAGE_SIZE; const end = start+PAGE_SIZE;

      const searchTerm = (document.getElementById('search-input').value||'').toLowerCase();
      const monthFilter = Number(document.getElementById('filter-month')?.value || '0');

      let items = dataArr.filter(p => {
        const okSearch =
          !searchTerm ||
          (p.nome||'').toLowerCase().includes(searchTerm) ||
          (p.setor||'').toLowerCase().includes(searchTerm);

        const okMonth =
          !monthFilter ||
          Number(p.mes) === monthFilter;

        return okSearch && okMonth;
      });

      items.sort((a,b) =>
        (a.nome || '').localeCompare(b.nome || '', 'pt-BR', { sensitivity: 'base' })
      );

      const slice = items.slice(0,end);
      const wrapper = document.getElementById('list-wrapper');
      if(!slice.length){
        wrapper.innerHTML = '<p>Nenhum registro.</p>';
        const loadMore = document.getElementById('load-more');
        if(loadMore) loadMore.style.display = 'none';
        return;
      }
      const userLogged = (firebaseInitialized && firebaseAuth && firebaseAuth.currentUser);
      let html = '<table role="table" aria-label="Tabela de aniversariantes"><thead><tr><th>Nome</th><th>Setor</th><th>Data</th><th style="text-align:right">A√ß√µes</th></tr></thead><tbody>';
      slice.forEach(p=>{
        html += `<tr><td>${escapeHTML(p.nome)}</td><td>${escapeHTML(p.setor||'')}</td><td>${String(p.dia).padStart(2,'0')}/${String(p.mes).padStart(2,'0')}</td><td style="text-align:right">`;
        if(userLogged){
          html += `<button data-id="${p.id}" class="edit-btn btn ghost small admin-visible">‚úèÔ∏è</button> <button data-id="${p.id}" class="del-btn btn ghost small admin-visible">üóëÔ∏è</button>`;
        } else {
          html += `<span class="small" style="color:var(--muted)">Somente admin</span>`;
        }
        html += `</td></tr>`;
      });
      html += '</tbody></table>';
      wrapper.innerHTML = html;

      if(userLogged){
        wrapper.querySelectorAll('.del-btn').forEach(b=> b.addEventListener('click', async (e)=>{
          const id = e.currentTarget.dataset.id;
          if(!confirm('Excluir?')) return;
          if(firebaseInitialized && firebaseDb){
            try{ await firebaseDb.collection('aniversariantes').doc(id).delete(); toast('Registro exclu√≠do'); }catch(err){ toast('Erro ao excluir: ' + err.message, true); }
          } else {
            dataArr = dataArr.filter(x=>x.id!==id);
            renderList(true); renderToday(); renderFuture(5); renderStats();
            toast('Registro exclu√≠do (demo)');
          }
        }));
        wrapper.querySelectorAll('.edit-btn').forEach(b=> b.addEventListener('click', async (e)=>{
          const id = e.currentTarget.dataset.id;
          const rec = dataArr.find(x=>x.id===id);
          if(!rec) return;
          const nome = prompt('Nome:', rec.nome);
          const setor = (prompt('Setor:', rec.setor||'') || '').toUpperCase();
          const dia = parseInt(prompt('Dia (1-31):', rec.dia),10);
          const mes = parseInt(prompt('M√™s (1-12):', rec.mes),10);
          if(!nome || isNaN(dia) || isNaN(mes)) { toast('Dados inv√°lidos', true); return; }
          if(firebaseInitialized && firebaseDb){
            try{ await firebaseDb.collection('aniversariantes').doc(id).set({ nome, setor, dia, mes }, { merge: true }); toast('Atualizado'); }catch(err){ toast('Erro ao atualizar: ' + err.message, true); }
          } else {
            Object.assign(rec,{ nome, setor, dia, mes });
            renderList(true); renderToday(); renderFuture(5); renderStats();
            toast('Atualizado (demo)');
          }
        }));
      }

      const loadMore = document.getElementById('load-more');
      if(loadMore) loadMore.style.display = items.length > end ? 'inline-block' : 'none';
    }

    function renderStats(){
      const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      const counts = new Array(12).fill(0);
      dataArr.forEach(p=>{ if(p.mes>=1 && p.mes<=12) counts[p.mes-1]++; });
      const ctx = document.getElementById('chart-monthly').getContext('2d');
      const accent = getComputedStyle(document.body).getPropertyValue('--accent') || '#10b981';
      const accent2 = getComputedStyle(document.body).getPropertyValue('--accent2') || '#0ea5e9';
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: months, datasets: [{ label: 'Aniversariantes', data: counts, backgroundColor: counts.map((_,i)=> i%2? accent2: accent) }] },
        options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ display:false } } }
      });
    }

    /* ------------- confetti with reflection ------------- */
    function setupCanvasSize(){ const c = document.getElementById('confetti-canvas'); c.width = window.innerWidth; c.height = window.innerHeight; }
    window.addEventListener('resize', setupCanvasSize);
    setupCanvasSize();

    function isMobileWidth(){ return window.innerWidth <= 768; }

    function launchConfettiWithReflection(desiredCount = 320, options = { sideBurst: true }) {
      const canvas = document.getElementById('confetti-canvas');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const width = canvas.width = window.innerWidth;
      const height = canvas.height = window.innerHeight;
      const colors = ['#10b981','#0ea5e9','#4ade80','#38bdf8','#16a34a'];

      const particleCount = isMobileWidth() ? Math.max(60, Math.floor(desiredCount * 0.28)) : desiredCount;

      const pieces = [];
      const gravity = 0.22;
      const maxBounces = 3;
      for(let i=0;i<particleCount;i++){
        const sideRoll = Math.random();
        let x,y,vx,vy;
        if(options.sideBurst && sideRoll < 0.46){
          x = -8 - Math.random()*40;
          y = Math.random() * height * 0.9;
          vx = 0.9 + Math.random()*2.2;
          vy = -0.6 + Math.random()*2.4;
        } else if(options.sideBurst && sideRoll < 0.92){
          x = width + 8 + Math.random()*40;
          y = Math.random() * height * 0.9;
          vx = -(0.9 + Math.random()*2.2);
          vy = -0.6 + Math.random()*2.4;
        } else {
          x = Math.random() * width;
          y = -10 - Math.random()*140;
          vx = (Math.random()-0.5) * 1.4;
          vy = 0.6 + Math.random()*2.2;
        }
        pieces.push({
          x, y, vx, vy,
          r: 5 + Math.random()*7,
          color: colors[Math.floor(Math.random()*colors.length)],
          rot: Math.random()*360,
          vr: (Math.random()-0.5) * 8,
          bounces: 0,
          life: 0
        });
      }

      function frame(){
        ctx.clearRect(0,0,width,height);
        for(const p of pieces){
          p.vy += gravity * (0.9 + p.r*0.003);
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr * 0.5;
          p.life++;

          const leftBound = -6;
          const rightBound = width + 6;

          if(p.x < leftBound && p.bounces < maxBounces){
            p.x = leftBound;
            p.vx = -p.vx * (0.64 + Math.random()*0.18);
            p.vy = p.vy * 0.8 - (0.5 + Math.random()*0.6);
            p.bounces++;
          } else if(p.x > rightBound && p.bounces < maxBounces){
            p.x = rightBound;
            p.vx = -p.vx * (0.64 + Math.random()*0.18);
            p.vy = p.vy * 0.8 - (0.5 + Math.random()*0.6);
            p.bounces++;
          }

          p.vx *= 0.999;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot * Math.PI/180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
          ctx.restore();
        }

        const alive = pieces.some(p => !(p.y > height + 80 && (p.x < -160 || p.x > width + 160)));
        if(!alive){
          ctx.clearRect(0,0,width,height);
          return;
        }
        requestAnimationFrame(frame);
      }
      frame();
    }

    function launchBalloons(count = 22){
      const wrap = document.getElementById('balloon-wrap');
      const colors = ['#10b981','#0ea5e9','#4ade80','#38bdf8','#16a34a'];
      const actualCount = isMobileWidth() ? Math.max(6, Math.floor(count*0.5)) : count;
      for(let i=0;i<actualCount;i++){
        const el = document.createElementNS('http://www.w3.org/2000/svg','svg');
        el.setAttribute('width','58'); el.setAttribute('height','86'); el.setAttribute('viewBox','0 0 48 68');
        el.style.position = 'fixed';
        const sideBias = Math.random() < 0.5 ? (Math.random()*20 + '%') : (50 + Math.random()*50) + '%';
        el.style.left = sideBias;
        el.style.bottom = '-140px';
        el.style.pointerEvents = 'none';
        el.style.zIndex = 9980;
        const color = colors[i % colors.length];
        el.innerHTML = `<ellipse cx="24" cy="24" rx="18" ry="22" fill="${color}" opacity="0.98"></ellipse><path d="M24 46 L24 74" stroke="#111" stroke-opacity="0.06" stroke-width="1"/>`;
        wrap.appendChild(el);
        const duration = 10000 + Math.random()*9000;
        const delay = Math.random()*700;
        const rotate = Math.random()*60 - 30;
        el.animate([{ transform: 'translateY(0) scale(1)', opacity:1 }, { transform: `translateY(-120vh) rotate(${rotate}deg) scale(1.02)`, opacity:0.02 }], { duration, easing: 'cubic-bezier(.2,.9,.2,1)', delay });
        setTimeout(()=> el.remove(), duration + delay + 500);
      }
    }

    function celebrateNow(opts = { sideBurst: true, auto: false }){
      const side = !!opts.sideBurst;
      const desired = side ? 380 : 220;
      launchConfettiWithReflection(desired, { sideBurst: side });
      launchBalloons(side ? 28 : 18);
      toast(i18n[locale].celebrate || 'üéâ Parab√©ns!');
    }

    /* ------------ CSV helpers ------------ */
    function quoteCSV(s){ return '"' + String(s||'').replace(/"/g,'""') + '"'; }
    function exportCSV(){
      if(!dataArr.length){ toast('Sem dados para exportar', true); return; }
      const header = ['nome','setor','dia','mes'];
      const rows = dataArr.map(r => `${quoteCSV(r.nome)},${quoteCSV(r.setor||'')},${r.dia},${r.mes}`);
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'aniversariantes.csv'; document.body.appendChild(a); a.click(); a.remove();
      toast('CSV exportado');
    }
    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); if(!lines.length) return [];
      const header = lines.shift().split(',').map(h=>h.trim().toLowerCase());
      const idxNome = header.indexOf('nome'); const idxSetor = header.indexOf('setor'); const idxDia = header.indexOf('dia'); const idxMes = header.indexOf('mes');
      if(idxNome<0 || idxDia<0 || idxMes<0){ toast('CSV precisa ter colunas nome,dia,mes', true); return []; }
      const out = [];
      lines.forEach((ln,i)=>{ const parts = ln.match(/(".*?"|[^,]+)/g) || []; const nome = (parts[idxNome]||'').replace(/^"|"$/g,'').trim(); const setor = (parts[idxSetor]||'').replace(/^"|"$/g,'').trim().toUpperCase(); const dia = parseInt((parts[idxDia]||'').replace(/^"|"$/g,''),10); const mes = parseInt((parts[idxMes]||'').replace(/^"|"$/g,''),10); if(nome && !Number.isNaN(dia) && !Number.isNaN(mes)) out.push({ id: uid(), nome, setor, dia, mes }); });
      return out;
    }

    /* --------- Firebase dynamic init (compat) ---------- */

    function mapDocFromFirestore(r){
      let dia = Number(r.dia);
      let mes = Number(r.mes);

      if ((mes === 0 || !mes) && typeof r.textoData === "string") {
        const txt = r.textoData.toLowerCase();
        const map = {
          'janeiro': 1,
          'fevereiro': 2,
          'mar√ßo': 3,
          'marco': 3,
          'abril': 4,
          'maio': 5,
          'junho': 6,
          'julho': 7,
          'agosto': 8,
          'setembro': 9,
          'outubro': 10,
          'novembro': 11,
          'dezembro': 12
        };
        for (const [name, num] of Object.entries(map)) {
          if (txt.includes(name)) {
            mes = num;
            break;
          }
        }
      }

      return {
        ...r,
        setor: (r.setor || '').toUpperCase(),
        dia: dia,
        mes: mes
      };
    }

    async function tryInitFirebase(){
      if(!window.__firebase_config) return false;
      try{
        await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js');

        firebase.initializeApp(window.__firebase_config);
        firebaseInitialized = true;
        firebaseDb = firebase.firestore();
        firebaseAuth = firebase.auth();

        firebaseDb.collection('aniversariantes').onSnapshot(snapshot=>{
          const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          dataArr = docs.map(r => mapDocFromFirestore(r));
          syncRenderAll();
        }, err=>{
          console.warn('onSnapshot failed, fallback to get():', err);
          firebaseDb.collection('aniversariantes').get().then(snap=>{
            dataArr = snap.docs.map(d => ({ id: d.id, ...d.data() })).map(r => mapDocFromFirestore(r));
            syncRenderAll();
          }).catch(()=>{ seedDemo(); syncRenderAll(); });
        });

        firebaseAuth.onAuthStateChanged(user=>{
          updateAuthUI(!!user);
          applyTranslations();
          if(user && !dataArr.length){
            firebaseDb.collection('aniversariantes').get().then(snap=>{
              dataArr = snap.docs.map(d=>({ id:d.id, ...d.data() })).map(r=>mapDocFromFirestore(r));
              syncRenderAll();
            }).catch(()=>{});
          }
        });

        return true;
      }catch(e){
        console.error('Firebase init error', e);
        return false;
      }
    }
    function loadScript(src){ return new Promise((res, rej)=>{ const s = document.createElement('script'); s.src = src; s.onload = res; s.onerror = rej; document.head.appendChild(s); }); }

    /* ------------- Auth UI gating ------------- */
    function updateAuthUI(loggedIn){
      document.querySelectorAll('.admin-only').forEach(el=>{
        if(loggedIn){ el.style.display = ''; el.classList.remove('admin-only'); el.classList.add('admin-visible'); }
        else { el.style.display = 'none'; el.classList.remove('admin-visible'); el.classList.add('admin-only'); }
      });
      renderList(true);
    }

    function seedDemo(){
      dataArr = [
        { id: 'local1', nome: 'Eliomar', setor: 'Ambiental', dia: 15, mes: 1 },
        { id: 'local2', nome: 'Ana Silva', setor: 'TI', dia: 20, mes: 1 },
        { id: 'local3', nome: 'Gabriel Dutra', setor: 'Engenharia', dia: 21, mes: 10 }
      ];
      for(let i=0;i<60;i++){ dataArr.push({ id: 'demo-'+i, nome: 'User '+(i+1), setor: ['RH','TI','Vendas'][i%3], dia: (i%28)+1, mes: ((i%12)+1) }); }
    }
    function syncRenderAll(){ applyTranslations(); renderToday(); renderFuture(5); renderList(true); renderStats(); }

    /* --------- Remo√ß√£o de duplicatas (uma vez) ---------- */
    async function removeDuplicatesOnce(){
      if (!firebaseInitialized || !firebaseDb) {
        console.warn('Firebase n√£o inicializado (modo demo).');
        toast('N√£o d√° pra limpar duplicatas no modo demo.', true);
        return;
      }

      const snap = await firebaseDb.collection('aniversariantes').get();
      const seen = new Set();
      const batch = firebaseDb.batch();
      let deletions = 0;

      snap.forEach(doc => {
        const data = doc.data();
        const key = makeKeyFromRecord(data);

        if (seen.has(key)) {
          batch.delete(doc.ref);
          deletions++;
        } else {
          seen.add(key);
        }
      });

      if (!deletions) {
        console.log('Nenhuma duplicata encontrada.');
        toast('Nenhuma duplicata encontrada.');
        return;
      }

      await batch.commit();
      console.log(`Removidas ${deletions} duplicata(s).`);
      toast(`Removidas ${deletions} duplicata(s).`);
    }

    /* -------------------- Wiring -------------------- */
    document.addEventListener('DOMContentLoaded', async ()=>{
      document.getElementById('locale-select').value = locale;
      document.getElementById('locale-select').addEventListener('change', (e)=>{
        locale = e.target.value;
        localStorage.setItem('locale', locale);
        applyTranslations(); renderList(true); renderToday(); renderFuture(5); renderStats();
      });
      applyTranslations();

      // estado inicial por aba
      document.getElementById('today-panel').style.display = 'block';
      document.getElementById('future-panel').style.display = 'block';
      document.getElementById('stats-panel').style.display = 'none';
      document.getElementById('list-panel').style.display = 'none';
      const actionsCard = document.getElementById('actions-card');
      if(actionsCard) actionsCard.style.display = 'none';

      const themeToggle = document.getElementById('theme-toggle');
      function setTheme(t){
        document.body.setAttribute('data-theme', t);
        document.getElementById('current-theme').textContent = t==='dark' ? 'Escuro' : 'Claro';
        localStorage.setItem('theme',t);
        themeToggle.setAttribute('aria-pressed', t==='dark');
        renderStats();
      }
      setTheme(localStorage.getItem('theme')||'light');
      themeToggle.addEventListener('click', ()=> setTheme(document.body.getAttribute('data-theme')==='dark' ? 'light' : 'dark'));

      document.getElementById('export-csv').addEventListener('click', exportCSV);

      document.getElementById('csv-file').addEventListener('change', (e)=>{
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          const recs = parseCSV(reader.result);
          if(!recs.length) return;

          const existingKeys = new Set(dataArr.map(makeKeyFromRecord));
          const novos = [];
          let ignorados = 0;
          const addedNow = new Set();

          for (const r of recs) {
            const key = makeKeyFromRecord(r);
            if (existingKeys.has(key) || addedNow.has(key)) {
              ignorados++;
              continue;
            }
            addedNow.add(key);
            novos.push(r);
          }

          if (!novos.length) {
            toast('Todos os registros do CSV j√° existem (ou s√£o duplicados).', true);
            return;
          }

          if(firebaseInitialized && firebaseDb){
            novos.forEach(async r=>{
              try{
                await firebaseDb.collection('aniversariantes').add({ nome:r.nome, setor:r.setor, dia:r.dia, mes:r.mes });
              }catch(e){ console.error(e); }
            });
          } else {
            dataArr = dataArr.concat(novos);
            renderList(true); renderStats();
          }
          toast(`Importado ${novos.length} registro(s). Ignorados ${ignorados} duplicado(s).`);
        };
        reader.readAsText(f,'utf-8'); e.target.value = '';
      });

      document.getElementById('import-sample').addEventListener('click', ()=>{
        const sample = 'nome,setor,dia,mes\n"Maria Silva",RH,5,11\n"Jo√£o Pereira",Financeiro,12,3\n"Luiza Costa",Vendas,28,12';
        const recs = parseCSV(sample);
        if(!recs.length) return;

        const existingKeys = new Set(dataArr.map(makeKeyFromRecord));
        const novos = [];
        let ignorados = 0;
        const addedNow = new Set();

        for (const r of recs) {
          const key = makeKeyFromRecord(r);
          if (existingKeys.has(key) || addedNow.has(key)) {
            ignorados++;
            continue;
          }
          addedNow.add(key);
          novos.push(r);
        }

        if (!novos.length) {
          toast('Exemplo j√° existente na base.', true);
          return;
        }

        if(firebaseInitialized && firebaseDb){
          novos.forEach(async r=>{
            try{
              await firebaseDb.collection('aniversariantes').add({ nome:r.nome, setor:r.setor, dia:r.dia, mes:r.mes });
            }catch(e){ console.error(e); }
          });
        } else {
          dataArr = dataArr.concat(novos);
          renderList(true); renderStats();
        }
        toast(`Exemplo importado (${novos.length} novo(s), ${ignorados} ignorado(s)).`);
      });

      document.getElementById('add-btn').addEventListener('click', async ()=>{
        const nome = prompt('Nome completo:'); if(!nome) return;
        const setor = (prompt('Setor (opcional):','') || '').toUpperCase();
        const dia = parseInt(prompt('Dia (1-31):','1'),10);
        const mes = parseInt(prompt('M√™s (1-12):','1'),10);
        if(isNaN(dia)||isNaN(mes)){ toast('Data inv√°lida', true); return; }
        if(firebaseInitialized && firebaseDb && firebaseAuth && firebaseAuth.currentUser){
          try{ await firebaseDb.collection('aniversariantes').add({ nome, setor, dia, mes }); toast('Registro criado'); } catch(e){ toast('Erro: '+e.message, true); }
        } else {
          dataArr.push({ id: uid(), nome, setor, dia, mes }); renderList(true); renderToday(); renderFuture(5); renderStats(); toast('Registro criado (demo)');
        }
      });

      document.getElementById('celebrate-btn').addEventListener('click', ()=> celebrateNow({ sideBurst: false, auto: false }));

      document.getElementById('search-input').addEventListener('input', ()=> renderList(true));
      document.getElementById('filter-month').addEventListener('change', ()=> renderList(true));
      document.getElementById('load-more').addEventListener('click', ()=>{ page++; renderList(); });
      document.getElementById('refresh-future').addEventListener('click', ()=> renderFuture());

      document.querySelectorAll('.tab').forEach(btn=> btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        const tab = btn.dataset.tab;

        const todayPanel   = document.getElementById('today-panel');
        const futurePanel  = document.getElementById('future-panel');
        const statsPanel   = document.getElementById('stats-panel');
        const listPanel    = document.getElementById('list-panel');
        const actionsCard  = document.getElementById('actions-card');

        todayPanel.style.display  = 'none';
        futurePanel.style.display = 'none';
        statsPanel.style.display  = 'none';
        listPanel.style.display   = 'none';
        if(actionsCard) actionsCard.style.display = 'none';

        const calendarPanel = document.getElementById('calendar-panel');
        if(calendarPanel) calendarPanel.remove();

        if(tab === 'today'){
          todayPanel.style.display  = 'block';
          futurePanel.style.display = 'block';
          renderToday();
          renderFuture(5);
        }

        if(tab === 'calendar'){
          renderCalendar();
        }

        if(tab === 'list'){
          listPanel.style.display = 'block';
          if(actionsCard) actionsCard.style.display = 'block';
          renderList(true);
        }

        if(tab === 'future'){
          futurePanel.style.display = 'block';
          renderFuture();
        }

        if(tab === 'stats'){
          statsPanel.style.display = 'block';
          renderStats();
        }
      }));

      const loginModal = document.getElementById('login-modal');
      document.getElementById('auth-btn').addEventListener('click', ()=>{
        if(firebaseInitialized && firebaseAuth && firebaseAuth.currentUser){
          firebaseAuth.signOut().then(()=> toast('Logout realizado')).catch(e=> toast('Erro logout: '+e.message,true));
          return;
        }
        loginModal.showModal();
      });
      document.getElementById('close-login').addEventListener('click', ()=> loginModal.close());
      document.getElementById('login-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        if(firebaseInitialized && firebaseAuth){
          try{ await firebaseAuth.signInWithEmailAndPassword(email, pass); toast('Bem-vindo admin!'); loginModal.close(); } catch(err){ toast('Erro no login: '+err.message, true); }
        } else { toast('Firebase n√£o configurado (modo demo)', true); loginModal.close(); }
      });

      document.addEventListener('keydown', (e)=>{
        if(document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
        if(e.key === 'c' || e.key === 'C'){ celebrateNow({ sideBurst: false, auto: false }); }
        if(e.key === '/'){ e.preventDefault(); document.getElementById('search-input').focus(); }
      });

      const ok = await tryInitFirebase();
      if(!ok){
        seedDemo();
        syncRenderAll();
        updateAuthUI(false);
      }
    });

    function nextUpcoming(){ if(!dataArr.length) return null; const now = new Date(); const list = dataArr.map(p=> ({ ...p, date: nextDate(p, now) })); list.sort((a,b)=>a.date-b.date); return list[0]; }
    function formatDate(d){ try{ return new Intl.DateTimeFormat(locale, { day:'2-digit', month:'2-digit', year:'numeric' }).format(d); }catch(e){ return d.toLocaleDateString(); } }

    // debug / admin helpers
    window.__painel = {
      getData: () => dataArr,
      renderList,
      renderStats,
      celebrateNow,
      removeDuplicatesOnce
    };
  </script>
</body>
</html>
