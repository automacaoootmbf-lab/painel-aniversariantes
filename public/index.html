<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
ย <meta charset="utf-8" />
ย <meta name="viewport" content="width=device-width,initial-scale=1" />
ย <title>Painel de Aniversariantes</title>

ย <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
ย <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
ย <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
ย <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
ย <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

ย <script src="./firebase-config.js"></script>

ย <style>
ย ย :root {
ย ย ย --eletro-blue: #003366;
ย ย ย --eletro-teal: #009a74;
ย ย ย --bg-page: #f8fafc;
ย ย ย --card-bg: #ffffff;
ย ย ย --muted: #6b7280;
ย ย ย --text-color: #0f172a;
ย ย ย --soft-border: #e2e8f0;
ย ย ย --radius: 12px;
ย ย ย --shadow-1: 0 4px 6px -1px rgba(0,0,0,0.1);
ย ย }
ย ย html.dark {
ย ย ย --muted: #9ca3af;
ย ย ย --bg-page: #111827;
ย ย ย --card-bg: #1f2937;
ย ย ย --text-color: #f9fafb;
ย ย ย --soft-border: #374151;
ย ย ย --shadow-1: 0 4px 6px -1px rgba(255,255,255,0.05);
ย ย }
ย ย html, body {
ย ย ย height: 100%;
ย ย ย margin: 0;
ย ย ย padding: 0;
ย ย ย font-family: Inter, system-ui, -apple-system, "Segoe UI", Arial;
ย ย ย background: var(--bg-page);
ย ย ย color: var(--text-color);
ย ย ย transition: background 0.25s, color 0.25s;
ย ย }
ย ย .container {
ย ย ย max-width: 1200px;
ย ย ย margin: 0 auto;
ย ย ย padding: 28px 20px;
ย ย ย position: relative;
ย ย ย z-index: 1;
ย ย }
ย ย header {
ย ย ย display: flex;
ย ย ย align-items: center;
ย ย ย justify-content: space-between;
ย ย ย gap: 18px;
ย ย ย padding-bottom: 18px;
ย ย ย border-bottom: 1px solid var(--soft-border);
ย ย ย margin-bottom: 22px;
ย ย }
ย ย .title-group { display: flex; gap: 12px; align-items: center; }
ย ย .logo-icon {
ย ย ย width: 56px; height: 56px;
ย ย ย border-radius: 8px;
ย ย ย padding: 6px;
ย ย ย background: linear-gradient(135deg, var(--eletro-blue), var(--eletro-teal));
ย ย ย color: white;
ย ย ย display: flex; align-items: center; justify-content: center;
ย ย }
ย ย h1 { font-size: 22px; margin: 0; font-weight: 600; color: var(--text-color); }
ย ย p { margin:0; font-size:13px; color: var(--muted); }
ย ย /* (Modificado V2) */
ย ย .header-actions { display: flex; align-items: center; gap: 0.6rem; }
ย ย button{cursor:pointer} /* (Modificado V2) */

ย ย #tabs-container {
ย ย ย position: relative;
ย ย ย display: flex;
ย ย ย gap: 8px;
ย ย ย flex-wrap: wrap;
ย ย ย margin-bottom: 12px;
ย ย ย border-bottom: 1px solid var(--soft-border);
ย ย ย padding-bottom: 8px;
ย ย }
ย ย .tab-btn {
ย ย ย background: transparent;
ย ย ย border: none;
ย ย ย padding: 10px 14px;
ย ย ย color: var(--muted);
ย ย ย font-weight: 600;
ย ย ย cursor: pointer;
ย ย ย transition: color 0.18s ease-in-out;
ย ย ย z-index: 1;
ย ย }
ย ย .tab-btn.active { color: var(--eletro-blue); }
ย ย #active-tab-underline {
ย ย ย position: absolute;
ย ย ย bottom: -1px;
ย ย ย height: 2px;
ย ย ย background-color: var(--eletro-blue);
ย ย ย transition: all 0.18s cubic-bezier(0.4,0,0.2,1);
ย ย ย left: 0;
ย ย ย width: 0;
ย ย }
ย ย .tab-panel { margin-top: 12px; }
ย ย .bg-card {
ย ย ย background: var(--card-bg);
ย ย ย border-radius: var(--radius);
ย ย ย box-shadow: var(--shadow-1);
ย ย ย border: 1px solid var(--soft-border);
ย ย ย transition: background 0.25s, border-color 0.25s;
ย ย }
ย ย #today-panel-grid, #upcoming-panel-grid {
ย ย ย display: grid;
ย ย ย grid-template-columns: repeat(auto-fill, minmax(280px,1fr));
ย ย ย gap: 16px;
ย ย }
ย ย .birthday-card {
ย ย ย display: flex;
ย ย ย align-items: center;
ย ย ย gap: 16px;
ย ย ย padding: 16px;
ย ย }
ย ย .avatar {
ย ย ย width: 48px; height: 48px;
ย ย ย border-radius: 50%;
ย ย ย display: flex; align-items: center; justify-content: center;
ย ย ย font-weight: 600;
ย ย ย color: white;
ย ย ย font-size: 18px;
ย ย ย flex-shrink: 0;
ย ย }
ย ย .card-info .name { font-weight: 600; display: block; }
ย ย .card-info .sector, .card-info .date { font-size: 14px; color: var(--muted); }
ย ย .table-avatar-cell { display: flex; align-items: center; gap: 12px; }
ย ย table { border-collapse: collapse; width: 100%; }
ย ย thead th {
ย ย ย background: #f8fafc;
ย ย ย padding: 14px;
ย ย ย text-align: left;
ย ย ย font-size: 14px;
ย ย ย color: #475569;
ย ย ย cursor: pointer;
ย ย }
ย ย tbody tr { border-bottom: 1px solid var(--soft-border); }
ย ย tbody td { padding: 12px 14px; }
ย ย .search-input {
ย ย ย width: 100%;
ย ย ย padding: 8px 12px;
ย ย ย border-radius: 8px;
ย ย ย border: 1px solid var(--soft-border);
ย ย ย background-color: var(--bg-page);
ย ย ย margin-bottom: 16px;
ย ย ย color: var(--text-color);
ย ย }
ย ย .admin-only { display: none !important; }
ย ย body.admin-mode .admin-only { display: block !important; }
ย ย .admin-only-table-cell { display: none !important; }
ย ย body.admin-mode .admin-only-table-cell { display: table-cell !important; }
ย ย .hidden { display: none !important; }
ย ย #notification-toast {
ย ย ย position: fixed;
ย ย ย right: 20px;
ย ย ย bottom: 20px;
ย ย ย padding: 12px 16px;
ย ย ย border-radius: 8px;
ย ย ย color: white;
ย ย ย opacity: 0;
ย ย ย transform: translateY(10px);
ย ย ย transition: all 0.25s;
ย ย ย box-shadow: 0 10px 15px rgba(0,0,0,0.1);
ย ย ย z-index: 100000;
ย ย }
ย ย #fullscreen-celebration {
ย ย ย position: fixed;
ย ย ย top: 0; left: 0;
ย ย ย width: 100vw; height: 100vh;
ย ย ย pointer-events: none;
ย ย ย overflow: hidden;
ย ย ย z-index: 999999;
ย ย }
ย ย canvas#confetti-canvas {
ย ย ย position: absolute;
ย ย ย top: 0; left: 0;
ย ย ย width: 100%;
ย ย ย height: 100%;
ย ย ย pointer-events: none;
ย ย }
ย ย /* balloon styles enhanced (Modificado V2) */
ย ย .balloon {
ย ย ย position: absolute;
ย ย ย bottom: -160px; /* (Modificado V2) */
ย ย ย border-radius: 80% 80% 70% 70%;
ย ย ย opacity: 0.98;
ย ย ย animation: rise var(--rise-duration, 10s) ease-in forwards;
ย ย ย pointer-events: none;
ย ย ย box-shadow: 0 10px 20px rgba(0,0,0,0.12); /* (Modificado V2) */
ย ย ย transform-origin: center;
ย ย }
ย ย .balloon .string {
ย ย ย position: absolute;
ย ย ย left: 50%;
ย ย ย transform: translateX(-50%);
ย ย ย width: 2px;
ย ย ย background: rgba(0,0,0,0.06);
ย ย ย bottom: -80px; /* (Modificado V2) */
ย ย ย height: 80px; /* (Modificado V2) */
ย ย }
ย ย .balloon::after {
ย ย ย content: '';
ย ย ย position: absolute;
ย ย ย border-style: solid;
ย ย ย border-width: 0 8px 12px 8px;
ย ย ย border-color: transparent transparent inherit transparent;
ย ย ย bottom: -12px;
ย ย ย left: calc(50% - 8px);
ย ย }
ย ย @keyframes rise {
ย ย ย 0% { transform: translateY(0) scale(0.9) rotate(3deg); opacity: 1; }
ย ย ย 100% { transform: translateY(-120vh) scale(1.15) rotate(-6deg); opacity: 0; }
ย ย }
ย ย #calendar-tooltip {
ย ย ย position: absolute;
ย ย ย display: none;
ย ย ย padding: 8px 12px;
ย ย ย background-color: var(--card-bg);
ย ย ย border: 1px solid var(--soft-border);
ย ย ย border-radius: 8px;
ย ย ย box-shadow: var(--shadow-1);
ย ย ย z-index: 10000;
ย ย ย pointer-events: none;
ย ย ย font-size: 14px;
ย ย ย max-width: 280px;
ย ย }
ย ย #loading-indicator {
ย ย ย display: flex;
ย ย ย justify-content: center;
ย ย ย align-items: center;
ย ย ย padding: 40px;
ย ย ย font-weight: 500;
ย ย ย color: var(--muted);
ย ย }

ย ย /* RESPONSIVO: transform table em lista para celular */
ย ย @media (max-width:768px) {
ย ย ย table thead { display: none; }
ย ย ย table tbody, table tr, table td { display: block; width: 100%; }
ย ย ย table tr { border: 1px solid var(--soft-border); border-radius: var(--radius); margin-bottom: 16px; }
ย ย ย table td {
ย ย ย ย border: none;
ย ย ย ย padding-left: 16px;
ย ย ย ย padding-right: 16px;
ย ย ย ย display: flex;
ย ย ย ย justify-content: space-between;
ย ย ย ย align-items: center;
ย ย ย }
ย ย ย table td::before {
ย ย ย ย content: attr(data-label);
ย ย ย ย font-weight: 600;
ย ย ย ย padding-right: 12px;
ย ย ย }

ย ย ย /* calendar -> list for small screens */
ย ย ย #calendar-grid { display:block; }
ย ย ย .day-cell { display:block; margin-bottom:8px; }
ย ย }

ย ย /* Estilos de destaque no calendรกrio + badge */
ย ย #calendar-grid .day-cell {
ย ย ย position: relative;
ย ย ย transition: background-color 0.18s ease, color 0.18s ease;
ย ย }
ย ย #calendar-grid .day-cell[data-count="1"],
ย ย #calendar-grid .day-cell.bg-card[data-count="1"] {
ย ย ย background-color: rgba(0,154,116,0.18);
ย ย ย color: #053233;
ย ย }
ย ย #calendar-grid .day-cell[data-count="2"],
ย ย #calendar-grid .day-cell.bg-card[data-count="2"] {
ย ย ย background-color: rgba(0,154,116,0.34);
ย ย ย color: #042a2d;
ย ย }
ย ย #calendar-grid .day-cell[data-count="3"],
ย ย #calendar-grid .day-cell.bg-card[data-count="3"] {
ย ย ย background-color: rgba(0,154,116,0.60);
ย ย ย color: #021f23;
ย ย }
ย ย #calendar-grid .birthday-badge {
ย ย ย position: absolute;
ย ย ย right: 6px;
ย ย ย bottom: 6px;
ย ย ย background: var(--eletro-teal);
ย ย ย color: #fff;
ย ย ย font-size: 11px;
ย ย ย font-weight: 700;
ย ย ย padding: 4px 7px;
ย ย ย border-radius: 999px;
ย ย ย box-shadow: 0 4px 10px rgba(0,0,0,0.08);
ย ย ย pointer-events: none;
ย ย ย line-height: 1;
ย ย }
ย ย #calendar-grid .day-num {
ย ย ย font-weight: 700;
ย ย ย font-size: 15px;
ย ย }
ย ย #calendar-grid .day-cell[style*="opacity: 0.25"] {
ย ย ย background: transparent !important;
ย ย ย color: var(--muted);
ย ย }

ย ย /* overlay today */
ย ย #today-overlay {
ย ย ย position: fixed;
ย ย ย right: 20px;
ย ย ย top: 90px;
ย ย ย z-index: 999999;
ย ย ย padding: 12px 16px;
ย ย ย border-radius: 12px;
ย ย ย background: linear-gradient(90deg,#003366,#009a74);
ย ย ย color: #fff;
ย ย ย box-shadow: 0 10px 20px rgba(0,0,0,0.12);
ย ย ย display: none;
ย ย ย align-items: center;
ย ย ย gap: 12px;
ย ย }
ย ย #undo-snackbar {
ย ย ย position: fixed;
ย ย ย left: 20px;
ย ย ย bottom: 20px;
ย ย ย background: #111827;
ย ย ย color: #fff;
ย ย ย padding: 12px 14px;
ย ย ย border-radius: 8px;
ย ย ย display: none;
ย ย ย z-index: 100001;
ย ย ย box-shadow: 0 6px 18px rgba(0,0,0,0.18);
ย ย }
ย ย #celebration-announcer { position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden; }
ย </style>
</head>

<body>
ย <div id="fullscreen-celebration" aria-hidden="true"><canvas id="confetti-canvas" aria-hidden="true"></canvas></div>
ย <div id="calendar-tooltip" role="tooltip" aria-hidden="true"></div>
ย <div id="celebration-announcer" aria-live="polite" role="status"></div>

ย <div id="today-overlay" role="status" aria-live="polite">
ย ย <div id="today-overlay-text">๐ Hoje: 0 aniversariantes</div>
ย ย <button id="today-overlay-play" style="background:#fff;color:#003366;padding:6px 10px;border-radius:8px;border:none">Tocar de novo</button>
ย </div>

ย <div id="undo-snackbar" role="status" aria-live="polite">
ย ย <span id="undo-snackbar-text"></span>
ย ย <button id="undo-snackbar-btn" style="margin-left:12px;background:#fff;color:#111;padding:6px 10px;border-radius:6px;border:none">Desfazer</button>
ย </div>

ย <div class="container">
ย ย <header>
ย ย ย <div class="title-group">
ย ย ย ย <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.975M15 10a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
ย ย ย ย <div>
ย ย ย ย ย <h1>Painel de Aniversariantes</h1>
ย ย ย ย ย <p style="margin:0;color:var(--muted);font-size:13px">Celebre com a nossa equipe.</p>
ย ย ย ย </div>
ย ย ย </div>
ย ย ย 
ย ย ย ย ย ย <div class="header-actions">
ย ย ย ย <button id="theme-toggle-btn" title="Alternar tema">๐</button>

ย ย ย ย <button id="celebrate-now-btn" title="Celebrar agora">๐ Celebrar</button>

ย ย ย ย ย ย ย ย <label style="display:inline-flex;align-items:center;gap:6px">
ย ย ย ย ย <input type="checkbox" id="auto-celebrate-toggle" title="Ativa celebraรงรฃo automรกtica no carregamento">
ย ย ย ย ย <span style="font-size:13px;color:var(--muted)">Auto Celebrar</span>
ย ย ย ย </label>

ย ย ย ย ย ย ย ย <button id="sound-toggle-btn" title="Ativar / desativar som">๐</button>

ย ย ย ย <button id="auth-btn" class="tertiary text-sm">๐ Acesso Restrito</button>
ย ย ย </div>
ย ย ย ย ย </header>

ย ย <div id="tabs-container">
ย ย ย <button data-tab="today" class="tab-btn">๐ Hoje</button>
ย ย ย <button data-tab="upcoming" class="tab-btn">๐ Prรณximos</button>
ย ย ย <button data-tab="calendar" class="tab-btn">๐๏ธ Calendรกrio</button>
ย ย ย <button data-tab="list" class="tab-btn">๐ Lista Completa</button>
ย ย ย <button data-tab="chart" class="tab-btn admin-only">๐ Gestรฃo</button>
ย ย ย <div id="active-tab-underline" aria-hidden="true"></div>
ย ย </div>

ย ย ย ย <main id="tab-panels-container">
ย ย ย <div id="loading-indicator" role="status" aria-live="polite">
ย ย ย ย <svg class="animate-spin" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H8v-2h3V6l4 4-4 4z"></path></svg>
ย ย ย ย Carregando dados...
ย ย ย </div>

ย ย ย <div id="content-wrapper" class="hidden" aria-hidden="true">
ย ย ย ย <div id="today-panel" class="tab-panel"></div>
ย ย ย ย <div id="upcoming-panel" class="tab-panel hidden"></div>

ย ย ย ย <div id="calendar-panel" class="tab-panel hidden">
ย ย ย ย ย <div class="bg-card p-4 rounded-lg">
ย ย ย ย ย ย <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
ย ย ย ย ย ย ย <h2 style="margin:0;font-size:18px">Calendรกrio Heatmap</h2>
ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย <label style="margin-right:8px;font-size:13px;color:var(--muted)"><input type="checkbox" id="week-start-monday"> Iniciar a semana na 2ยช</label>
ย ย ย ย ย ย ย ย <button id="prev-month-btn" style="margin-right:6px">โ</button>
ย ย ย ย ย ย ย ย <span id="calendar-month-year" aria-live="polite"></span>
ย ย ย ย ย ย ย ย <button id="next-month-btn" style="margin-left:6px">โถ</button>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <div id="list-panel" class="tab-panel hidden">
ย ย ย ย ย <div class="bg-card p-4 rounded-lg">
ย ย ย ย ย ย <div style="display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px">
ย ย ย ย ย ย ย <h2 style="margin:0;font-size:18px">Lista Completa</h2>
ย ย ย ย ย ย ย <div class="admin-only" style="display:flex;gap:8px;align-items:center">
ย ย ย ย ย ย ย ย <button id="import-csv-btn" style="background:var(--eletro-teal);color:#fff;padding:8px 12px;border-radius:8px">Importar CSV</button>
ย ย ย ย ย ย ย ย <button id="export-csv-btn" style="background:var(--eletro-teal);color:#fff;padding:8px 12px;border-radius:8px">Exportar CSV</button>
ย ย ย ย ย ย ย ย <button id="add-person-btn" style="background:var(--eletro-blue);color:#fff;padding:8px 12px;border-radius:8px">+ Adicionar</button>
ย ย ย ย ย ย ย ย <input type="file" id="csv-file-input" class="hidden" accept=".csv,text/csv">
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
ย ย ย ย ย ย ย <input type="search" id="search-input" placeholder="Buscar por nome ou setor..." class="search-input" aria-label="Buscar por nome ou setor" style="flex:1">
ย ย ย ย ย ย ย <select id="filter-month" aria-label="Filtrar por mรชs" style="padding:8px;border-radius:8px;border:1px solid var(--soft-border)">
ย ย ย ย ย ย ย ย <option value="">Todos os meses</option>
ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div style="overflow:auto">
ย ย ย ย ย ย ย <table>
ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย <th data-sort="name">Nome <span></span></th>
ย ย ย ย ย ย ย ย ย ย <th data-sort="sector">Setor <span></span></th>
ย ย ย ย ย ย ย ย ย ย <th data-sort="date">Data <span></span></th>
ย ย ย ย ย ย ย ย ย ย <th data-sort="age">Idade <span></span></th>
ย ย ย ย ย ย ย ย ย ย <th class="admin-only-table-cell" data-sort="none">Aรงรตes</th>
ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย <tbody id="birthday-table-body" aria-live="polite"></tbody>
ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย <div id="no-results" class="hidden" style="padding:18px;color:var(--muted)">Nenhum resultado encontrado.</div>
ย ย ย ย ย ย </div>

ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <div id="chart-panel" class="tab-panel hidden admin-only">
ย ย ย ย ย <div class="bg-card p-6 rounded-lg">
ย ย ย ย ย ย <h2 style="margin:0 0 18px 0;font-size:20px;font-weight:600">Anรกlises de Dados</h2>
ย ย ย ย ย ย <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
ย ย ย ย ย ย ย <div style="min-height:260px;padding:8px"><canvas id="birthday-chart"></canvas></div>
ย ย ย ย ย ย ย <div style="min-height:260px;padding:8px"><canvas id="sector-chart"></canvas></div>
ย ย ย ย ย ย </div>
ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย </div>
ย ย </main>
ย ย ย </div>

ย <div id="notification-toast" role="status" aria-live="polite"></div>

ย ย <div id="add-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
ย ย <div class="bg-card rounded-xl p-6 w-full max-w-md">
ย ย ย <h2 class="text-xl font-semibold mb-4" id="modal-title">Adicionar Aniversariante</h2>
ย ย ย <input id="input-nome" class="w-full border p-2 rounded mb-3" placeholder="Nome" />
ย ย ย <input id="input-dia" type="number" min="1" max="31" class="w-full border p-2 rounded mb-3" placeholder="Dia" />
ย ย ย <input id="input-mes" type="number" min="1" max="12" class="w-full border p-2 rounded mb-3" placeholder="Mรชs" />
ย ย ย <input id="input-ano" type="number" min="1900" max="2100" class="w-full border p-2 rounded mb-3" placeholder="Ano (opcional)" />
ย ย ย <input id="input-setor" class="w-full border p-2 rounded mb-4" placeholder="Setor" />
ย ย ย <div class="flex justify-end gap-3">
ย ย ย ย <button id="cancel-btn" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
ย ย ย ย <button id="save-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button>
ย ย ย </div>
ย ย </div>
ย </div>
ย ย ย <script type="module">
ย ย import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
ย ย import {
ย ย ย getAuth,
ย ย ย onAuthStateChanged,
ย ย ย GoogleAuthProvider,
ย ย ย signInWithPopup,
ย ย ย signInWithRedirect, // (V2) Adicionado
ย ย ย getRedirectResult, ย// (V2) Adicionado
ย ย ย signOut
ย ย } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
ย ย import {
ย ย ย getFirestore,
ย ย ย collection,
ย ย ย getDocs,
ย ย ย addDoc,
ย ย ย updateDoc,
ย ย ย deleteDoc,
ย ย ย doc,
ย ย ย onSnapshot,
ย ย ย serverTimestamp,
ย ย ย setDoc
ย ย } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

ย ย document.addEventListener('DOMContentLoaded', () => {
ย ย ย /* ---------------- DOM refs (V1 + V2) ---------------- */
ย ย ย const authBtn = document.getElementById('auth-btn');
ย ย ย const tabsContainer = document.getElementById('tabs-container');
ย ย ย const activeTabUnderline = document.getElementById('active-tab-underline');
ย ย ย const todayPanel = document.getElementById('today-panel');
ย ย ย const upcomingPanel = document.getElementById('upcoming-panel');
ย ย ย const calendarGrid = document.getElementById('calendar-grid');
ย ย ย const calendarMonthYear = document.getElementById('calendar-month-year');
ย ย ย const prevMonthBtn = document.getElementById('prev-month-btn');
ย ย ย const nextMonthBtn = document.getElementById('next-month-btn');
ย ย ย const tableBody = document.getElementById('birthday-table-body');
ย ย ย const searchInput = document.getElementById('search-input');
ย ย ย const noResults = document.getElementById('no-results');
ย ย ย const notificationToast = document.getElementById('notification-toast');
ย ย ย const themeToggleBtn = document.getElementById('theme-toggle-btn');
ย ย ย const confettiCanvas = document.getElementById('confetti-canvas');
ย ย ย const celebrationContainer = document.getElementById('fullscreen-celebration');
ย ย ย const calendarTooltip = document.getElementById('calendar-tooltip');
ย ย ย const loadingIndicator = document.getElementById('loading-indicator');
ย ย ย const contentWrapper = document.getElementById('content-wrapper');
ย ย ย const celebrateNowBtn = document.getElementById('celebrate-now-btn');
ย ย ย const soundToggleBtn = document.getElementById('sound-toggle-btn');
ย ย ย const addPersonBtn = document.getElementById('add-person-btn');
ย ย ย const tableHeader = document.querySelector('#list-panel thead');
ย ย ย const importCsvBtn = document.getElementById('import-csv-btn');
ย ย ย const exportCsvBtn = document.getElementById('export-csv-btn');
ย ย ย const csvFileInput = document.getElementById('csv-file-input');
ย ย ย const filterMonth = document.getElementById('filter-month');
ย ย ย const weekStartMondayCheckbox = document.getElementById('week-start-monday');

ย ย ย const modal = document.getElementById('add-modal');
ย ย ย const inputNome = document.getElementById('input-nome');
ย ย ย const inputDia = document.getElementById('input-dia');
ย ย ย const inputMes = document.getElementById('input-mes');
ย ย ย const inputAno = document.getElementById('input-ano');
ย ย ย const inputSetor = document.getElementById('input-setor');
ย ย ย const cancelBtn = document.getElementById('cancel-btn');
ย ย ย const saveBtn = document.getElementById('save-btn');
ย ย ย const modalTitle = document.getElementById('modal-title');

ย ย ย const todayOverlay = document.getElementById('today-overlay');
ย ย ย const todayOverlayText = document.getElementById('today-overlay-text');
ย ย ย const todayOverlayPlay = document.getElementById('today-overlay-play');

ย ย ย const undoSnackbar = document.getElementById('undo-snackbar');
ย ย ย const undoSnackbarText = document.getElementById('undo-snackbar-text');
ย ย ย const undoSnackbarBtn = document.getElementById('undo-snackbar-btn');

ย ย ย const announcer = document.getElementById('celebration-announcer');
ย ย ย const autoCelebrateToggle = document.getElementById('auto-celebrate-toggle'); // (V2) Adicionado

ย ย ย /* ---------------- Globals (V1 + V2) ---------------- */
ย ย ย const APP_BUILD = '2025-10-21-v2'; // (V2) Atualizado
ย ย ย const monthNames = ["Janeiro","Fevereiro","Marรงo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
ย ย ย const avatarColors = ['#003366','#009a74','#f0b400','#dc2626','#3b82f6','#f43f5e','#a855f7'];
ย ย ย let db = null, auth = null, dbCollection = null, dataUnsub = null;
ย ย ย window.birthdayData = [];ย // exposto para debug
ย ย ย let currentDate = new Date();
ย ย ย let isAdmin = false;
ย ย ย let sortConfig = { key: 'date', direction: 'ascending' };
ย ย ย let lastDeleted = null; // para desfazer

ย ย ย // (V2) Celebration config atualizada
ย ย ย const CELEBRATION_CONFIG = {
ย ย ย ย maxBalloons: 30,
ย ย ย ย balloonPerPerson: 3,
ย ย ย ย baseParticles: 60,
ย ย ย ย maxIntensity: 8,
ย ย ย ย mobileMaxIntensity: 2
ย ย ย };
ย ย ย const celebrationKey = 'celebration_shown_date';
ย ย ย const forceAutoKey = 'celebration_force_auto'; // (V2) Adicionado
ย ย ย const metricsKey = 'celebration_metrics_count';
ย ย ย const soundEnableKey = 'celebration_sound_enabled'; // (V2) Atualizado (era soundEnabledKey)
ย ย ย const appBuildKey = 'app_build_version';

ย ย ย /* feature flags / environment */
ย ย ย const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
ย ย ย const isMobile = /Mobi|Android/i.test(navigator.userAgent);
ย ย ย const confettiCannon = (!prefersReduced && window.confetti) ? confetti.create(confettiCanvas, { resize: true }) : null;

ย ย ย /* APP_BUILD migration: possibilita celebrar na primeira carga da versรฃo nova */
ย ย ย try {
ย ย ย ย const prevBuild = localStorage.getItem(appBuildKey);
ย ย ย ย if (prevBuild !== APP_BUILD) {
ย ย ย ย ย localStorage.removeItem(celebrationKey);
ย ย ย ย ย localStorage.setItem(appBuildKey, APP_BUILD);
ย ย ย ย }
ย ย ย } catch(e){}

ย ย ย /* ---- Helpers (V1) ---- */
ย ย ย const safeFinallyShowUI = () => {
ย ย ย ย try {
ย ย ย ย ย loadingIndicator.classList.add('hidden');
ย ย ย ย ย contentWrapper.classList.remove('hidden');
ย ย ย ย ย contentWrapper.setAttribute('aria-hidden','false');
ย ย ย ย } catch(e) { console.warn('Erro mostrar UI', e); }
ย ย ย };

ย ย ย const showNotification = (msg, isError=false, actions=[]) => {
ย ย ย ย notificationToast.innerHTML = '';
ย ย ย ย notificationToast.style.background = isError ? '#dc2626' : 'linear-gradient(90deg,#003366,#009a74)';
ย ย ย ย notificationToast.style.opacity = '1';
ย ย ย ย notificationToast.style.transform = 'translateY(0)';
ย ย ย ย const msgNode = document.createElement('div');
ย ย ย ย msgNode.style.display = 'inline-block';
ย ย ย ย msgNode.style.marginRight = '8px';
ย ย ย ย msgNode.textContent = msg;
ย ย ย ย notificationToast.appendChild(msgNode);
ย ย ย ย actions.forEach(a => {
ย ย ย ย ย const btn = document.createElement('button');
ย ย ย ย ย btn.textContent = a.label;
ย ย ย ย ย btn.addEventListener('click', a.handler);
ย ย ย ย ย notificationToast.appendChild(btn);
ย ย ย ย });
ย ย ย ย setTimeout(() => {
ย ย ย ย ย notificationToast.style.opacity = '0';
ย ย ย ย ย notificationToast.style.transform = 'translateY(10px)';
ย ย ย ย }, 6000);
ย ย ย };

ย ย ย const getInitials = (name='') => {
ย ย ย ย if (!name) return '';
ย ย ย ย const parts = name.trim().split(/\s+/).slice(0,2);
ย ย ย ย return parts.map(p => p[0]?.toUpperCase() || '').join('');
ย ย ย };
ย ย ย const getColorForName = (name='') => {
ย ย ย ย const sum = (name || '').split('').reduce((s, c) => s + c.charCodeAt(0), 0);
ย ย ย ย return avatarColors[sum % avatarColors.length];
ย ย ย };
ย ย ย const createAvatar = (name='') => {
ย ย ย ย const wrapper = document.createElement('div');
ย ย ย ย wrapper.className = 'avatar';
ย ย ย ย wrapper.style.background = getColorForName(name);
ย ย ย ย wrapper.textContent = getInitials(name);
ย ย ย ย return wrapper;
ย ย ย };

ย ย ย const announce = (text) => {
ย ย ย ย try {
ย ย ย ย ย announcer.textContent = text;
ย ย ย ย ย console.info('announce:', text);
ย ย ย ย } catch(e) {}
ย ย ย };

ย ย ย /* ---- (V2) Audio: setup com gesture fallback ---- */
ย ย ย let audioContext = null;
ย ย ย let audioAllowed = (localStorage.getItem(soundEnableKey) !== 'false');
ย ย ย const setSoundEnabled = (v) => {
ย ย ย ย audioAllowed = !!v;
ย ย ย ย try { localStorage.setItem(soundEnableKey, v ? 'true' : 'false'); } catch(e){}
ย ย ย ย soundToggleBtn.textContent = v ? '๐' : '๐';
ย ย ย ย soundToggleBtn.setAttribute('aria-pressed', String(!!v));
ย ย ย };
ย ย ย setSoundEnabled(audioAllowed);

ย ย ย // create/resume audio context on user gesture
ย ย ย const ensureAudioContext = async () => {
ย ย ย ย try {
ย ย ย ย ย if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
ย ย ย ย ย if (audioContext.state === 'suspended') await audioContext.resume();
ย ย ย ย ย return audioContext;
ย ย ย ย } catch(e) { console.warn('AudioContext failed', e); return null; }
ย ย ย };
ย ย ย const playCelebrateSound = async () => {
ย ย ย ย if (!audioAllowed) return;
ย ย ย ย try {
ย ย ย ย ย const ctx = await ensureAudioContext();
ย ย ย ย ย if (!ctx) return;
ย ย ย ย ย const now = ctx.currentTime;
ย ย ย ย ย const notes = [660, 880, 1100]; // richer chime
ย ย ย ย ย notes.forEach((freq, i) => {
ย ย ย ย ย ย const o = ctx.createOscillator();
ย ย ย ย ย ย const g = ctx.createGain();
ย ย ย ย ย ย o.type = 'sine';
ย ย ย ย ย ย o.frequency.value = freq;
ย ย ย ย ย ย g.gain.value = 0.0001;
ย ย ย ย ย ย o.connect(g); g.connect(ctx.destination);
ย ย ย ย ย ย o.start(now + i*0.06);
ย ย ย ย ย ย g.gain.linearRampToValueAtTime(0.12, now + i*0.06 + 0.02);
ย ย ย ย ย ย g.gain.linearRampToValueAtTime(0.0001, now + i*0.06 + 0.14);
ย ย ย ย ย ย o.stop(now + i*0.06 + 0.16);
ย ย ย ย ย });
ย ย ย ย } catch(e){ console.warn('playCelebrateSound fail', e); }
ย ย ย };
ย ย ย // allow user gesture to resume audio if blocked
ย ย ย const resumeAudioOnGesture = () => {
ย ย ย ย const onFirstGesture = async () => {
ย ย ย ย ย try { await ensureAudioContext(); } catch(e){}
ย ย ย ย ย window.removeEventListener('click', onFirstGesture, true);
ย ย ย ย ย window.removeEventListener('keydown', onFirstGesture, true);
ย ย ย ย };
ย ย ย ย window.addEventListener('click', onFirstGesture, true);
ย ย ย ย window.addEventListener('keydown', onFirstGesture, true);
ย ย ย };
ย ย ย resumeAudioOnGesture(); // (V2)

ย ย ย /* ---- (V2) Balloons (lots) ---- */
ย ย ย const createBalloons = (count = 25) => {
ย ย ย ย if (prefersReduced && !autoCelebrateToggle.checked) return; // (V2) respeita reduced a menos que forรงado
ย ย ย ย // clamp to config
ย ย ย ย const clamped = Math.min(CELEBRATION_CONFIG.maxBalloons, Math.max(1, count));
ย ย ย ย // remove existing
ย ย ย ย document.querySelectorAll('.balloon').forEach(b => b.remove());
ย ย ย ย for (let i=0;i<clamped;i++){
ย ย ย ย ย const b = document.createElement('div');
ย ย ย ย ย b.className = 'balloon';
ย ย ย ย ย const w = 40 + Math.round(Math.random()*80); // size 40..120
ย ย ย ย ย b.style.width = `${w}px`;
ย ย ย ย ย b.style.height = `${Math.round(w*1.25)}px`;
ย ย ย ย ย b.style.left = `${3 + Math.random()*94}%`;
ย ย ย ย ย b.style.background = avatarColors[i % avatarColors.length];
ย ย ย ย ย b.style.setProperty('--rise-duration', `${8 + Math.random()*6}s`);
ย ย ย ย ย // string
ย ย ย ย ย const s = document.createElement('div');
ย ย ย ย ย s.className = 'string';
ย ย ย ย ย b.appendChild(s);
ย ย ย ย ย celebrationContainer.appendChild(b);
ย ย ย ย ย // cleanup after animation
ย ย ย ย ย setTimeout(()=>{ try{ b.remove(); }catch(e){} }, 14000);
ย ย ย ย }
ย ย ย };

ย ย ย /* ---- (V2) Confetti improved: side bursts + central multi-bursts ---- */
ย ย ย const pickColors = (n=6) => {
ย ย ย ย const out=[];
ย ย ย ย for (let i=0;i<n;i++) out.push(avatarColors[i % avatarColors.length]);
ย ย ย ย return out;
ย ย ย };
ย ย ย const performConfetti = (intensity=3) => {
ย ย ย ย const cannon = confettiCannon || (typeof confetti === 'function' ? confetti : null);
ย ย ย ย if (!cannon) { console.warn('No confetti lib available'); return; }
ย ย ย ย const colors = pickColors(8);
ย ย ย ย const base = CELEBRATION_CONFIG.baseParticles;
ย ย ย ย const bursts = Math.max(2, Math.min(8, Math.floor(intensity)));
ย ย ย ย // lateral bursts (left and right)
ย ย ย ย for (let side of [0.08, 0.92]) {
ย ย ย ย ย setTimeout(()=> {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย cannon({
ย ย ย ย ย ย ย ย particleCount: Math.round(base * intensity * 0.7),
ย ย ย ย ย ย ย ย spread: 120,
ย ย ย ย ย ย ย ย startVelocity: 30 + Math.random()*60,
ย ย ย ย ย ย ย ย origin: { x: side, y: 0.6 + Math.random()*0.15 },
ย ย ย ย ย ย ย ย colors
ย ย ย ย ย ย ย });
ย ย ย ย ย ย } catch(e){ console.warn('confetti side error', e); }
ย ย ย ย ย }, 0);
ย ย ย ย }
ย ย ย ย // central bursts, multiple small bursts
ย ย ย ย for (let i=0;i<bursts;i++){
ย ย ย ย ย setTimeout(()=> {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย cannon({
ย ย ย ย ย ย ย ย particleCount: Math.round(base * intensity / bursts),
ย ย ย ย ย ย ย ย spread: 40 + Math.random()*120,
ย ย ย ย ย ย ย ย startVelocity: 20 + Math.random()*60,
ย ย ย ย ย ย ย ย origin: { x: 0.5, y: 0.35 + Math.random()*0.25 },
ย ย ย ย ย ย ย ย colors
ย ย ย ย ย ย ย });
ย ย ย ย ย ย } catch(e){ console.warn('confetti central error', e); }
ย ย ย ย ย }, i * 180);
ย ย ย ย }
ย ย ย };

ย ย ย const recordCelebrationMetric = () => { // (V2) Renomeado
ย ย ย ย try {
ย ย ย ย ย const cur = Number(localStorage.getItem(metricsKey) || 0);
ย ย ย ย ย localStorage.setItem(metricsKey, String(cur + 1));
ย ย ย ย ย console.info('Celebration metrics count ->', cur + 1);
ย ย ย ย } catch(e) {}
ย ย ย };

ย ย ย // (V2) triggerCelebration: respects prefersReduced unless force true OR auto toggle enabled by user
ย ย ย const triggerCelebration = async (count = 1, options = {}) => {
ย ย ย ย console.info('triggerCelebration', {count,options});
ย ย ย ย try {
ย ย ย ย ย const reduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
ย ย ย ย ย const forceAuto = localStorage.getItem(forceAutoKey) === 'true';

ย ย ย ย ย if (reduced && !options.force && !forceAuto && !options.userInitiated) {
ย ย ย ย ย ย console.info('Celebration aborted due to prefers-reduced-motion (use force true or enable Auto Celebrar).');
ย ย ย ย ย ย return;
ย ย ย ย ย }
ย ย ย ย ย // don't double-run more than once per day unless forced
ย ย ย ย ย const today = new Date().toISOString().slice(0,10);
ย ย ย ย ย try {
ย ย ย ย ย ย if (localStorage.getItem(celebrationKey) === today && !options.force) {
ย ย ย ย ย ย ย console.info('Already celebrated today; abort');
ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย } catch(e){}

ย ย ย ย ย // create balloons (large amount)
ย ย ย ย ย try { createBalloons(Math.max(20, Math.round(count * CELEBRATION_CONFIG.balloonPerPerson))); } catch(e){ console.warn(e); }
ย ย ย ย ย 
ย ย ย ย ย // confetti
ย ย ย ย ย try {
ย ย ย ย ย ย const intensity = Math.min(CELEBRATION_CONFIG.maxIntensity, Math.max(1, count));
ย ย ย ย ย ย const finalIntensity = isMobile ? Math.min(intensity, CELEBRATION_CONFIG.mobileMaxIntensity) : intensity;
ย ย ย ย ย ย performConfetti(finalIntensity);
ย ย ย ย ย } catch(e){ console.warn('confetti error', e); }
ย ย ย ย ย 
ย ย ย ย ย // sound (attempt)
ย ย ย ย ย try { await playCelebrateSound(); } catch(e){ console.warn('sound error', e); }
ย ย ย ย ย 
ย ย ย ย ย // mark as shown (unless notPersist)
ย ย ย ย ย if (!options.notPersist) {
ย ย ย ย ย ย try { localStorage.setItem(celebrationKey, new Date().toISOString().slice(0,10)); } catch(e){}
ย ย ย ย ย }
ย ย ย ย ย recordCelebrationMetric();
ย ย ย ย ย try { announcer.textContent = `Hoje ${count} aniversariante${count>1?'s':''}. Parabรฉns!`; } catch(e){}
ย ย ย ย } catch(e){ console.error('triggerCelebration erro', e); }
ย ย ย };

ย ย ย /* ---- Firestore init / mapping (V1) ---- */
ย ย ย const mapFirebaseDoc = (docSnap) => {
ย ย ย ย const raw = docSnap?.data ? docSnap.data() : (docSnap || {});
ย ย ย ย const id = docSnap?.id || raw.id || ('local_' + Date.now());
ย ย ย ย const name = raw.nome ?? raw.name ?? '';
ย ย ย ย const sector = raw.setor ?? raw.sector ?? '';
ย ย ย ย const day = Number(raw.dia ?? raw.day) || 0;
ย   ย ย const month = Number(raw.mes ?? raw.month) || 0;
ย ย ย ย const year = raw.ano ?? raw.year ?? raw.yearOfBirth ?? null;
ย ย ย ย const textoData = raw.textoData ?? `${day} de ${monthNames[month-1] || ''}`;
ย ย ย ย return { id, name: String(name).trim(), sector: String(sector).trim(), day, month, year: year ? Number(year) : null, textoData };
ย ย ย };

ย ย ย /* ---- (V2) Firebase Auth: init, redirect handler, state change ---- */
ย ย ย const initFirebaseAuth = async () => {
ย ย ย ย try {
ย ย ย ย ย const cfg = window.__firebase_config || window.firebaseConfig || null;
ย ย ย ย ย if (!cfg) {
ย ย ย ย ย ย console.warn('Firebase config not found; running in demo mode');
ย ย ย ย ย ย dbCollection = null;
ย ย ย ย ย ย return; // (V2) Retorna aqui se nรฃo houver config
ย ย ย ย ย }
ย ย ย ย ย const app = initializeApp(cfg);
ย ย ย ย ย auth = getAuth(app);
ย ย ย ย ย db = getFirestore(app);
ย ย ย ย ย dbCollection = collection(db, 'aniversariantes');
ย ย ย ย ย console.info('Firebase inicializado.');

ย ย ย ย ย // (V2) Handle redirect result (em caso de fallback)
ย ย ย ย ย try {
ย ย ย ย ย ย const result = await getRedirectResult(auth);
ย ย ย ย ย ย if (result && result.user) {
ย ย ย ย ย ย ย console.info('getRedirectResult success', result.user);
ย ย ย ย ย ย ย showNotification('Login via redirecionamento bem-sucedido.');
ย ย ย ย ย ย }
ย ย ย ย ย } catch(err) {
ย ย ย ย ย ย console.warn('getRedirectResult err (normal se nรฃo houve redirect):', err.code, err.message);
ย ย ย ย ย }
ย ย ย ย ย 
ย ย ย ย ย // (V2) Auth state change
ย ย ย ย ย onAuthStateChanged(auth, (user) => {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย if (user) {
ย ย ย ย ย ย ย ย // TODO: Implementar Custom Claims para isAdmin
ย ย ย ย ย ย ย ย // getIdTokenResult(user).then(t => console.log('claims', t.claims));
ย ย ย ย ย ย ย ย isAdmin = true; // (V1) Temporรกrio
ย ย ย ย ย ย ย ย document.body.classList.add('admin-mode');
ย ย ย ย ย ย ย ย authBtn.textContent = '๐ Sair';
ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย isAdmin = false;
ย ย ย ย ย ย ย ย document.body.classList.remove('admin-mode');
ย ย ย ย ย ย ย ย authBtn.textContent = '๐ Acesso Restrito';
ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch(e){ console.warn('onAuthStateChanged error', e); }
ย ย ย ย ย });
ย ย ย ย 
ย ย ย ย } catch(e) {
ย ย ย ย ย console.error('Erro initFirebaseAuth', e);
ย ย ย ย ย dbCollection = null;
ย ย ย ย }
ย ย ย };

ย ย ย const fetchAndRenderData = async () => {
ย ย ย ย try {
ย ย ย ย ย if (dbCollection) {
ย ย ย ย ย ย const snap = await getDocs(dbCollection);
ย ย ย ย ย ย window.birthdayData = snap.docs.map(mapFirebaseDoc);
ย ย ย ย ย } else {
ย ย ย ย ย ย window.birthdayData = sampleData();
ย ย ย ย ย }
ย ย ย ย } catch(e) {
ย ย ย ย ย console.error('Erro fetchAndRenderData', e);
ย ย ย ย ย window.birthdayData = sampleData();
ย ย ย ย } finally {
ย ย ย ย ย renderAll();
ย ย ย ย ย safeFinallyShowUI();
ย ย ย ย ย attachRealtime();

ย ย ย ย ย // (V2) Auto-celebrate na carga se o toggle estiver ativo
ย ย ย ย ย try {
ย ย ย ย ย ย const auto = localStorage.getItem(forceAutoKey) === 'true';
ย ย ย ย ย ย if (auto) {
ย ย ย ย ย ย ย const now = new Date();
ย ย ย ย ย ย ย const todays = (window.birthdayData || []).filter(p => p.day === now.getDate() && p.month === (now.getMonth()+1));
ย ย ย ย ย ย ย const count = todays.length;
ย ย ย ย ย ย ย if (count > 0) {
ย ย ย ย ย ย ย ย setTimeout(()=> {
ย ย ย ย ย ย ย ย ย // Chama com force:true para ignorar 'prefers-reduced-motion' (aรงรฃo do usuรกrio via toggle)
ย ย ย ย ย ย ย ย ย triggerCelebration(count, { force: true, userInitiated: false });
ย ย ย ย ย ย ย ย }, 600); // delay para UI renderizar
ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย } catch(e){ console.warn('auto-celebrate failed', e); }
ย ย ย ย }
ย ย ย };

ย ย ย const attachRealtime = () => {
ย ย ย ย if (!dbCollection) return;
ย ย ย ย if (dataUnsub) dataUnsub();
ย ย ย ย dataUnsub = onSnapshot(dbCollection, snap => {
ย ย ย ย ย window.birthdayData = snap.docs.map(mapFirebaseDoc);
ย ย ย ย ย renderAll();
ย ย ย ย }, err => {
ย ย ย ย ย console.warn('onSnapshot erro', err);
ย ย ย ย });
ย ย ย };

ย ย ย const sampleData = () => [
ย ย ย ย { id:'s1', name:'Ana Silva', sector:'Engenharia', day:currentDate.getDate(), month:currentDate.getMonth()+1, year: null },
ย ย ย ย { id:'s2', name:'Bruno Costa', sector:'Comercial', day:((currentDate.getDate()+3)%28)+1, month:currentDate.getMonth()+1, year: 1988 },
ย ย ย ย { id:'s3', name:'Carla Nunes', sector:'RH', day:((currentDate.getDate()+10)%28)+1, month:currentDate.getMonth()+1, year: 1992 }
ย ย ย ];

ย ย ย /* ---- RENDER functions (V1) ---- */
ย ย ย const updateMonthFilterOptions = () => {
ย ย ย ย const monthsSet = new Set();
ย ย ย ย window.birthdayData.forEach(b => { if (b.month) monthsSet.add(b.month); });
ย ย ย ย const monthsArr = Array.from(monthsSet).sort((a,b) => a-b);
ย ย ย ย while(filterMonth.options.length > 1) filterMonth.remove(1);
ย ย ย ย monthsArr.forEach(m => {
ย ย ย ย ย const opt = document.createElement('option');
ย ย ย ย ย opt.value = String(m);
ย ย ย ย ย opt.textContent = monthNames[m-1];
ย ย ย ย ย filterMonth.appendChild(opt);
ย ย ย ย });
ย ย ย };

ย ย ย const renderAll = (searchTerm = '') => {
ย ย ย ย window.birthdayData.sort((a,b) => {
ย ย ย ย ย const dir = sortConfig.direction === 'ascending' ? 1 : -1;
ย ย ย ย ย const valA = (sortConfig.key === 'date') ? ((a.month||0)*100 + (a.day||0)) : (a[sortConfig.key] || '');
ย ย ย ย ย const valB = (sortConfig.key === 'date') ? ((b.month||0)*100 + (b.day||0)) : (b[sortConfig.key] || '');
ย ย ย ย ย if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
ย ย ย ย ย if (valA === valB) return (a.name || '').localeCompare(b.name || '') * dir;
ย ย ย ย ย return (valA - valB) * dir;
ย ย ย ย });
ย ย ย ย updateMonthFilterOptions();
ย ย ย ย renderToday();
ย ย ย ย renderUpcoming();
ย ย ย ย renderTable(searchTerm);
ย ย ย ย renderCalendar();
ย ย ย ย renderCharts();
ย ย ย };

ย ย ย const renderToday = () => {
ย ย ย ย todayPanel.innerHTML = '';
ย ย ย ย const now = new Date();
ย ย ย ย const day = now.getDate(), month = now.getMonth()+1;
ย ย ย ย const todays = window.birthdayData.filter(p => p.day === day && p.month === month);
ย ย ย ย if (todays.length === 0) {
ย ย ย ย ย todayPanel.innerHTML = `<div class="bg-card p-4 text-center rounded-lg">Nenhum aniversรกrio hoje.</div>`;
ย ย ย ย ย todayOverlay.style.display = 'none';
ย ย ย ย } else {
ย ย ย ย ย const grid = document.createElement('div'); grid.id = 'today-panel-grid';
ย ย ย ย ย todays.forEach(p => {
ย ย ย ย ย ย const card = document.createElement('div'); card.className = 'birthday-card bg-card';
ย ย ย ย ย ย const avatar = createAvatar(p.name);
ย ย ย ย ย ย const info = document.createElement('div'); info.className = 'card-info';
ย ย ย ย ย ย const nameEl = document.createElement('span'); nameEl.className = 'name'; nameEl.textContent = p.name;
ย ย ย ย ย ย const sectorEl = document.createElement('span'); sectorEl.className = 'sector'; sectorEl.textContent = p.sector;
ย ย ย ย ย ย const dateEl = document.createElement('span'); dateEl.className = 'date';
ย ย ย ย ย ย dateEl.textContent = `Dia: ${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}`;
ย ย ย ย ย ย info.append(nameEl, sectorEl, dateEl);
ย ย ย ย ย ย if (p.year) {
ย ย ย ย ย ย ย const ageEl = document.createElement('div');
ย ย ย ย ย ย ย ageEl.style.fontSize = '13px';
ย ย ย ย ย ย ย ageEl.style.color = 'var(--muted)';
ย ย ย ย ย ย ย const age = new Date().getFullYear() - Number(p.year);
ย ย ย ย ย ย ย ageEl.textContent = `Idade: ${age}`;
ย ย ย ย ย ย ย info.appendChild(ageEl);
ย ย ย ย ย ย }
ย ย ย ย ย ย card.append(avatar, info);
ย ย ย ย ย ย grid.appendChild(card);
ย ย ย ย ย });
ย ย ย ย ย todayPanel.appendChild(grid);

ย ย ย ย ย // overlay
ย ย ย ย ย todayOverlayText.textContent = `๐ Hoje: ${todays.length} aniversariante${todays.length>1?'s':''}`;
ย ย ย ย ย todayOverlay.style.display = 'flex';
ย ย ย ย ย announce(`Hoje ${todays.length} aniversariante${todays.length>1?'s':''}.`);
ย ย ย ย ย 
ย ย ย ย ย // disparo automรกtico (agora movido para fetchAndRenderData.finally para respeitar toggle V2)
ย ย ย ย ย // (V2) Apenas checa se nรฃo celebrou, mas nรฃo dispara se 'auto' estiver off
ย ย ย ย ย const todayKey = new Date().toISOString().slice(0,10);
ย ย ย ย ย const already = localStorage.getItem(celebrationKey) === todayKey;
ย ย ย ย ย const autoOn = localStorage.getItem(forceAutoKey) === 'true';
ย ย ย ย ย 
ย ย ย ย ย if (!already && !prefersReduced && !autoOn) {
ย ย ย ย ย ย // (V2) Auto-executa SE: nรฃo celebrou, nรฃo prefere reduzido, E auto-celebrate toggle estรก OFF
ย ย ย ย ย ย // (Se autoOn=true, jรก disparou em fetchAndRenderData.finally)
ย ย ย ย ย ย triggerCelebration(todays.length, {});
ย ย ย ย ย } else if (autoOn) {
ย ย ย ย ย ย // jรก disparou ou vai disparar via fetchAndRenderData
ย ย ย ย ย ย console.info('Auto-celebrate (toggle) estรก ativo.');
ย ย ย ย ย } else {
ย ย ย ย ย ย console.info('Nรฃo auto-executa celebraรงรฃo (prefersReduced or already celebrated)');
ย ย ย ย ย }
ย ย ย ย }
ย ย ย };

ย ย ย const renderUpcoming = () => {
ย ย ย ย upcomingPanel.innerHTML = '';
ย ย ย ย const today = new Date();
ย ย ย ย const upcoming = [];
ย ย ย ย for (let i = 1; i <= 15; i++) {
ย ย ย ย ย const future = new Date();
ย ย ย ย ย future.setDate(today.getDate() + i);
ย ย ย ย ย const d = future.getDate(), m = future.getMonth()+1;
ย ย ย ย ย const match = window.birthdayData.filter(p => p.day === d && p.month === m);
ย ย ย ย ย if (match.length) upcoming.push(...match);
ย ย ย ย }
ย ย ย ย if (upcoming.length === 0) {
ย ย ย ย ย upcomingPanel.innerHTML = `<div class="bg-card p-4 text-center rounded-lg">Nenhum aniversรกrio nos prรณximos 15 dias.</div>`;
ย ย ย ย } else {
ย ย ย ย ย const grid = document.createElement('div'); grid.id = 'upcoming-panel-grid';
ย ย ย ย ย upcoming.forEach(p => {
ย ย ย ย ย ย const card = document.createElement('div'); card.className = 'birthday-card bg-card';
ย ย ย ย ย ย const avatar = createAvatar(p.name);
ย ย ย ย ย ย const info = document.createElement('div'); info.className = 'card-info';
ย ย ย ย ย ย const nameEl = document.createElement('span'); nameEl.className = 'name'; nameEl.textContent = p.name;
ย ย ย ย ย ย const sectorEl = document.createElement('span'); sectorEl.className = 'sector'; sectorEl.textContent = p.sector;
ย ย ย ย ย ย const dateEl = document.createElement('span'); dateEl.className = 'date'; dateEl.textContent = `Dia: ${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}`;
ย ย ย ย ย ย info.append(nameEl, sectorEl, dateEl);
ย ย ย ย ย ย card.append(avatar, info);
ย ย ย ย ย ย grid.appendChild(card);
ย ย ย ย ย });
ย ย ย ย ย upcomingPanel.appendChild(grid);
ย ย ย ย }
ย ย ย };

ย ย ย const renderTable = (searchTerm = '') => {
ย ย ย ย tableBody.innerHTML = '';
ย ย ย ย const q = (searchTerm || '').toLowerCase();
ย ย ย ย const monthFilter = filterMonth.value ? Number(filterMonth.value) : null;
ย ย ย ย const filtered = window.birthdayData.filter(p => {
ย ย ย ย ย if (q && !((p.name||'').toLowerCase().includes(q) || (p.sector||'').toLowerCase().includes(q))) return false;
ย ย ย ย ย if (monthFilter && p.month !== monthFilter) return false;
ย ย ย ย ย return true;
ย ย ย ย });
ย ย ย ย noResults.classList.toggle('hidden', filtered.length > 0);
ย ย ย ย filtered.forEach(p => {
ย ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย ย const nameCell = document.createElement('td');
ย ย ย ย ย nameCell.dataset.label = "Nome";
ย ย ย ย ย nameCell.className = 'table-avatar-cell';
ย ย ย ย ย const avatar = createAvatar(p.name);
ย ย ย ย ย const nameSpan = document.createElement('span');
ย ย ย ย ย nameSpan.textContent = p.name;
ย ย ย ย ย nameCell.append(avatar, nameSpan);

ย ย ย ย ย const sectorCell = document.createElement('td');
ย ย ย ย ย sectorCell.dataset.label = "Setor";
ย ย ย ย ย sectorCell.textContent = p.sector;

ย ย ย ย ย const dateCell = document.createElement('td');
ย ย ย ย ย dateCell.dataset.label = "Data";
ย ย ย ย ย dateCell.textContent = `${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}`;

ย ย ย ย ย const ageCell = document.createElement('td');
ย ย ย ย ย ageCell.dataset.label = "Idade";
ย ย ย ย ย ageCell.textContent = p.year ? String(new Date().getFullYear() - Number(p.year)) : '';

ย ย ย ย ย const actionsCell = document.createElement('td');
ย ย ย ย ย actionsCell.dataset.label = "Aรงรตes";
ย ย ย ย ย actionsCell.className = 'admin-only-table-cell';
ย ย ย ย ย const editBtn = document.createElement('button');
ย ย ย ย ย editBtn.textContent = 'Editar';
ย ย ย ย ย editBtn.style.marginRight = '8px';
ย ย ย ย ย editBtn.addEventListener('click', () => openEditModal(p));
ย ย ย ย ย const delBtn = document.createElement('button');
ย ย ย ย ย delBtn.textContent = 'Excluir';
ย ย ย ย ย delBtn.addEventListener('click', () => deletePerson(p.id, p.name, p));
ย ย ย ย ย actionsCell.append(editBtn, delBtn);

ย ย ย ย ย tr.append(nameCell, sectorCell, dateCell, ageCell, actionsCell);
ย ย ย ย ย tableBody.append(tr);
ย ย ย ย });
ย ย ย ย updateSortIndicators();
ย ย ย };

ย ย ย const renderCalendar = () => {
ย ย ย ย calendarGrid.innerHTML = '';
ย ย ย ย const year = currentDate.getFullYear();
ย ย ย ย const month = currentDate.getMonth();ย // 0-index
ย ย ย ย calendarMonthYear.textContent = `${monthNames[month]} ${year}`;

ย ย ย ย const firstDayRaw = new Date(year, month, 1).getDay(); // 0=Sun
ย ย ย ย const weekStartsMonday = !!(weekStartMondayCheckbox && weekStartMondayCheckbox.checked);
ย ย ย ย const firstDay = weekStartsMonday ? (firstDayRaw + 6) % 7 : firstDayRaw;
ย ย ย ย const daysInMonth = new Date(year, month+1, 0).getDate();

ย ย ย ย for (let i = 0; i < firstDay; i++) {
ย ย ย ย ย const empty = document.createElement('div');
ย ย ย ย ย empty.className = 'day-cell';
ย ย ย ย ย empty.style.opacity = '0.25';
ย ย ย ย ย calendarGrid.appendChild(empty);
ย ย ย ย }

ย ย ย ย const smallScreen = window.innerWidth < 768;

ย ย ย ย for (let d = 1; d <= daysInMonth; d++) {
ย ย ย ย ย if (smallScreen) {
ย ย ย ย ย ย const li = document.createElement('div');
ย ย ย ย ย ย li.className = 'day-cell bg-card p-2 rounded-lg';
ย ย ย ย ย ย const items = window.birthdayData.filter(b => b.day === d && b.month === (month+1));
ย ย ย ย ย ย const count = items.length;
ย ย ย ย ย ย const header = document.createElement('div');
ย ย ย ย ย ย header.className = 'day-num';
ย ย ย ย ย ย header.textContent = `${d} ${monthNames[month]}`;
ย ย ย ย ย ย li.appendChild(header);
ย ย ย ย ย ย if (count > 0) {
ย ย ย ย ย ย ย const ul = document.createElement('ul');
ย ย ย ย ย ย ย items.forEach(it => {
ย ย ย ย ย ย ย ย const li2 = document.createElement('li');
ย ย ย ย ย ย ย ย li2.textContent = `${it.name} โ ${it.sector}`;
ย ย ย ย ย ย ย ย ul.appendChild(li2);
ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย li.appendChild(ul);
ย ย ย ย ย ย }
ย ย ย ย ย ย calendarGrid.appendChild(li);
ย ย ย ย ย ย continue;
ย ย ย ย ย }

ย ย ย ย ย const cell = document.createElement('div');
ย ย ย ย ย cell.className = 'day-cell bg-card p-2 rounded-lg';
ย ย ย ย ย const items = window.birthdayData.filter(b => b.day === d && b.month === (month+1));
ย ย ย ย ย const count = items.length;

ย ย ย ย ย const dayNum = document.createElement('div');
ย ย ย ย ย dayNum.className = 'day-num';
ย ย ย ย ย dayNum.textContent = d;
ย ย ย ย ย cell.append(dayNum);

ย ย ย ย ย if (count > 0) {
ย ย ย ย ย ย const capped = Math.min(3, count);
ย ย ย ย ย ย cell.dataset.count = String(capped);
ย ย ย ย ย ย const badge = document.createElement('div');
ย ย ย ย ย ย badge.className = 'birthday-badge';
ย ย ย ย ย ย badge.textContent = count > 1 ? `${count} anivers.` : '1 anivers.';
ย ย ย ย ย ย cell.append(badge);
ย ย ย ย ย ย cell.title = `${count} aniversariante(s)`;
ย ย ย ย ย }

ย ย ย ย ย cell.addEventListener('mouseenter', ev => {
ย ย ย ย ย ย if (!items.length) return;
ย ย ย ย ย ย calendarTooltip.style.display = 'block';
ย ย ย ย ย ย calendarTooltip.innerHTML = '';
ย ย ย ย ย ย const strong = document.createElement('strong');
ย ย ย ย ย ย strong.textContent = `${d} ${monthNames[month]}`;
ย ย ย ย ย ย calendarTooltip.append(strong);
ย ย ย ย ย ย const ul = document.createElement('ul');
ย ย ย ย ย ย items.forEach(it => {
ย ย ย ย ย ย ย const li = document.createElement('li');
ย ย ย ย ย ย ย const spanN = document.createElement('span'); spanN.className = 'name'; spanN.textContent = it.name;
ย ย ย ย ย ย ย const spanS = document.createElement('span'); spanS.className = 'sector'; spanS.textContent = ` โ ${it.sector}`;
ย ย ย ย ย ย ย li.append(spanN, spanS);
ย ย ย ย ย ย ย ul.append(li);
ย ย ย ย ย ย });
ย ย ย ย ย ย calendarTooltip.append(ul);
ย ย ย ย ย ย const rect = ev.target.getBoundingClientRect();
ย ย ย ย ย ย const x = Math.min(window.innerWidth - calendarTooltip.offsetWidth - 8, rect.left + window.scrollX);
ย ย ย ย ย ย const y = rect.bottom + window.scrollY + 6;
ย ย ย ย ย ย calendarTooltip.style.left = `${Math.max(8, x)}px`;
ย ย ย ย ย ย calendarTooltip.style.top = `${Math.min(window.innerHeight - 40, y)}px`;
ย ย ย ย ย });
ย ย ย ย ย cell.addEventListener('mouseleave', () => {
ย ย ย ย ย ย calendarTooltip.style.display = 'none';
ย ย ย ย ย });

ย ย ย ย ย calendarGrid.append(cell);
ย ย ย ย }
ย ย ย };

ย ย ย const renderCharts = () => {
ย ย ย ย const cp = document.getElementById('chart-panel');
ย ย ย ย if (!cp || cp.classList.contains('hidden')) return;
ย ย ย ย const bc = document.getElementById('birthday-chart');
ย ย ย ย const sc = document.getElementById('sector-chart');
ย ย ย ย if (!bc || !sc || typeof Chart === 'undefined') return;
ย ย ย ย const monthsCount = new Array(12).fill(0);
ย ย ย ย window.birthdayData.forEach(b => monthsCount[(b.month||1)-1]++);
ย ย ย ย if (window._birthdayChart) window._birthdayChart.destroy();
ย ย ย ย window._birthdayChart = new Chart(bc.getContext('2d'), {
ย ย ย ย ย type: 'bar',
ย ย ย ย ย data: { labels: monthNames, datasets: [{ label: 'Aniversariantes', data: monthsCount }] },
ย ย ย ย ย options: { responsive:true, maintainAspectRatio:false }
ย ย ย ย });
ย ย ย ย const sectorMap = {};
ย ย ย ย window.birthdayData.forEach(b => sectorMap[b.sector] = (sectorMap[b.sector] || 0) + 1);
ย ย ย ย if (window._sectorChart) window._sectorChart.destroy();
ย ย ย ย window._sectorChart = new Chart(sc.getContext('2d'), {
ย ย ย ย ย type: 'doughnut',
ย ย ย ย ย data: { labels: Object.keys(sectorMap), datasets: [{ data: Object.values(sectorMap) }] },
ย ย ย ย ย options: { responsive:true, maintainAspectRatio:false }
ย ย ย ย });
ย ย ย };

ย ย ย /* ---- CRUD & Modal logic (V1) ---- */
ย ย ย let editingId = null;
ย ย ย const openEditModal = (person) => {
ย ย ย ย editingId = person.id;
ย ย ย ย modalTitle.textContent = 'Editar Aniversariante';
ย ย ย ย inputNome.value = person.name;
ย ย ย ย inputDia.value = String(person.day);
ย ย ย ย inputMes.value = String(person.month);
ย ย ย ย inputAno.value = person.year ? String(person.year) : '';
ย ย ย ย inputSetor.value = person.sector;
ย ย ย ย modal.classList.remove('hidden');
ย ย ย };

ย ย ย addPersonBtn && addPersonBtn.addEventListener('click', () => {
ย ย ย ย editingId = null;
ย ย ย ย modalTitle.textContent = 'Adicionar Aniversariante';
ย ย ย ย inputNome.value = '';
ย ย ย ย inputDia.value = '';
ย ย ย ย inputMes.value = '';
ย ย ย ย inputAno.value = '';
ย ย ย ย inputSetor.value = '';
ย ย ย ย modal.classList.remove('hidden');
ย ย ย });

ย ย ย cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));

ย ย ย saveBtn.addEventListener('click', async () => {
ย ย ย ย const nome = inputNome.value.trim();
ย ย ย ย const dia = parseInt(inputDia.value);
ย ย ย ย const mes = parseInt(inputMes.value);
ย ย ย ย const ano = inputAno.value ? parseInt(inputAno.value) : null;
ย ย ย ย const setor = inputSetor.value.trim();
ย ย ย ย if (!nome || !dia || !mes || !setor) {
ย ย ย ย ย alert('Preencha todos os campos (ano รฉ opcional).');
ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ย try {
ย ย ย ย ย const payload = {
ย ย ย ย ย ย nome, setor,
ย ย ย ย ย ย dia, mes,
ย ย ย ย ย ย ano: ano || null,
ย ย ย ย ย ย textoData: `${dia} de ${monthNames[mes-1] || ''}`,
ย ย ย ย ย ย updatedAt: serverTimestamp ? serverTimestamp() : undefined
ย ย ย ย ย };
ย ย ย ย ย if (dbCollection) {
ย ย ย ย ย ย if (editingId) {
ย ย ย ย ย ย ย await updateDoc(doc(db, 'aniversariantes', editingId), payload);
ย ย ย ย ย ย ย showNotification('Aniversariante atualizado.');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย await addDoc(dbCollection, {
ย ย ย ย ย ย ย ย ...payload,
ย ย ย ย ย ย ย ย createdAt: serverTimestamp ? serverTimestamp() : undefined
ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย showNotification('Aniversariante adicionado.');
ย ย ย ย ย ย }
ย ย ย ย ย } else {
ย ย ย ย ย ย // modo demo (sem Firestore)
ย ย ย ย ย ย if (editingId) {
ย ย ย ย ย ย ย const idx = window.birthdayData.findIndex(x => x.id === editingId);
ย ย ย ย ย ย ย if (idx >= 0) {
ย ย ย ย ย ย ย ย window.birthdayData[idx] = { ...window.birthdayData[idx], ...payload, id: editingId };
ย ย ย ย ย ย ย }
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย window.birthdayData.push({ ...payload, id: 'local_' + Date.now() });
ย ย ย ย ย ย }
ย ย ย ย ย ย renderAll();
ย ย ย ย ย ย showNotification('Operaรงรฃo simulada (modo demo).');
ย ย ย ย ย }
ย ย ย ย ย modal.classList.add('hidden');
ย ย ย ย } catch(e) {
ย ย ย ย ย console.error('Erro save: ', e);
ย ย ย ย ย showNotification('Erro ao salvar: ' + (e.message || String(e)), true);
ย ย ย ย }
ย ย ย });

ย ย ย // (V1) Delete with undo
ย ย ย const showUndoSnackbar = (text, undoTimeout = 8000) => {
ย ย ย ย undoSnackbarText.textContent = text;
ย ย ย ย undoSnackbar.style.display = 'flex';
ย ย ย ย let t = setTimeout(() => {
ย ย ย ย ย undoSnackbar.style.display = 'none';
ย ย ย ย ย lastDeleted = null;
ย ย ย ย }, undoTimeout);
ย ย ย ย undoSnackbarBtn.onclick = async () => {
ย ย ย ย ย clearTimeout(t);
ย ย ย ย ย undoSnackbar.style.display = 'none';
ย ย ย ย ย if (!lastDeleted) return;
ย ย ย ย ย try {
ย ย ย ย ย ย if (dbCollection) {
ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย await setDoc(doc(db, 'aniversariantes', lastDeleted.id), {
ย ย ย ย ย ย ย ย ย nome: lastDeleted.name,
ย ย ย ย ย ย ย ย ย setor: lastDeleted.sector,
ย ย ย ย ย ย ย ย ย dia: lastDeleted.day,
ย ย ย ย ย ย ย ย ย mes: lastDeleted.month,
ย ย ย ย ย ย ย ย ย ano: lastDeleted.year || null,
ย ย ย ย ย ย ย ย ย textoData: lastDeleted.textoData || `${lastDeleted.day} de ${monthNames[lastDeleted.month-1] || ''}`,
ย ย ย ย ย ย ย ย ย restoredAt: serverTimestamp ? serverTimestamp() : undefined
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย showNotification('Registro restaurado no Firestore.');
ย ย ย ย ย ย ย } catch(e) {
ย ย ย ย ย ย ย ย await addDoc(dbCollection, { ...lastDeleted, id: undefined, restoredAt: serverTimestamp ? serverTimestamp() : undefined });
ย ย ย ย ย ย ย ย showNotification('Registro restaurado (novo id).');
ย ย ย ย ย ย ย }
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย window.birthdayData.push(lastDeleted);
ย ย ย ย ย ย ย renderAll();
ย ย ย ย ย ย ย showNotification('Registro restaurado (demo).');
ย ย ย ย ย ย }
ย ย ย ย ย } catch(err) {
ย ย ย ย ย ย console.error('Erro desfazer:', err);
ย ย ย ย ย ย showNotification('Erro ao desfazer: ' + (err.message || err), true);
ย ย ย ย ย } finally {
ย ย ย ย ย ย lastDeleted = null;
ย ย ย ย ย }
ย ย ย ย };
ย ย ย };

ย ย ย const deletePerson = async (id, name, fullObj = null) => {
ย ย ย ย if (!confirm(`Deseja excluir ${name}?`)) return;
ย ย ย ย try {
ย ย ย ย ย if (!fullObj) {
ย ย ย ย ย ย fullObj = window.birthdayData.find(x => x.id === id) || { id, name, sector: '', day: 0, month: 0, year: null };
ย ย ย ย ย }
ย ย ย ย ย lastDeleted = JSON.parse(JSON.stringify(fullObj));

ย ย ย ย ย if (dbCollection) {
ย ย ย ย ย ย await deleteDoc(doc(db, 'aniversariantes', id));
ย ย ย ย ย ย showNotification('Registro excluรญdo.');
ย ย ย ย ย } else {
ย ย ย ย ย ย window.birthdayData = window.birthdayData.filter(x => x.id !== id);
ย ย ย ย ย ย renderAll();
ย ย ย ย ย ย showNotification('Operaรงรฃo simulada (modo demo).');
ย ย ย ย ย }
ย ย ย ย ย showUndoSnackbar(`Registro ${name} excluรญdo.`, 10000);
ย ย ย ย } catch(e) {
ย ย ย ย ย console.error('Erro delete: ', e);
ย ย ย ย ย showNotification('Erro ao excluir: ' + (e.message || String(e)), true);
ย ย ย ย }
ย ย ย };

ย ย ย /* ---- Event Listeners (V1 + V2) ---- */
ย ย ย const updateSortIndicators = () => {
ย ย ย ย if (!tableHeader) return;
ย ย ย ย tableHeader.querySelectorAll('th').forEach(th => {
ย ย ย ย ย const span = th.querySelector('span');
ย ย ย ย ย if (!span) return;
ย ย ย ย ย if (th.dataset.sort === sortConfig.key) {
ย ย ย ย ย ย span.textContent = sortConfig.direction === 'ascending' ? ' โฒ' : ' โผ';
ย ย ย ย ย } else {
ย ย ย ย ย ย span.textContent = '';
ย ย ย ย ย }
ย ย ย ย });
ย ย ย };
ย ย ย const debounce = (fn, delay=250) => {
ย ย ย ย let t;
ย ย ย ย return (...args) => {
ย ย ย ย ย clearTimeout(t);
ย ย ย ย ย t = setTimeout(() => fn(...args), delay);
ย ย ย ย };
ย ย ย };

ย ย ย prevMonthBtn.addEventListener('click', () => {
ย ย ย ย currentDate.setMonth(currentDate.getMonth() - 1);
ย ย ย ย renderCalendar();
ย ย ย });
ย ย ย nextMonthBtn.addEventListener('click', () => {
ย ย ย ย currentDate.setMonth(currentDate.getMonth() + 1);
ย ย ย ย renderCalendar();
ย ย ย });

ย ย ย searchInput.addEventListener('input', debounce(e => renderTable(e.target.value), 220));
ย ย ย filterMonth.addEventListener('change', () => renderTable(searchInput.value));
ย ย ย weekStartMondayCheckbox && weekStartMondayCheckbox.addEventListener('change', () => renderCalendar());

ย ย ย tabsContainer.addEventListener('click', ev => {
ย ย ย ย const btn = ev.target.closest('.tab-btn');
ย ย ย ย if (!btn) return;
ย ย ย ย const tab = btn.dataset.tab;
ย ย ย ย document.querySelectorAll('#tab-panels-container .tab-panel').forEach(p => p.classList.add('hidden'));
ย ย ย ย document.querySelectorAll('#tabs-container .tab-btn').forEach(b => b.classList.remove('active'));
ย ย ย ย btn.classList.add('active');
ย ย ย ย const panelMap = { today:'#today-panel', upcoming:'#upcoming-panel', calendar:'#calendar-panel', list:'#list-panel', chart:'#chart-panel' };
ย ย ย ย const sel = panelMap[tab];
ย ย ย ย if (sel) document.querySelector(sel).classList.remove('hidden');
ย ย ย ย activeTabUnderline.style.width = `${btn.offsetWidth}px`;
ย ย ย ย activeTabUnderline.style.left = `${btn.offsetLeft}px`;
ย ย ย ย if (tab === 'chart') renderCharts();
ย ย ย });

ย ย ย themeToggleBtn.addEventListener('click', () => {
ย ย ย ย const isDark = document.documentElement.classList.toggle('dark');
ย ย ย ย localStorage.setItem('theme', isDark ? 'dark' : 'light');
ย ย ย ย themeToggleBtn.textContent = isDark ? 'โ๏ธ' : '๐'; // (V2) Atualiza รญcone
ย ย ย });
ย ย ย // (V2) Seta รญcone inicial do tema
ย ย ย if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
ย ย ย ย document.documentElement.classList.add('dark');
ย ย ย ย themeToggleBtn.textContent = 'โ๏ธ';
ย ย ย } else {
ย ย ย ย themeToggleBtn.textContent = '๐';
ย ย ย }


ย ย ย importCsvBtn && importCsvBtn.addEventListener('click', () => csvFileInput.click());
ย ย ย csvFileInput && csvFileInput.addEventListener('change', e => {
ย ย ย ย const file = e.target.files && e.target.files[0];
ย ย ย ย if (!file) return;
ย ย ย ย importCsvFile(file);
ย ย ย ย e.target.value = '';
ย ย ย });

ย ย ย exportCsvBtn && exportCsvBtn.addEventListener('click', () => exportCsv());

ย ย ย tableHeader && tableHeader.addEventListener('click', e => {
ย ย ย ย const th = e.target.closest('th');
ย ย ย ย if (!th || th.dataset.sort === 'none') return;
ย ย ย ย const key = th.dataset.sort;
ย ย ย ย if (sortConfig.key === key) {
ย ย ย ย ย sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
ย ย ย ย } else {
ย ย ย ย ย sortConfig.key = key;
ย ย ย ย ย sortConfig.direction = 'ascending';
ย ย ย ย }
ย ย ย ย renderAll(searchInput.value);
ย ย ย });

ย ย ย calendarGrid.addEventListener('mousemove', debounce(e => {
ย ย ย ย if (calendarTooltip.style.display === 'block') {
ย ย ย ย ย const x = Math.min(window.innerWidth - calendarTooltip.offsetWidth - 8, e.pageX + 12);
ย ย ย ย ย calendarTooltip.style.left = `${x}px`;
ย ย ย ย }
ย ย ย }, 20));

ย ย ย const updateUnderline = () => {
ย ย ย ย const active = document.querySelector('.tab-btn.active');
ย ย ย ย if (active) {
ย ย ย ย ย activeTabUnderline.style.width = `${active.offsetWidth}px`;
ย ย ย ย ย activeTabUnderline.style.left = `${active.offsetLeft}px`;
ย ย ย ย }
ย ย ย };
ย ย ย window.addEventListener('resize', debounce(updateUnderline, 120));
ย ย ย try {
ย ย ย ย const ro = new ResizeObserver(debounce(updateUnderline, 120));
ย ย ย ย ro.observe(tabsContainer);
ย ย ย } catch(e) {}

ย ย ย const firstTab = tabsContainer.querySelector('.tab-btn');
ย ย ย if (firstTab) {
ย ย ย ย firstTab.click();
ย ย ย ย requestAnimationFrame(() => {
ย ย ย ย ย activeTabUnderline.style.width = `${firstTab.offsetWidth}px`;
ย ย ย ย ย activeTabUnderline.style.left = `${firstTab.offsetLeft}px`;
ย ย ย ย });
ย ย ย }

ย ย ย // (V2) Auto-celebrate toggle init
ย ย ย try {
ย ย ย ย const forceAuto = localStorage.getItem(forceAutoKey) === 'true';
ย ย ย ย autoCelebrateToggle.checked = forceAuto;
ย ย ย } catch(e){}
ย ย ย autoCelebrateToggle.addEventListener('change', (ev) => {
ย ย ย ย try { localStorage.setItem(forceAutoKey, ev.target.checked ? 'true' : 'false'); } catch(e){}
ย ย ย });

ย ย ย // (V2) Celebrate button (com confirmaรงรฃo de prefersReduced)
ย ย ย if (celebrateNowBtn) {
ย ย ย ย celebrateNowBtn.addEventListener('click', (ev) => {
ย ย ย ย ย ev.preventDefault();
ย ย ย ย ย const reduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
ย ย ย ย ย const now = new Date();
ย ย ย ย ย const day = now.getDate(), month = now.getMonth()+1;
ย ย ย ย ย const todays = window.birthdayData.filter(p => p.day === day && p.month === month);
ย ย ย ย ย if (reduced) {
ย ย ย ย ย ย const ok = confirm('Seu sistema estรก configurado para reduzir animaรงรตes. Deseja forรงar a celebraรงรฃo visual (pode causar desconforto para alguns usuรกrios)?');
ย ย ย ย ย ย if (!ok) {
ย ย ย ย ย ย ย showNotification('Celebraรงรฃo cancelada (modo reduzir movimentos ativo).');
ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย }
ย ย ย ย ย triggerCelebration(Math.max(1, todays.length), { force: true, userInitiated: true, notPersist: false });
ย ย ย ย });
ย ย ย }

ย ย ย // (V1) Overlay play
ย ย ย todayOverlayPlay && todayOverlayPlay.addEventListener('click', () => {
ย ย ย ย const now = new Date();
ย ย ย ย const day = now.getDate(), month = now.getMonth()+1;
ย ย ย ย const todays = window.birthdayData.filter(p => p.day === day && p.month === month);
ย ย ย ย triggerCelebration(Math.max(1,todays.length), { force: true, userInitiated: true });
ย ย ย });

ย ย ย // (V2) Sound toggle
ย ย ย try {
ย ย ย ย setSoundEnabled(localStorage.getItem(soundEnableKey) !== 'false');
ย ย ย ย soundToggleBtn && soundToggleBtn.addEventListener('click', () => {
ย ย ย ย ย setSoundEnabled(!(localStorage.getItem(soundEnableKey) !== 'false'));
ย ย ย ย });
ย ย ย } catch(e) {}

ย ย ย // (V1) Import/Export CSV
ย ย ย const normalizeRow = (row) => {
ย ย ย ย const name = (row.nome || row.name || '').trim();
ย ย ย ย const sector = (row.setor || row.sector || '').trim();
ย ย ย ย const dayRaw = row.dia || row.day || '';
ย ย ย ย const monthRaw = row.mes || row.month || '';
ย ย ย ย const yearRaw = row.ano || row.year || '';
ย ย ย ย const day = Number(dayRaw) || 0;
ย ย ย ย const month = Number(monthRaw) || 0;
ย ย ย ย const year = yearRaw ? Number(yearRaw) : null;
ย ย ย ย return { name, sector, day, month, year };
ย ย ย };
ย ย ย const validateAndNormalizeRow = (row) => {
ย ย ย ย const r = normalizeRow(row);
ย ย ย ย const errors = [];
ย ย ย ย if (!r.name) errors.push('Nome vazio');
ย ย ย ย if (!r.day || r.day < 1 || r.day > 31) errors.push('Dia invรกlido');
ย ย ย ย if (!r.month || r.month < 1 || r.month > 12) errors.push('Mรชs invรกlido');
ย ย ย ย return { valid: errors.length === 0, errors, row: r };
ย ย ย };
ย ย ย const importCsvFile = (file) => {
ย ย ย ย Papa.parse(file, {
ย ย ย ย ย header: true,
ย ย ย ย ย skipEmptyLines: true,
ย ย ย ย ย complete: async (results) => {
ย ย ย ย ย ย const data = results.data || [];
ย ย ย ย ย ย const invalid = [];
ย ย ย ย ย ย const duplicates = [];
ย ย ย ย ย ย const added = [];
ย ย ย ย ย ย const seen = new Set();
ย ย ย ย ย ย for (const rawRow of data) {
ย ย ย ย ย ย ย const { valid, errors, row } = validateAndNormalizeRow(rawRow);
ย ย ย ย ย ย ย if (!valid) {
ย ย ย ย ย ย ย ย invalid.push({ raw: rawRow, errors });
ย ย ย ย ย ย ย ย continue;
ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย const dedupeKey = `${row.name.toLowerCase()}|${row.day}|${row.month}`;
ย ย ย ย ย ย ย if (seen.has(dedupeKey)) {
ย ย ย ย ย ย ย ย duplicates.push(row);
ย ย ย ย ย ย ย ย continue;
ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย const exists = window.birthdayData.some(b => (b.name||'').toLowerCase() === (row.name||'').toLowerCase() && b.day === row.day && b.month === row.month);
ย ย ย ย ย ย ย if (exists) {
ย ย ย ย ย ย ย ย duplicates.push(row);
ย ย ย ย ย ย ย ย continue;
ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย seen.add(dedupeKey);
ย ย ย ย ย ย ย const payload = {
ย ย ย ย ย ย ย ย nome: row.name,
ย ย ย ย ย ย ย ย setor: row.sector || '',
ย ย ย ย ย ย ย ย dia: row.day,
ย ย ย ย ย ย ย ย mes: row.month,
ย ย ย ย ย ย ย ย ano: row.year || null,
ย ย ย ย ย ย ย ย textoData: `${row.day} de ${monthNames[row.month-1] || ''}`
ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย if (dbCollection) {
ย ย ย ย ย ย ย ย ย await addDoc(dbCollection, payload);
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย window.birthdayData.push({ ...payload, id: 'local_'+Date.now() + Math.floor(Math.random()*1000) });
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย added.push(row);
ย ย ย ย ย ย ย } catch(e) {
ย ย ย ย ย ย ย ย console.error('Erro addRow', e);
ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ย renderAll();
ย ย ย ย ย ย showNotification(`Import concluรญda: ${added.length} adicionados, ${duplicates.length} duplicados, ${invalid.length} invรกlidos.`);
ย ย ย ย ย ย console.info('Import CSV result:', { added: added.length, duplicates: duplicates.length, invalid: invalid.length });
ย ย ย ย ย },
ย ย ย ย ย error: (err) => {
ย ย ย ย ย ย console.error('PapaParse error', err);
ย ย ย ย ย ย showNotification('Erro ao importar CSV: ' + err.message, true);
ย ย ย ย ย }
ย ย ย ย });
ย ย ย };
ย ย ย const exportCsv = () => {
ย ย ย ย try {
ย ย ย ย ย const arr = window.birthdayData.map(b => ({
ย ย ย ย ย ย id: b.id,
ย ย ย ย ย ย name: b.name,
ย ย ย ย ย ย sector: b.sector,
ย ย ย ย ย ย day: b.day,
ย ย ย ย ย ย month: b.month,
ย ย ย ย ย ย year: b.year || ''
ย ย ย ย ย }));
ย ย ย ย ย const csv = Papa.unparse(arr);
ย ย ย ย ย const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
ย ย ย ย ย const url = URL.createObjectURL(blob);
ย ย ย ย ย const a = document.createElement('a');
ย ย ย ย ย a.href = url;
ย ย ย ย ย a.download = `aniversariantes_${new Date().toISOString().slice(0,10)}.csv`;
ย ย ย ย ย document.body.appendChild(a);
ย ย ย ย ย a.click();
ย ย ย ย ย a.remove();
ย ย ย ย ย URL.revokeObjectURL(url);
ย ย ย ย } catch(e) {
ย ย ย ย ย console.error('Erro exportCsv', e);
ย ย ย ย ย showNotification('Erro ao exportar CSV: ' + (e.message || e), true);
ย ย ย ย }
ย ย ย };
ย ย ย 
ย ย ย /* ---- (V2) Auth button: try popup, fallback to redirect ---- */
ย ย ย authBtn && authBtn.addEventListener('click', async (ev) => {
ย ย ย ย ev.preventDefault();
ย ย ย ย if (!auth) {
ย ย ย ย ย // Demo fallback se o firebase falhou em init
ย ย ย ย ย document.body.classList.toggle('admin-mode');
ย ย ย ย ย isAdmin = document.body.classList.contains('admin-mode');
ย ย ย ย ย showNotification(isAdmin ? 'Modo admin demo ativado' : 'Modo admin demo desativado');
ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย try {
ย ย ย ย ย if (auth.currentUser) {
ย ย ย ย ย ย await signOut(auth);
ย ย ย ย ย ย showNotification('Desconectado');
ย ย ย ย ย ย return;
ย ย ย ย ย }

ย ย ย ย ย const provider = new GoogleAuthProvider();
ย ย ย ย ย const inIframe = window.self !== window.top;
ย ย ย ย ย 
ย ย ย ย ย if (!inIframe) {
ย ย ย ย ย ย // 1. Tenta Popup (preferido se nรฃo for iframe)
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย await signInWithPopup(auth, provider);
ย ย ย ย ย ย ย console.info('signInWithPopup success');
ย ย ย ย ย ย ย showNotification('Login com Popup bem-sucedido.');
ย ย ย ย ย ย ย return;
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย console.warn('signInWithPopup error (code, msg):', err.code, err.message);
ย ย ย ย ย ย ย // 2. Fallback para Redirect se popup falhar (ex: bloqueado)
ย ย ย ย ย ย ย showNotification('Popup bloqueado. Tentando login via redirecionamento...');
ย ย ย ย ย ย ย await signInWithRedirect(auth, provider);
ย ย ย ย ย ย }
ย ย ย ย ย } else {
ย ย ย ย ย ย // 3. Em Iframe (ex: SharePoint), usa Redirect direto
ย ย ย ย ย ย console.info('App estรก em iframe. Usando signInWithRedirect.');
ย ย ย ย ย ย showNotification('Iniciando login (em iframe)...');
ย ย ย ย ย ย await signInWithRedirect(auth, provider);
ย ย ย ย ย }
ย ย ย ย } catch(e) {
ย ย ย ย ย console.error('Auth handler error', e);
ย ย ย ย ย showNotification('Erro de autenticaรงรฃo: ' + (e.message || e), true);
ย ย ย ย }
ย ย ย });

ย ย ย /* ---- Initialize app ---- */
ย ย ย // (V2) initFirebaseAuth agora รฉ chamado primeiro
ย ย ย initFirebaseAuth().then(() => {
ย ย ย ย fetchAndRenderData(); // fetchAndRenderData agora depende do init (para dbCollection)
ย ย ย });

ย ย ย window.addEventListener('error', ev => {
ย ย ย ย console.error('Global error:', ev.error || ev.message);
ย ย ย ย safeFinallyShowUI();
ย ย ย });
ย ย ย window.addEventListener('unhandledrejection', ev => {
ย ย ย ย console.error('Unhandled rejection:', ev.reason);
ย ย ย ย safeFinallyShowUI();
ย ย ย });

ย ย ย /* ---- Debug helpers ---- */
ย ย ย try {
ย ย ย ย window._celebrate = { // (V2) Atualizado
ย ย ย ย ย trigger: triggerCelebration, 
ย ย ย ย ย createBalloons, 
ย ย ย ย ย playCelebrateSound, 
ย ย ย ย ย metrics: () => localStorage.getItem(metricsKey) 
ย ย ย ย };
ย ย ย ย window.__getBirthdayData = () => {
ย ย ย ย ย try { return (typeof window.birthdayData !== 'undefined') ? JSON.parse(JSON.stringify(window.birthdayData)) : null; }
ย ย ย ย ย catch(e) { return { error: String(e) }; }
ย ย ย ย };
ย ย ย ย window.__getAuth = () => {
ย ย ย ย ย try { return auth && auth.currentUser ? { uid: auth.currentUser.uid, email: auth.currentUser.email } : null; }
ย ย ย ย ย catch(e) { return null; }
ย ย ย ย };
ย ย ย ย console.info('Debug helpers: window._celebrate, window.__getBirthdayData, window.__getAuth');
ย ย ย ย console.info('App loaded. APP_BUILD', APP_BUILD, 'prefersReduced:', prefersReduced);
ย ย ย } catch(e){}

ย ย });
ย </script>
ย </body>
</html>
