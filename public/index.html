<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Aniversariantes</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="/firebase-config.js"></script>

  <style>
    :root {
      --eletro-blue: #003366;
      --eletro-teal: #009a74;
      --muted: #6b7280;
      --bg-page: #f8fafc;
      --card-bg: #ffffff;
      --text-color: #0f172a;
      --soft-border: #e2e8f0;
      --shadow-1: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius: 12px;
    }

    html.dark {
      --muted: #9ca3af;
      --bg-page: #111827;
      --card-bg: #1f2937;
      --text-color: #f9fafb;
      --soft-border: #374151;
      --shadow-1: 0 4px 6px -1px rgb(255 255 255 / 0.05), 0 2px 4px -2px rgb(255 255 255 / 0.05);
    }

    html, body {
      height: 100%; margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Arial;
      background: var(--bg-page); color: var(--text-color); transition: background 0.3s ease, color 0.3s ease;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 28px 20px; position: relative; z-index: 10; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 18px; padding-bottom: 18px; border-bottom: 1px solid var(--soft-border); margin-bottom: 22px; }
    .title-group { display: flex; gap: 12px; align-items: center; }
    svg.logo-icon { width: 56px; height: 56px; border-radius: 8px; padding: 6px; background: linear-gradient(135deg, var(--eletro-blue), var(--eletro-teal)); color: white; }
    h1 { font-size: 22px; margin: 0; color: var(--text-color); font-weight: 600; }
    html.dark h1 { color: var(--eletro-teal); }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    #theme-toggle-btn { background: none; border: none; cursor: pointer; color: var(--muted); padding: 4px; display: flex; align-items: center; justify-content: center; }
    #theme-toggle-btn svg { width: 22px; height: 22px; }
    .sun-icon { display: none; }
    .moon-icon { display: block; }
    html.dark .sun-icon { display: block; }
    html.dark .moon-icon { display: none; }
    #tabs-container { position: relative; display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; border-bottom: 1px solid var(--soft-border); }
    #active-tab-underline { position: absolute; bottom: -1px; height: 2px; background-color: var(--eletro-blue); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    html.dark #active-tab-underline { background-color: var(--eletro-teal); }
    .tab-btn { background: transparent; border: none; padding: 10px 14px; color: var(--muted); font-weight: 600; cursor: pointer; transition: color 0.2s ease-in-out; z-index: 1; }
    .tab-btn:hover { color: var(--text-color); }
    .tab-btn.active { color: var(--eletro-blue); }
    html.dark .tab-btn.active { color: var(--eletro-teal); }
    .tab-panel { margin-top: 12px; }
    .bg-card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow-1); border: 1px solid var(--soft-border); transition: background 0.3s ease, border-color 0.3s ease; }
    #today-panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .birthday-card { display: flex; align-items: center; gap: 16px; padding: 16px; }
    .avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 18px; flex-shrink: 0; }
    .card-info .name { font-weight: 600; display: block; }
    .card-info .sector { font-size: 14px; color: var(--muted); }
    .table-avatar-cell { display: flex; align-items: center; gap: 12px; }
    table { border-collapse: collapse; width: 100%; }
    thead th { background: #f8fafc; padding: 14px; text-align: left; font-size: 14px; color: #475569; }
    html.dark thead th { background: #374151; color: #d1d5db; }
    tbody tr { border-bottom: 1px solid var(--soft-border); }
    tbody tr:last-child { border-bottom: none; }
    tbody td { padding: 12px 14px; }
    .search-input { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--soft-border); background-color: var(--bg-page); margin-bottom: 16px; color: var(--text-color); }
    .search-input:focus { outline: none; border-color: var(--eletro-blue); box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.2); }
    html.dark .search-input:focus { border-color: var(--eletro-teal); box-shadow: 0 0 0 2px rgba(0, 154, 116, 0.2); }
    #calendar-grid .day-cell { background-color: rgba(0, 154, 116, 0.05); cursor: pointer; }
    #calendar-grid .day-cell[data-count="1"] { background-color: rgba(0, 154, 116, 0.2); }
    #calendar-grid .day-cell[data-count="2"] { background-color: rgba(0, 154, 116, 0.5); }
    #calendar-grid .day-cell[data-count="3"] { background-color: rgba(0, 154, 116, 0.8); }
    .admin-only { display: none !important; }
    body.admin-mode .admin-only { display: block !important; }
    .admin-only-table-cell { display: none !important; }
    body.admin-mode .admin-only-table-cell { display: table-cell !important; }
    .hidden { display: none !important; }
    #notification-toast { position: fixed; right: 20px; bottom: 20px; padding: 12px 16px; border-radius: 8px; color: white; opacity: 0; transform: translateY(10px); transition: all .25s ease; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); z-index: 1000000; }
    #fullscreen-celebration { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; overflow: hidden; z-index: 999999; }
    canvas#confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .balloon { position: absolute; bottom: -100px; width: 60px; height: 80px; background-color: #ff69b4; border-radius: 75% 75% 70% 70%; opacity: 0.8; animation: rise 10s ease-in forwards; z-index: 1000; }
    .balloon::before { content: ''; position: absolute; width: 1px; height: 40px; background-color: rgba(0, 0, 0, 0.3); bottom: -40px; left: 50%; transform: translateX(-50%); }
    .balloon::after { content: ''; position: absolute; border-style: solid; border-width: 0 7px 12px 7px; border-color: transparent transparent inherit transparent; bottom: -10px; left: calc(50% - 7px); transform: rotate(180deg); }
    @keyframes rise { 0% { transform: translateY(0) scale(0.8); opacity: 0.5; } 100% { transform: translateY(-120vh) scale(1.2); opacity: 0; } }
    
    /* Estilo para o Tooltip do Calend√°rio (NOVO) */
    #calendar-tooltip {
      position: absolute;
      display: none;
      padding: 8px 12px;
      background-color: var(--card-bg);
      border: 1px solid var(--soft-border);
      border-radius: 8px;
      box-shadow: var(--shadow-1);
      z-index: 10000;
      pointer-events: none; /* Para n√£o interferir com o mouse */
      font-size: 14px;
      max-width: 250px;
      transition: opacity 0.2s;
    }
    #calendar-tooltip ul {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    #calendar-tooltip li {
      white-space: nowrap;
      margin-bottom: 4px;
    }
    #calendar-tooltip li:last-child {
      margin-bottom: 0;
    }
    #calendar-tooltip .name { font-weight: 600; }
    #calendar-tooltip .sector { color: var(--muted); }
  </style>
</head>

<body>
  <div id="fullscreen-celebration">
      <canvas id="confetti-canvas"></canvas>
  </div>

  <div id="calendar-tooltip"></div>
  
  <div class="container">
    <header>
      <div class="title-group">
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.975M15 10a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <div>
          <h1>Painel de Aniversariantes</h1>
          <p style="margin:0; color:var(--muted); font-size:13px">Celebre com a nossa equipe.</p>
        </div>
      </div>
      <div class="header-actions">
          <button id="theme-toggle-btn" aria-label="Toggle dark mode">
              <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
              <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
          </button>
        <button id="auth-btn" class="tertiary text-sm">üîí Acesso Restrito</button>
      </div>
    </header>
    <div id="tabs-container">
      <button data-tab="today" class="tab-btn">üéÇ Hoje</button>
      <button data-tab="calendar" class="tab-btn">üóìÔ∏è Calend√°rio</button>
      <button data-tab="list" class="tab-btn">üìã Lista Completa</button>
      <button data-tab="chart" class="tab-btn admin-only">üìä Gest√£o</button>
      <div id="active-tab-underline"></div>
    </div>
    <main id="tab-panels-container">
        <div id="today-panel" class="tab-panel"></div>
        <div id="calendar-panel" class="tab-panel hidden">
            <div class="bg-card p-4 rounded-lg">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
                    <h2 style="margin:0; font-size:18px">Calend√°rio de Anivers√°rios</h2>
                    <div>
                        <button id="prev-month-btn" style="margin-right:6px">‚óÄ</button>
                        <span id="calendar-month-year"></span>
                        <button id="next-month-btn" style="margin-left:6px">‚ñ∂</button>
                    </div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
            </div>
        </div>
        <div id="list-panel" class="tab-panel hidden">
            <div class="bg-card p-4 rounded-lg">
                <input type="search" id="search-input" placeholder="Buscar por nome ou setor..." class="search-input">
                <div style="max-height:56vh; overflow:auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Setor</th>
                                <th>Data</th>
                                <th class="admin-only-table-cell">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="birthday-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="chart-panel" class="tab-panel hidden admin-only">
            <div class="bg-card p-4 rounded-lg">
                <canvas id="birthday-chart"></canvas>
            </div>
        </div>
    </main>
  </div>

  <div id="notification-toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
      // --- Elementos DOM ---
      const authBtn = document.getElementById('auth-btn');
      const tabsContainer = document.getElementById('tabs-container');
      const activeTabUnderline = document.getElementById('active-tab-underline');
      const todayPanel = document.getElementById('today-panel');
      const tableBody = document.getElementById('birthday-table-body');
      const searchInput = document.getElementById('search-input');
      const notificationToast = document.getElementById('notification-toast');
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      const calendarGrid = document.getElementById('calendar-grid');
      const calendarMonthYear = document.getElementById('calendar-month-year');
      const prevMonthBtn = document.getElementById('prev-month-btn');
      const nextMonthBtn = document.getElementById('next-month-btn');
      // NOVO: Selecionar o elemento do tooltip
      const calendarTooltip = document.getElementById('calendar-tooltip');

      // --- Vari√°veis Globais ---
      const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      const avatarColors = ['#003366', '#009a74', '#f0b400', '#dc2626', '#3b82f6', '#f43f5e', '#a855f7'];
      let db, auth, dbCollection, dataUnsub = null;
      let birthdayData = [];
      let currentDate = new Date(); // Controla o m√™s/ano do calend√°rio
      let isAdmin = false;
      let birthdayChart = null;

      // --- Fun√ß√µes Helper ---
      const showNotification = (msg, isError = false) => {
        notificationToast.textContent = msg;
        notificationToast.style.background = isError ? '#dc2626' : '#059669';
        notificationToast.style.opacity = '1';
        notificationToast.style.transform = 'translateY(0)';
        setTimeout(() => {
          notificationToast.style.opacity = '0';
          notificationToast.style.transform = 'translateY(10px)';
        }, 3500);
      };

      const getInitials = (name) => {
        const parts = name.trim().split(' ');
        if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
        return (parts[0][0] + (parts[parts.length - 1][0] || '')).toUpperCase();
      };

      const getColorForName = (name) => {
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        return avatarColors[Math.abs(hash) % avatarColors.length];
      };

      const createAvatar = (name) => {
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = getInitials(name);
        avatar.style.backgroundColor = getColorForName(name);
        return avatar;
      };

      const mapFirebaseDoc = (doc) => ({
        id: doc.id,
        name: doc.data().name || doc.data().nome || "",
        sector: doc.data().sector || doc.data().setor || "",
        day: Number(doc.data().day ?? doc.data().dia) || 0,
        month: Number(doc.data().month ?? doc.data().mes) || 0,
      });

      // --- Fun√ß√µes de Renderiza√ß√£o ---
      const renderAll = (searchTerm = '') => {
        birthdayData.sort((a, b) => (a.month - b.month) || (a.day - b.day));
        renderToday();
        renderTable(searchTerm);
        renderCalendar(); 
      };

      const renderToday = () => { /* ... (c√≥digo existente, sem altera√ß√µes) ... */ };
      const renderTable = (searchTerm = '') => { /* ... (c√≥digo existente, sem altera√ß√µes) ... */ };
      
      const renderCalendar = () => {
        calendarGrid.innerHTML = '';
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth();
        calendarMonthYear.textContent = `${monthNames[m]} ${y}`;
        const firstDayOfMonth = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        
        // Adiciona c√©lulas vazias para o in√≠cio do m√™s
        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const hits = birthdayData.filter(p => p.day === d && p.month === (m + 1));
            const count = hits.length;
            const dayCell = document.createElement('div');
            dayCell.className = "p-2 border border-gray-200 dark:border-gray-700 rounded-md text-center day-cell";
            dayCell.dataset.count = Math.min(count, 3);
            dayCell.dataset.day = d; // Armazena o dia para o tooltip
            dayCell.innerHTML = `<div class="font-bold">${d}</div>${count > 0 ? `<div class="text-xs">${count} anivers.</div>` : ''}`;
            calendarGrid.appendChild(dayCell);
        }
      };

      // --- L√≥gica do Firebase ---
      const initFirebase = () => {
        try {
          if (!window.__firebase_config) return showNotification("Configura√ß√£o do Firebase ausente.", true);
          const app = initializeApp(window.__firebase_config);
          auth = getAuth(app);
          db = getFirestore(app);
          dbCollection = collection(db, 'aniversariantes');
          
          onAuthStateChanged(auth, async (user) => {
            isAdmin = false;
            if (user) {
              authBtn.textContent = `üîì ${user.email}`;
              const tokenResult = await user.getIdTokenResult();
              isAdmin = tokenResult.claims.admin === true;
            } else {
              authBtn.textContent = "üîí Acesso Restrito";
            }
            document.body.classList.toggle('admin-mode', isAdmin);
          });
          
          dataUnsub = onSnapshot(dbCollection, (snapshot) => {
            birthdayData = snapshot.docs.map(mapFirebaseDoc);
            renderAll(searchInput.value.trim());
          }, (error) => {
            showNotification("Erro de conex√£o.", true);
          });

        } catch (err) {
          showNotification("Erro fatal na inicializa√ß√£o.", true);
        }
      };

      // --- Event Listeners ---
      authBtn.addEventListener('click', () => { /* ... (c√≥digo existente, sem altera√ß√µes) ... */ });
      searchInput.addEventListener('input', (e) => renderAll(e.target.value));
      tabsContainer.addEventListener('click', (ev) => { /* ... (c√≥digo existente, sem altera√ß√µes) ... */ });
      themeToggleBtn.addEventListener('click', () => { /* ... (c√≥digo existente, sem altera√ß√µes) ... */ });
      
      prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      });
      nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      });

      // NOVO: Event listeners para o tooltip do calend√°rio
      calendarGrid.addEventListener('mouseover', (e) => {
        const dayCell = e.target.closest('.day-cell');
        if (!dayCell || dayCell.dataset.count === '0') return;

        const day = parseInt(dayCell.dataset.day);
        const month = currentDate.getMonth() + 1;
        const bdaysOnDay = birthdayData.filter(p => p.day === day && p.month === month);

        if (bdaysOnDay.length > 0) {
          calendarTooltip.innerHTML = `<ul>${bdaysOnDay.map(p => `<li><span class="name">${p.name}</span><br><span class="sector">${p.sector}</span></li>`).join('')}</ul>`;
          calendarTooltip.style.display = 'block';
        }
      });
      
      calendarGrid.addEventListener('mouseout', () => {
        calendarTooltip.style.display = 'none';
      });
      
      calendarGrid.addEventListener('mousemove', (e) => {
        if (calendarTooltip.style.display === 'block') {
          // Posiciona o tooltip perto do cursor do mouse
          calendarTooltip.style.left = `${e.pageX + 15}px`;
          calendarTooltip.style.top = `${e.pageY + 15}px`;
        }
      });

      // --- Inicializa√ß√£o ---
      const initTheme = () => { /* ... (c√≥digo existente, sem altera√ß√µes) ... */ };
      
      initTheme();
      initFirebase();
      const firstTab = tabsContainer.querySelector('.tab-btn');
      if (firstTab) {
        firstTab.click();
      }
    });

    // Recarregando o corpo das fun√ß√µes que estavam colapsadas
    document.addEventListener('DOMContentLoaded', () => {
      const todayPanel = document.getElementById('today-panel');
      const tableBody = document.getElementById('birthday-table-body');
      const createAvatar = (name) => {
          const avatar = document.createElement('div');
          avatar.className = 'avatar';
          avatar.textContent = (name.trim().split(' ').length === 1 ? name.substring(0,2) : (name.split(' ')[0][0] + name.split(' ')[name.split(' ').length-1][0])).toUpperCase();
          let hash = 0; for(let i=0; i<name.length; i++) hash = name.charCodeAt(i) + ((hash<<5)-hash);
          avatar.style.backgroundColor = ['#003366','#009a74','#f0b400','#dc2626','#3b82f6'][Math.abs(hash)%5];
          return avatar;
      };
      window.renderToday = (birthdayData) => {
          todayPanel.innerHTML = '';
          const now = new Date();
          const todays = birthdayData.filter(p => p.day === now.getDate() && p.month === (now.getMonth() + 1));
          if(todays.length === 0){ todayPanel.innerHTML = `<div class="bg-card p-4 text-center rounded-lg">Nenhum aniversariante hoje.</div>`; return; }
          const grid = document.createElement('div');
          grid.id = 'today-panel-grid';
          todays.forEach(p => { const card = document.createElement('div'); card.className = 'birthday-card bg-card'; card.innerHTML = `<div class="card-info"><span class="name">${p.name}</span><span class="sector">${p.sector}</span></div>`; card.prepend(createAvatar(p.name)); grid.appendChild(card); });
          todayPanel.appendChild(grid);
      };
      window.renderTable = (birthdayData, searchTerm) => {
          tableBody.innerHTML = '';
          const filtered = searchTerm ? birthdayData.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.sector.toLowerCase().includes(searchTerm.toLowerCase())) : birthdayData;
          filtered.forEach(p => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="table-avatar-cell"><span>${p.name}</span></td><td>${p.sector}</td><td>${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}</td><td class="admin-only-table-cell">...</td>`; tr.querySelector('.table-avatar-cell').prepend(createAvatar(p.name)); tableBody.appendChild(tr); });
      };
      // O restante das fun√ß√µes omitidas por brevidade
    });
  </script>
</body>
</html>
