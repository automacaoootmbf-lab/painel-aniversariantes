<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Aniversariantes ‚Äî Axia Energia</title>
  <meta name="description" content="Gest√£o corporativa de aniversariantes." />
  <meta name="theme-color" content="#0e7490">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    /* =========================================
       1. VARIAVEIS E TEMA (AXIA ENERGIA)
       ========================================= */
    :root {
      /* Cores da Marca */
      --brand-dark: #0f172a;       /* Navy Blue Profundo */
      --brand-primary: #0891b2;    /* Ciano Energia */
      --brand-secondary: #10b981;  /* Verde Sustent√°vel */
      --brand-gradient: linear-gradient(135deg, #0891b2, #10b981);
      
      /* UI Colors */
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --bg-body: #020617;
      --card-bg: rgba(30, 41, 59, 0.7); /* Efeito vidro */
      --border-color: rgba(148, 163, 184, 0.15);
      --hover-bg: rgba(255, 255, 255, 0.05);
      --danger: #ef4444;

      /* Dimens√µes */
      --radius-lg: 20px;
      --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.5);
    }

    [data-theme="light"] {
      --text-main: #0f172a;
      --text-muted: #64748b;
      --bg-body: #f0f9ff;
      --card-bg: rgba(255, 255, 255, 0.85);
      --border-color: rgba(148, 163, 184, 0.2);
      --hover-bg: rgba(15, 23, 42, 0.05);
    }

    /* =========================================
       2. RESET & BASE
       ========================================= */
    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0; font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      /* Gradiente de fundo sutil */
      background-image: 
        radial-gradient(circle at 15% 10%, rgba(8, 145, 178, 0.15), transparent 40%),
        radial-gradient(circle at 85% 90%, rgba(16, 185, 129, 0.1), transparent 40%);
      color: var(--text-main);
      min-height: 100vh; overflow-x: hidden; line-height: 1.5;
    }

    h1, h2, h3, .card-title { font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--text-main); margin: 0; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.3); border-radius: 4px; }

    .shell { max-width: 1280px; margin: 0 auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; }

    /* =========================================
       3. COMPONENTES UI
       ========================================= */
    /* Header Glass */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; background: var(--card-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-color); border-radius: 999px;
      box-shadow: var(--shadow-soft); position: sticky; top: 20px; z-index: 100;
      transition: all 0.3s ease;
    }
    @media(max-width: 980px) { header { flex-wrap: wrap; justify-content: center; gap: 15px; border-radius: 20px; } }

    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-icon {
      width: 42px; height: 42px; border-radius: 50%;
      background: var(--brand-gradient);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; color: white; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
    }
    .brand-text h1 { font-size: 18px; letter-spacing: -0.5px; }
    .brand-text span { font-size: 12px; color: var(--text-muted); font-weight: 500; }

    /* Bot√µes */
    .btn {
      border: none; border-radius: 99px; padding: 10px 20px;
      font-size: 13px; font-weight: 600; cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s ease;
    }
    .btn-primary { background: var(--brand-gradient); color: white; box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(8, 145, 178, 0.5); }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); }
    .btn-ghost:hover { background: var(--hover-bg); color: var(--text-main); border-color: var(--text-muted); }
    .btn-icon { width: 36px; height: 36px; padding: 0; justify-content: center; }

    input, select {
      background: rgba(15, 23, 42, 0.3); border: 1px solid var(--border-color);
      color: var(--text-main); padding: 8px 12px; border-radius: 8px; font-size: 13px;
      transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--brand-primary); }

    /* Nav Tabs */
    .nav-tabs { background: rgba(0,0,0,0.2); padding: 5px; border-radius: 99px; display: flex; gap: 4px; overflow-x: auto; }
    .nav-tab {
      background: transparent; border: none; color: var(--text-muted);
      padding: 8px 16px; border-radius: 99px; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .nav-tab:hover { color: var(--text-main); }
    .nav-tab[data-active="true"] { background: var(--brand-dark); color: var(--brand-primary); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    [data-theme="light"] .nav-tab[data-active="true"] { background: white; }

    /* =========================================
       4. LAYOUT DE P√ÅGINAS
       ========================================= */
    .page { display: none !important; opacity: 0; transform: translateY(10px); transition: opacity 0.4s, transform 0.4s; }
    .page.active { opacity: 1; transform: translateY(0); }
    
    .page.page-grid.active { display: grid !important; grid-template-columns: 2.2fr 1fr; gap: 24px; align-items: flex-start; }
    .page.page-full.active { display: flex !important; flex-direction: column; gap: 24px; }
    
    @media(max-width: 980px) { .page.page-grid.active { grid-template-columns: 1fr !important; } }

    /* Cards */
    .card {
      background: var(--card-bg); border: 1px solid var(--border-color);
      border-radius: var(--radius-lg); padding: 24px; backdrop-filter: blur(10px);
      box-shadow: var(--shadow-soft);
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-size: 16px; letter-spacing: 0.02em; }
    .card-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .pill-count { background: rgba(8, 145, 178, 0.15); color: var(--brand-primary); padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 600; }

    /* List Items */
    .person-row {
      display: flex; align-items: center; gap: 14px; padding: 12px;
      border-radius: 12px; border-bottom: 1px solid var(--border-color); transition: background 0.2s;
    }
    .person-row:last-child { border-bottom: none; }
    .person-row:hover { background: var(--hover-bg); }
    .avatar {
      width: 40px; height: 40px; border-radius: 12px;
      background: linear-gradient(135deg, #1e293b, #334155); color: var(--text-main);
      display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;
    }
    .person-info h4 { margin: 0; font-size: 14px; font-weight: 500; }
    .person-info p { margin: 0; font-size: 12px; color: var(--text-muted); }
    .tag-days { font-size: 11px; font-weight: 600; color: var(--brand-secondary); background: rgba(16, 185, 129, 0.1); padding: 2px 8px; border-radius: 6px; }

    /* Tabela */
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th { text-align: left; color: var(--text-muted); font-size: 11px; text-transform: uppercase; padding: 12px 8px; border-bottom: 1px solid var(--border-color); }
    td { padding: 12px 8px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
    tr:hover td { background: var(--hover-bg); }

    /* Utilit√°rios */
    .admin-only { display: none; }
    #toast {
      position: fixed; bottom: 30px; right: 30px; background: var(--brand-primary); color: white;
      padding: 12px 24px; border-radius: 99px; box-shadow: 0 10px 30px rgba(8, 145, 178, 0.4);
      font-weight: 500; opacity: 0; transform: translateY(20px); transition: all 0.3s; z-index: 999;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    dialog { border: none; background: transparent; padding: 0; }
    dialog::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
  </style>
</head>

<body data-theme="dark">
  <script src="/firebase-config.js"></script> <canvas id="confetti-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>
  <div id="toast"></div>

  <div class="shell">
    <header>
      <div class="brand">
        <div class="brand-icon"><i class="fa-solid fa-bolt"></i></div>
        <div class="brand-text">
          <h1>Axia Energia</h1>
          <span>Painel de Aniversariantes</span>
        </div>
      </div>

      <nav class="nav-tabs">
        <button class="nav-tab" data-view="home" data-active="true"><i class="fa-solid fa-house"></i> <span>Hoje</span></button>
        <button class="nav-tab" data-view="calendar"><i class="fa-regular fa-calendar"></i> <span>Calend√°rio</span></button>
        <button class="nav-tab" data-view="list"><i class="fa-solid fa-list-ul"></i> <span>Lista</span></button>
        <button class="nav-tab" data-view="future"><i class="fa-solid fa-clock-rotate-left"></i> <span>Futuros</span></button>
        <button class="nav-tab" data-view="charts"><i class="fa-solid fa-chart-pie"></i> <span>Gr√°ficos</span></button>
      </nav>

      <div style="display:flex; gap:8px;">
        <button id="theme-toggle" class="btn btn-ghost btn-icon"><i class="fa-solid fa-moon"></i></button>
        <button id="celebrate-btn" class="btn btn-primary"><i class="fa-solid fa-gift"></i> Celebrar</button>
        <button id="auth-btn" class="btn btn-ghost">Login</button>
      </div>
    </header>

    <main>
      <section id="view-home" class="page page-grid active">
        <div class="card">
          <div class="card-header">
            <div><h2 class="card-title">Vis√£o Geral</h2><p class="card-sub">Aniversariantes do dia</p></div>
            <span class="pill-count" id="today-count">0</span>
          </div>
          <div id="today-content" style="min-height: 80px; display:flex; align-items:center; color:var(--text-muted);">Carregando...</div>
          <div style="margin-top: 32px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
              <h3 class="card-title" style="font-size:14px;">Pr√≥ximos 5 dias</h3>
            </div>
            <div id="home-upcoming" style="display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>
        <aside class="card">
          <div class="card-header"><h3 class="card-title">Status</h3></div>
          <div style="display:flex; flex-direction:column; gap:12px; font-size:13px; color:var(--text-muted);">
            <div style="display:flex; justify-content:space-between;"><span>Tema:</span><strong style="color:var(--text-main)" id="current-theme">Dark</strong></div>
            <div style="display:flex; justify-content:space-between;"><span>Cadastros:</span><strong style="color:var(--brand-primary)" id="total-records">0</strong></div>
          </div>
          <div style="margin-top:20px; padding:12px; background:rgba(8, 145, 178, 0.1); border-radius:12px; font-size:12px; color:var(--brand-primary);">
            <i class="fa-regular fa-lightbulb"></i> Dica: Pressione <strong>"C"</strong> para festa!
          </div>
        </aside>
      </section>

      <section id="view-calendar" class="page page-grid">
        <div class="card">
          <div class="card-header">
            <div><h2 class="card-title">Calend√°rio</h2><p class="card-sub" id="calendar-month-label">M√™s atual</p></div>
          </div>
          <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;"></div>
        </div>
        <aside class="card">
          <div class="card-header"><h3 class="card-title">Resumo</h3></div>
          <p class="card-sub" id="calendar-summary">Calculando...</p>
        </aside>
      </section>

      <section id="view-list" class="page page-grid">
        <div class="card">
          <div class="card-header">
            <div><h2 class="card-title">Colaboradores</h2><p class="card-sub">Gest√£o de dados</p></div>
            <div style="display:flex; gap:8px;">
              <input type="text" id="search-input" placeholder="Buscar..." style="width:140px;">
              <select id="month-filter" style="width:100px;">
                <option value="all">Todos</option>
                <option value="1">Jan</option><option value="2">Fev</option><option value="3">Mar</option>
                <option value="4">Abr</option><option value="5">Mai</option><option value="6">Jun</option>
                <option value="7">Jul</option><option value="8">Ago</option><option value="9">Set</option>
                <option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option>
              </select>
              <button id="add-btn" class="btn btn-primary btn-icon admin-only"><i class="fa-solid fa-plus"></i></button>
            </div>
          </div>
          <div id="list-wrapper"></div>
          <div style="text-align:center; margin-top:16px;"><button id="load-more" class="btn btn-ghost">Carregar mais</button></div>
        </div>
        <aside class="card">
          <div class="card-header"><h3 class="card-title">Admin</h3></div>
          <div style="display:flex; flex-direction:column; gap:12px;">
            <p style="font-size:12px; color:var(--text-muted);">Importa√ß√£o (CSV)</p>
            <input type="file" id="csv-file" accept=".csv" class="admin-only" style="font-size:11px;">
            <div style="display:flex; gap:8px;">
              <button id="import-sample" class="btn btn-ghost admin-only" style="flex:1; font-size:11px;">Exemplo</button>
              <button id="export-csv" class="btn btn-ghost" style="flex:1; font-size:11px;">Exportar</button>
            </div>
          </div>
        </aside>
      </section>

      <section id="view-future" class="page page-full">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Linha do Tempo</h2>
            <div style="display:flex; align-items:center; gap:10px;">
              <input type="number" id="days-ahead" value="30" style="width:70px;">
              <span style="font-size:13px; color:var(--text-muted);">dias</span>
              <button id="refresh-future" class="btn btn-ghost btn-icon"><i class="fa-solid fa-arrows-rotate"></i></button>
            </div>
          </div>
          <div id="future-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:16px;"></div>
        </div>
      </section>

      <section id="view-charts" class="page page-grid">
        <div class="card">
          <div class="card-header"><h2 class="card-title">An√°lise Anual</h2></div>
          <div style="position:relative; height:300px;"><canvas id="chart-monthly"></canvas></div>
        </div>
        <aside class="card">
          <div class="card-header"><h3 class="card-title">Insights</h3></div>
          <div id="charts-summary" style="font-size:14px; line-height:1.6; color:var(--text-muted);">...</div>
        </aside>
      </section>
    </main>
  </div>

  <dialog id="login-modal">
    <div class="card" style="width:360px; border:1px solid var(--brand-primary); box-shadow: 0 20px 50px rgba(0,0,0,0.8);">
      <div style="text-align:center; margin-bottom:20px;">
        <h3 style="font-size:18px;">Acesso Admin</h3>
        <p style="font-size:12px; color:var(--text-muted);">√Årea restrita</p>
      </div>
      <form id="login-form" style="display:flex; flex-direction:column; gap:12px;">
        <input type="email" id="login-email" placeholder="E-mail" required>
        <input type="password" id="login-pass" placeholder="Senha" required>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button type="button" id="close-login" class="btn btn-ghost" style="flex:1;">Cancelar</button>
          <button type="submit" class="btn btn-primary" style="flex:1;">Entrar</button>
        </div>
      </form>
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    /* =========================================
       L√ìGICA PRINCIPAL (Full Features)
       ========================================= */
    let dataArr = [];
    let isAdmin = false;
    let chartInstance = null;
    let pageOffset = 0;
    const PAGE_SIZE = 25;
    
    // Firebase State
    let firebaseInitialized = false;
    let firebaseDb = null;
    let firebaseAuth = null;

    // --- Helpers ---
    const toast = (msg, err=false) => {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.background = err ? 'var(--danger)' : 'var(--brand-primary)';
      t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000);
    };
    const uid = () => 'id-' + Math.random().toString(36).substr(2, 9);
    
    // --- Renderiza√ß√£o ---
    function renderHome() {
      const now = new Date();
      const todayMatches = dataArr.filter(p => p.dia === now.getDate() && p.mes === (now.getMonth() + 1));
      document.getElementById('today-count').textContent = todayMatches.length;
      document.getElementById('total-records').textContent = dataArr.length;
      
      const content = document.getElementById('today-content');
      if(todayMatches.length > 0) {
        content.innerHTML = todayMatches.map(p => `
          <div class="person-row" style="width:100%; border:1px solid var(--brand-primary); background:rgba(8,145,178,0.1);">
            <div class="avatar" style="background:var(--brand-primary)">${p.nome.charAt(0)}</div>
            <div class="person-info"><h4>${p.nome}</h4><p>${p.setor} ‚Ä¢ Hoje!</p></div>
            <i class="fa-solid fa-cake-candles" style="margin-left:auto; color:var(--brand-secondary);"></i>
          </div>`).join('');
        if(!window.celebratedToday) { celebrateNow(true); window.celebratedToday = true; }
      } else {
        content.innerHTML = '<span style="font-size:14px;">Nenhum anivers√°rio hoje.</span>';
      }

      // Pr√≥ximos
      const upcoming = getUpcoming(5);
      const upContainer = document.getElementById('home-upcoming');
      upContainer.innerHTML = upcoming.length ? upcoming.map(p => `
        <div class="person-row">
          <div class="avatar" style="width:32px; height:32px; font-size:12px;">${p.nome.charAt(0)}</div>
          <div class="person-info"><h4>${p.nome}</h4><p>${p.dia}/${p.mes}</p></div>
          <div class="tag-days" style="margin-left:auto">${p.diffDays} dias</div>
        </div>`).join('') : '<span style="font-size:13px; color:var(--text-muted)">Sem anivers√°rios pr√≥ximos.</span>';
    }

    function renderList(reset = false) {
      if(reset) pageOffset = 0;
      const wrapper = document.getElementById('list-wrapper');
      const search = document.getElementById('search-input').value.toLowerCase();
      const filterM = document.getElementById('month-filter').value;
      
      let filtered = dataArr.filter(p => {
        const matchName = p.nome.toLowerCase().includes(search) || (p.setor || '').toLowerCase().includes(search);
        const matchMonth = filterM === 'all' || p.mes == filterM;
        return matchName && matchMonth;
      });

      filtered.sort((a,b) => (a.mes - b.mes) || (a.dia - b.dia));
      const paged = filtered.slice(0, (pageOffset + 1) * PAGE_SIZE);

      if(paged.length === 0) {
        wrapper.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">Nenhum registro.</div>';
        document.getElementById('load-more').style.display = 'none';
        return;
      }

      let html = `<table><thead><tr><th>Nome</th><th>Setor</th><th>Data</th><th style="text-align:right">A√ß√µes</th></tr></thead><tbody>`;
      html += paged.map(p => `
        <tr>
          <td style="font-weight:500">${p.nome}</td>
          <td style="color:var(--text-muted)">${p.setor || '-'}</td>
          <td>${String(p.dia).padStart(2,'0')}/${String(p.mes).padStart(2,'0')}</td>
          <td style="text-align:right;">
             ${isAdmin ? 
              `<button class="btn btn-ghost btn-icon" style="width:28px;height:28px;" onclick="editRecord('${p.id}')" title="Editar"><i class="fa-solid fa-pen" style="font-size:12px"></i></button>
               <button class="btn btn-ghost btn-icon" style="width:28px;height:28px; color:var(--danger);" onclick="deleteRecord('${p.id}')" title="Excluir"><i class="fa-solid fa-trash" style="font-size:12px"></i></button>` 
              : `<i class="fa-solid fa-lock" style="font-size:10px; opacity:0.3"></i>`}
          </td>
        </tr>`).join('');
      html += `</tbody></table>`;
      wrapper.innerHTML = html;
      document.getElementById('load-more').style.display = (filtered.length > paged.length) ? 'inline-block' : 'none';
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      const now = new Date();
      const m = now.getMonth();
      const y = now.getFullYear();
      const mNames = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      document.getElementById('calendar-month-label').textContent = `${mNames[m]} / ${y}`;
      
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      let html = '';
      let count = 0;
      for(let d=1; d<=daysInMonth; d++) {
        const matches = dataArr.filter(p => p.dia === d && p.mes === (m+1));
        count += matches.length;
        let badges = matches.map(p => `<div style="font-size:10px; background:rgba(8,145,178,0.2); color:#67e8f9; padding:2px 4px; border-radius:4px; margin-top:2px; white-space:nowrap; overflow:hidden;">${p.nome.split(' ')[0]}</div>`).join('');
        html += `<div style="min-height:90px; background:rgba(255,255,255,0.02); border:1px solid var(--border-color); border-radius:12px; padding:8px;"><span style="font-size:11px; color:var(--text-muted); float:right;">${d}</span><div style="margin-top:18px;">${badges}</div></div>`;
      }
      grid.innerHTML = html;
      document.getElementById('calendar-summary').innerHTML = `Total: <strong>${count}</strong> aniversariantes em ${mNames[m]}.`;
    }

    function renderFuture() {
      const days = parseInt(document.getElementById('days-ahead').value) || 30;
      const list = getUpcoming(days);
      const container = document.getElementById('future-list');
      container.innerHTML = list.length ? list.map(p => `
        <div class="person-row" style="background:var(--hover-bg); border:1px solid var(--border-color);">
          <div class="avatar">${p.nome.charAt(0)}</div>
          <div class="person-info" style="flex:1"><h4>${p.nome}</h4><p>${p.setor}</p></div>
          <div style="text-align:right"><div style="font-weight:600; color:var(--brand-primary);">${p.dia}/${p.mes}</div><div class="tag-days">${p.diffDays} dias</div></div>
        </div>`).join('') : '<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--text-muted);">Nenhum neste per√≠odo.</div>';
    }

    function renderCharts() {
      const ctx = document.getElementById('chart-monthly');
      if(!ctx) return;
      const counts = Array(12).fill(0);
      dataArr.forEach(p => { if(p.mes >= 1 && p.mes <= 12) counts[p.mes - 1]++; });
      if(chartInstance) chartInstance.destroy();
      const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, '#0891b2'); gradient.addColorStop(1, '#10b981');
      
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
          datasets: [{ label: 'Qtd', data: counts, backgroundColor: gradient, borderRadius: 6 }]
        },
        options: {
          responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
          scales: { y: { beginAtZero:true, grid:{color:'rgba(148,163,184,0.1)'} }, x: { grid:{display:false} } }
        }
      });
      const max = Math.max(...counts);
      document.getElementById('charts-summary').innerHTML = `Maior pico: <strong>${['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][counts.indexOf(max)]}</strong> (${max} pessoas).`;
    }

    // --- L√≥gica de Dados (Firebase + Local) ---
    function getUpcoming(days) {
      const today = new Date(); today.setHours(0,0,0,0);
      return dataArr.map(p => {
        let nextDate = new Date(today.getFullYear(), p.mes - 1, p.dia);
        if (nextDate < today) nextDate.setFullYear(today.getFullYear() + 1);
        const diffDays = Math.ceil((nextDate - today) / (86400000));
        return { ...p, diffDays };
      }).filter(p => p.diffDays >= 0 && p.diffDays <= days).sort((a,b) => a.diffDays - b.diffDays);
    }

    window.editRecord = async (id) => {
      const rec = dataArr.find(p => p.id === id);
      if(!rec) return;
      const novoNome = prompt('Nome:', rec.nome); if(novoNome === null) return;
      const novoSetor = prompt('Setor:', rec.setor);
      const novoDia = prompt('Dia:', rec.dia);
      const novoMes = prompt('M√™s:', rec.mes);
      if(novoNome && novoDia && novoMes) {
        if(firebaseInitialized && isAdmin) {
           await firebaseDb.collection('aniversariantes').doc(id).set({ nome: novoNome, setor: novoSetor || '', dia: Number(novoDia), mes: Number(novoMes) }, { merge: true });
           toast('Atualizado!');
        } else {
           rec.nome = novoNome; rec.setor = novoSetor; rec.dia = Number(novoDia); rec.mes = Number(novoMes);
           renderList(true); toast('Atualizado (Local)');
        }
      } else toast('Dados inv√°lidos.', true);
    };

    window.deleteRecord = async (id) => {
      if(!confirm('Excluir este registro?')) return;
      if(firebaseInitialized && firebaseDb) {
        try { await firebaseDb.collection('aniversariantes').doc(id).delete(); toast('Removido.'); }
        catch(e) { toast('Erro.', true); }
      } else {
        dataArr = dataArr.filter(x => x.id !== id); renderList(true); toast('Removido (Local)');
      }
    };

    function celebrateNow(auto=false) {
      const c = document.getElementById('confetti-canvas');
      const myConfetti = confetti.create(c, { resize: true });
      myConfetti({ particleCount: auto?100:200, spread: 70, origin: { y: 0.6 }, colors: ['#0891b2', '#10b981', '#f59e0b'] });
      if(!auto) toast('üéâ Parab√©ns!');
    }

    // --- Inicializa√ß√£o ---
    async function loadScript(src) { return new Promise((r, j) => { const s = document.createElement('script'); s.src = src; s.onload = r; s.onerror = j; document.head.appendChild(s); }); }

    async function initFirebase() {
      if(!window.__firebase_config) return false;
      try {
        await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js');
        firebase.initializeApp(window.__firebase_config);
        firebaseDb = firebase.firestore(); firebaseAuth = firebase.auth();
        firebaseInitialized = true;

        firebaseAuth.onAuthStateChanged(async user => {
          if(user) { const t = await user.getIdTokenResult(); isAdmin = !!t.claims.admin; document.getElementById('auth-btn').textContent = 'Sair'; }
          else { isAdmin = false; document.getElementById('auth-btn').textContent = 'Login'; }
          toggleAdminUI(); renderList(true);
        });

        firebaseDb.collection('aniversariantes').onSnapshot(snap => {
          dataArr = snap.docs.map(doc => { const d = doc.data(); return { id: doc.id, nome: d.nome||'', setor: (d.setor||'').toUpperCase(), dia: Number(d.dia), mes: Number(d.mes) }; });
          // Remove duplicatas
          const unique = new Map(); dataArr.forEach(i => unique.set(i.nome+i.dia+i.mes, i)); dataArr = Array.from(unique.values());
          const active = document.querySelector('.nav-tab[data-active="true"]'); if(active) active.click();
        });
        return true;
      } catch(e) { console.error(e); return false; }
    }

    function toggleAdminUI() { document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? (el.tagName === 'BUTTON' ? 'inline-flex' : 'block') : 'none'); }

    document.addEventListener('DOMContentLoaded', async () => {
      // Tema
      const theme = localStorage.getItem('axia_theme') || 'dark';
      document.body.dataset.theme = theme;
      document.getElementById('current-theme').textContent = theme === 'dark' ? 'Dark Mode' : 'Light Mode';
      document.getElementById('theme-toggle').innerHTML = theme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';

      // Dados Demo se Firebase falhar
      const demoData = [ {id:'1', nome:'Evandro Silva', setor:'OPS', dia:14, mes:12}, {id:'2', nome:'Erick Ketes', setor:'TI', dia:1, mes:12} ];
      const fbOk = await initFirebase();
      if(!fbOk) { dataArr = demoData; console.log("Modo Demo"); document.querySelector('.nav-tab[data-view="home"]').click(); }

      // Listeners
      document.getElementById('theme-toggle').addEventListener('click', () => {
        const next = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
        document.body.dataset.theme = next; localStorage.setItem('axia_theme', next);
        document.getElementById('current-theme').textContent = next === 'dark' ? 'Dark Mode' : 'Light Mode';
        document.getElementById('theme-toggle').innerHTML = next === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        renderCharts();
      });

      document.querySelectorAll('.nav-tab').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(b => b.setAttribute('data-active', 'false'));
        btn.setAttribute('data-active', 'true');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const target = document.getElementById(`view-${btn.dataset.view}`);
        if(target) target.classList.add('active');
        if(btn.dataset.view === 'home') renderHome();
        if(btn.dataset.view === 'calendar') renderCalendar();
        if(btn.dataset.view === 'list') renderList(true);
        if(btn.dataset.view === 'future') renderFuture();
        if(btn.dataset.view === 'charts') renderCharts();
      }));

      document.getElementById('celebrate-btn').addEventListener('click', () => celebrateNow(false));
      document.getElementById('search-input').addEventListener('input', () => renderList(true));
      document.getElementById('month-filter').addEventListener('change', () => renderList(true));
      document.getElementById('load-more').addEventListener('click', () => { pageOffset++; renderList(); });
      document.getElementById('refresh-future').addEventListener('click', renderFuture);
      
      // Login
      const modal = document.getElementById('login-modal');
      document.getElementById('auth-btn').addEventListener('click', () => { if(firebaseAuth && firebaseAuth.currentUser) firebaseAuth.signOut(); else modal.showModal(); });
      document.getElementById('close-login').addEventListener('click', () => modal.close());
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value;
        if(firebaseAuth) { try { await firebaseAuth.signInWithEmailAndPassword(email, pass); modal.close(); toast('Bem-vindo!'); } catch(e) { toast('Erro login', true); } }
        else { if(email === 'admin' && pass === 'admin') { isAdmin = true; toggleAdminUI(); renderList(true); modal.close(); toast('Admin Demo'); } else toast('Erro', true); }
      });

      // Add & CSV
      document.getElementById('add-btn').addEventListener('click', async () => {
        const nome = prompt('Nome:'); if(!nome) return;
        const setor = prompt('Setor:'); const dia = prompt('Dia:'); const mes = prompt('M√™s:');
        if(nome && dia && mes) {
          if(firebaseInitialized && isAdmin) await firebaseDb.collection('aniversariantes').add({ nome, setor: setor||'', dia: Number(dia), mes: Number(mes) });
          else { dataArr.push({ id: uid(), nome, setor: setor||'', dia: Number(dia), mes: Number(mes) }); renderList(true); toast('Adicionado (Local)'); }
        }
      });

      document.getElementById('csv-file').addEventListener('change', (e) => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = async () => {
          const lines = r.result.split(/\r?\n/).filter(l => l.trim());
          const start = lines[0].toLowerCase().includes('nome') ? 1 : 0;
          let c = 0;
          for(let i=start; i<lines.length; i++) {
            const parts = lines[i].match(/(".*?"|[^,]+)/g);
            if(parts && parts.length >= 3) {
              const cl = (v) => (v||'').replace(/^"|"$/g,'').trim();
              const nome = cl(parts[0]); const setor = cl(parts[1]); const dia = parseInt(cl(parts[2])); const mes = parseInt(cl(parts[3]));
              if(nome && !isNaN(dia) && !isNaN(mes)) {
                if(firebaseInitialized && isAdmin) await firebaseDb.collection('aniversariantes').add({ nome, setor, dia, mes });
                else dataArr.push({ id:uid(), nome, setor, dia, mes });
                c++;
              }
            }
          }
          if(!firebaseInitialized) renderList(true);
          toast(`${c} importados.`); e.target.value = '';
        };
        r.readAsText(f);
      });
      
      document.getElementById('export-csv').addEventListener('click', () => {
         if(!dataArr.length) return toast('Sem dados.', true);
         const csv = "Nome,Setor,Dia,Mes\n" + dataArr.map(p => `"${p.nome}","${p.setor}",${p.dia},${p.mes}`).join('\n');
         const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'aniversariantes.csv';
         document.body.appendChild(a); a.click(); a.remove();
      });
      
      document.addEventListener('keydown', (e) => { if(e.key.toLowerCase() === 'c' && document.activeElement.tagName !== 'INPUT') celebrateNow(false); });
    });
  </script>
</body>
</html>
