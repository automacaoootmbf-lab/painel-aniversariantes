<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Painel de Aniversariantes</title>

Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

Â  Â  <script src="./firebase-config.js"></script>

Â  <style>
Â  Â  :root {
Â  Â  Â  --eletro-blue: #003366;
Â  Â  Â  --eletro-teal: #009a74;
Â  Â  Â  --muted: #6b7280;
Â  Â  Â  --bg-page: #f8fafc;
Â  Â  Â  --card-bg: #ffffff;
Â  Â  Â  --text-color: #0f172a;
Â  Â  Â  --soft-border: #e2e8f0;
Â  Â  Â  --shadow-1: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
Â  Â  Â  --radius: 12px;
Â  Â  }

Â  Â  html.dark {
Â  Â  Â  --muted: #9ca3af;
Â  Â  Â  --bg-page: #111827;
Â  Â  Â  --card-bg: #1f2937;
Â  Â  Â  --text-color: #f9fafb;
Â  Â  Â  --soft-border: #374151;
Â  Â  Â  --shadow-1: 0 4px 6px -1px rgb(255 255 255 / 0.05), 0 2px 4px -2px rgb(255 255 255 / 0.05);
Â  Â  }

Â  Â  html, body {
Â  Â  Â  height: 100%; margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Arial;
Â  Â  Â  background: var(--bg-page); color: var(--text-color); transition: background 0.3s ease, color 0.3s ease;
Â  Â  }
Â  Â  .container { max-width: 1200px; margin: 0 auto; padding: 28px 20px; position: relative; z-index: 10; }
Â  Â  header { display: flex; align-items: center; justify-content: space-between; gap: 18px; padding-bottom: 18px; border-bottom: 1px solid var(--soft-border); margin-bottom: 22px; }
Â  Â  .title-group { display: flex; gap: 12px; align-items: center; }
Â  Â  svg.logo-icon { width: 56px; height: 56px; border-radius: 8px; padding: 6px; background: linear-gradient(135deg, var(--eletro-blue), var(--eletro-teal)); color: white; }
Â  Â  h1 { font-size: 22px; margin: 0; color: var(--text-color); font-weight: 600; }
Â  Â  html.dark h1 { color: var(--eletro-teal); }
Â  Â  .header-actions { display: flex; align-items: center; gap: 1rem; }
Â  Â  #theme-toggle-btn { background: none; border: none; cursor: pointer; color: var(--muted); padding: 4px; display: flex; align-items: center; justify-content: center; }
Â  Â  #theme-toggle-btn svg { width: 22px; height: 22px; }
Â  Â  .sun-icon { display: none; }
Â  Â  .moon-icon { display: block; }
Â  Â  html.dark .sun-icon { display: block; }
Â  Â  html.dark .moon-icon { display: none; }
Â  Â  #tabs-container { position: relative; display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; border-bottom: 1px solid var(--soft-border); }
Â  Â  #active-tab-underline { position: absolute; bottom: -1px; height: 2px; background-color: var(--eletro-blue); transition: all 0.18s cubic-bezier(0.4, 0, 0.2, 1); left:0; width:0; }
Â  Â  html.dark #active-tab-underline { background-color: var(--eletro-teal); }
Â  Â  .tab-btn { background: transparent; border: none; padding: 10px 14px; color: var(--muted); font-weight: 600; cursor: pointer; transition: color 0.12s ease-in-out; z-index: 1; }
Â  Â  .tab-btn:hover { color: var(--text-color); }
Â  Â  .tab-btn.active { color: var(--eletro-blue); }
Â  Â  html.dark .tab-btn.active { color: var(--eletro-teal); }
Â  Â  .tab-panel { margin-top: 12px; }
Â  Â  .bg-card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow-1); border: 1px solid var(--soft-border); transition: background 0.3s ease, border-color 0.3s ease; }
Â  Â  #today-panel-grid, #upcoming-panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
Â  Â  .birthday-card { display: flex; align-items: center; gap: 16px; padding: 16px; }
Â  Â  .avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 18px; flex-shrink: 0; }
Â  Â  .card-info .name { font-weight: 600; display: block; }
Â  Â  .card-info .sector, .card-info .date { font-size: 14px; color: var(--muted); }
Â  Â  .table-avatar-cell { display: flex; align-items: center; gap: 12px; }
Â  Â  table { border-collapse: collapse; width: 100%; }
Â  Â  thead th { background: #f8fafc; padding: 14px; text-align: left; font-size: 14px; color: #475569; cursor: pointer; user-select: none; }
Â  Â  thead th:hover { background: #f1f5f9; }
Â  Â  html.dark thead th { background: #374151; color: #d1d5db; }
Â  Â  html.dark thead th:hover { background: #4b5563; }
Â  Â  tbody tr { border-bottom: 1px solid var(--soft-border); }
Â  Â  tbody tr:last-child { border-bottom: none; }
Â  Â  tbody td { padding: 12px 14px; }
Â  Â  .search-input { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--soft-border); background-color: var(--bg-page); margin-bottom: 16px; color: var(--text-color); }
Â  Â  .search-input:focus { outline: none; border-color: var(--eletro-blue); box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.12); }
Â  Â  html.dark .search-input:focus { border-color: var(--eletro-teal); box-shadow: 0 0 0 2px rgba(0, 154, 116, 0.12); }
Â  Â  #calendar-grid .day-cell { background-color: rgba(0, 154, 116, 0.05); cursor: pointer; }
Â  Â  #calendar-grid .day-cell[data-count="1"] { background-color: rgba(0, 154, 116, 0.2); }
Â  Â  #calendar-grid .day-cell[data-count="2"] { background-color: rgba(0, 154, 116, 0.5); }
Â  Â  #calendar-grid .day-cell[data-count="3"] { background-color: rgba(0, 154, 116, 0.8); }
Â  Â  .admin-only { display: none !important; }
Â  Â  body.admin-mode .admin-only { display: block !important; }
Â  Â  .admin-only-table-cell { display: none !important; }
Â  Â  body.admin-mode .admin-only-table-cell { display: table-cell !important; }
Â  Â  .hidden { display: none !important; }
Â  Â  #notification-toast { position: fixed; right: 20px; bottom: 20px; padding: 12px 16px; border-radius: 8px; color: white; opacity: 0; transform: translateY(10px); transition: all .25s ease; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); z-index: 1000000; pointer-events: auto; }
Â  Â  #notification-toast button { margin-left:8px; background:transparent; border:1px solid rgba(255,255,255,0.2); color:inherit; padding:6px 8px; border-radius:6px; cursor:pointer; }
Â  Â  #fullscreen-celebration { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; overflow: hidden; z-index: 999999; }
Â  Â  canvas#confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
Â  Â  .balloon { position: absolute; bottom: -120px; width: 60px; height: 80px; border-radius: 80% 80% 70% 70%; opacity: 0.95; animation: rise 10s ease-in forwards; z-index: 1000; pointer-events: none; }
Â  Â  .balloon::before { content: ''; position: absolute; width: 1px; height: 50px; background-color: rgba(0, 0, 0, 0.4); bottom: -50px; left: 50%; transform: translateX(-50%); }
Â  Â  .balloon::after { content: ''; position: absolute; border-style: solid; border-width: 0 8px 12px 8px; border-color: transparent transparent inherit transparent; bottom: -10px; left: calc(50% - 8px); }
Â  Â  @keyframes rise { 0% { transform: translateY(0) scale(0.8) rotate(5deg); } 100% { transform: translateY(-120vh) scale(1.2) rotate(-5deg); opacity: 0; } }
Â  Â  #calendar-tooltip { position: absolute; display: none; padding: 8px 12px; background-color: var(--card-bg); border: 1px solid var(--soft-border); border-radius: 8px; box-shadow: var(--shadow-1); z-index: 10000; pointer-events: none; font-size: 14px; max-width: 280px; transition: opacity 0.2s; }
Â  Â  #calendar-tooltip ul { margin: 0; padding: 0; list-style: none; } #calendar-tooltip li { white-space: nowrap; margin-bottom: 4px; } #calendar-tooltip li:last-child { margin-bottom: 0; } #calendar-tooltip .name { font-weight: 600; } #calendar-tooltip .sector { color: var(--muted); }
Â  Â  #loading-indicator { display: flex; justify-content: center; align-items: center; padding: 40px; font-weight: 500; color:var(--muted); }
Â  Â  /* Modal Styles */
Â  Â  #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; }
Â  Â  #modal-content { background: var(--card-bg); padding: 24px; border-radius: var(--radius); width: 90%; max-width: 400px; }
Â  Â  #modal-content h2 { margin-top: 0; }
Â  Â  #modal-form .form-group { margin-bottom: 16px; }
Â  Â  #modal-form label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
Â  Â  #modal-form input, #modal-form select { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--soft-border); background-color: var(--bg-page); color: var(--text-color); }
Â  Â  #modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
Â  Â  #modal-actions button { padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
Â  Â  #modal-save-btn { background: var(--eletro-blue); color: white; border: none; }
Â  Â  #modal-cancel-btn { background: transparent; border: 1px solid var(--soft-border); color: var(--text-color); }

Â  Â  /* Responsive Table to Cards */
Â  Â  @media (max-width: 768px) {
Â  Â  Â  table thead { display: none; }
Â  Â  Â  table tbody, table tr, table td { display: block; width: 100%; }
Â  Â  Â  table tr { border: 1px solid var(--soft-border); border-radius: var(--radius); margin-bottom: 16px; }
Â  Â  Â  table td { border: none; padding-left: 16px; padding-right: 16px; display: flex; justify-content: space-between; align-items: center; }
Â  Â  Â  table td:first-child { padding-top: 16px; }
Â  Â  Â  table td:last-child { padding-bottom: 16px; }
Â  Â  Â  table td::before { content: attr(data-label); font-weight: 600; padding-right: 12px; }
Â  Â  Â  .table-avatar-cell { flex-direction: column; align-items: flex-start !important; gap: 4px !important; }
Â  Â  Â  .table-avatar-cell .avatar { display: none; } /* Oculta avatar na vista de cartÃ£o para simplicidade */
Â  Â  Â  table td[data-label="AÃ§Ãµes"]::before { display: none; }
Â  Â  Â  table td[data-label="AÃ§Ãµes"] { justify-content: flex-start; gap: 8px; }
Â  Â  }

Â  Â  /* respect reduced motion */
Â  Â  @media (prefers-reduced-motion: reduce) {
Â  Â  Â  .balloon, canvas#confetti-canvas { display:none !important; }
Â  Â  Â  * { animation-duration: 0s !important; transition-duration: 0s !important; }
Â  Â  }
Â  </style>
</head>

<body>
Â  <div id="fullscreen-celebration" aria-hidden="true"><canvas id="confetti-canvas" aria-hidden="true"></canvas></div>
Â  <div id="calendar-tooltip" role="tooltip" aria-hidden="true"></div>
Â Â 
Â  <div class="container">
Â  Â  <header>
Â  Â  Â  <div class="title-group">
Â  Â  Â  Â  <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.975M15 10a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <h1>Painel de Aniversariantes</h1>
Â  Â  Â  Â  Â  <p style="margin:0; color:var(--muted); font-size:13px">Celebre com a nossa equipe.</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="header-actions">
Â  Â  Â  Â  Â  <button id="theme-toggle-btn" aria-label="Toggle dark mode">
Â  Â  Â  Â  Â  Â  <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
Â  Â  Â  Â  Â  Â  <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button id="auth-btn" class="tertiary text-sm">ğŸ”’ Acesso Restrito</button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div id="tabs-container">
Â  Â  Â  <button data-tab="today" class="tab-btn">ğŸ‚ Hoje</button>
Â  Â  Â  <button data-tab="upcoming" class="tab-btn">ğŸ‰ PrÃ³ximos</button>
Â  Â  Â  <button data-tab="calendar" class="tab-btn">ğŸ—“ï¸ CalendÃ¡rio</button>
Â  Â  Â  <button data-tab="list" class="tab-btn">ğŸ“‹ Lista Completa</button>
Â  Â  Â  <button data-tab="chart" class="tab-btn admin-only">ğŸ“Š GestÃ£o</button>
Â  Â  Â  <div id="active-tab-underline" aria-hidden="true"></div>
Â  Â  </div>

Â  Â  <main id="tab-panels-container">
Â  Â  Â  <div id="loading-indicator" role="status" aria-live="polite">
Â  Â  Â  Â  Â  <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H8v-2h3V6l4 4-4 4z"></path></svg>
Â  Â  Â  Â  Â  Carregando dados...
Â  Â  Â  </div>
Â  Â  Â  <div id="content-wrapper" class="hidden" aria-hidden="true">
Â  Â  Â  Â  <div id="today-panel" class="tab-panel"></div>
Â  Â  Â  Â  <div id="upcoming-panel" class="tab-panel hidden"></div>
Â  Â  Â  Â  <div id="calendar-panel" class="tab-panel hidden">
Â  Â  Â  Â  Â  <div class="bg-card p-4 rounded-lg">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
Â  Â  Â  Â  Â  Â  Â  <h2 style="margin:0; font-size:18px">CalendÃ¡rio Heatmap</h2>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="prev-month-btn" style="margin-right:6px">â—€</button>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="calendar-month-year" aria-live="polite"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="next-month-btn" style="margin-left:6px">â–¶</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="calendar-grid" class="grid grid-cols-7 gap-2" aria-hidden="false"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="list-panel" class="tab-panel hidden">
Â  Â  Â  Â  Â  <div class="bg-card p-4 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; flex-wrap: wrap; justify-content:space-between; align-items:center; margin-bottom:12px; gap: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="margin:0; font-size:18px">Lista Completa</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="admin-only" style="display:flex; gap: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="import-csv-btn" style="background:var(--eletro-teal); color:#fff; padding:8px 12px; border-radius:8px">Importar CSV</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-csv-btn" style="background:var(--eletro-teal); color:#fff; padding:8px 12px; border-radius:8px">Exportar CSV</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="add-person-btn" style="background:var(--eletro-blue); color:#fff; padding:8px 12px; border-radius:8px">+ Adicionar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="csv-file-input" class="hidden" accept=".csv,text/csv">
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <input type="search" id="search-input" placeholder="Buscar por nome ou setor..." class="search-input" aria-label="Buscar por nome ou setor">
Â  Â  Â  Â  Â  Â  Â  <div style="overflow:auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th data-sort="name">Nome <span></span></th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th data-sort="sector">Setor <span></span></th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th data-sort="date">Data <span></span></th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="admin-only-table-cell" data-sort="none">AÃ§Ãµes</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="birthday-table-body" aria-live="polite"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="no-results" class="hidden" style="padding:18px; color:var(--muted)">Nenhum resultado encontrado.</div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="chart-panel" class="tab-panel hidden admin-only">
Â  Â  Â  Â  Â  <div class="bg-card p-6 rounded-lg">
Â  Â  Â  Â  Â  Â  <h2 style="margin:0 0 18px 0; font-size:20px; font-weight: 600;">AnÃ¡lises de Dados</h2>
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
Â  Â  Â  Â  Â  Â  Â  <div class="lg:col-span-3 bg-gray-50/50 dark:bg-gray-800/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700"><canvas id="birthday-chart"></canvas></div>
Â  Â  Â  Â  Â  Â  Â  <div class="lg:col-span-2 bg-gray-50/50 dark:bg-gray-800/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700"><canvas id="sector-chart"></canvas></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </main>
Â  </div>

Â  Â  <div id="notification-toast" role="status" aria-live="polite"></div>

Â  <div id="modal-overlay" class="hidden" aria-hidden="true">
Â  Â  <div id="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
Â  Â  Â  <h2 id="modal-title">Adicionar Aniversariante</h2>
Â  Â  Â  <form id="modal-form">
Â  Â  Â  Â  <input type="hidden" id="modal-person-id">
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label for="person-name">Nome</label>
Â  Â  Â  Â  Â  <input type="text" id="person-name" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label for="person-sector">Setor</label>
Â  Â  Â  Â  Â  <input type="text" id="person-sector" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="display: flex; gap: 16px;">
Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  <label for="person-day">Dia</label>
Â  Â  Â  Â  Â  Â  <input type="number" id="person-day" required min="1" max="31">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  <label for="person-month">MÃªs</label>
Â  Â  Â  Â  Â  Â  <input type="number" id="person-month" required min="1" max="12">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="modal-actions">
Â  Â  Â  Â  Â  <button type="button" id="modal-cancel-btn">Cancelar</button>
Â  Â  Â  Â  Â  <button type="submit" id="modal-save-btn">Salvar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </form>
Â  Â  </div>
Â  </div>

Â  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

Â  Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
Â  Â  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
Â  Â  import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  // DOM elements
Â  Â  Â  const authBtn = document.getElementById('auth-btn');
Â  Â  Â  const tabsContainer = document.getElementById('tabs-container');
Â  Â  Â  const activeTabUnderline = document.getElementById('active-tab-underline');
Â  Â  Â  const todayPanel = document.getElementById('today-panel');
Â  Â  Â  const upcomingPanel = document.getElementById('upcoming-panel');
Â  Â  Â  const calendarGrid = document.getElementById('calendar-grid');
Â  Â  Â  const calendarMonthYear = document.getElementById('calendar-month-year');
Â  Â  Â  const prevMonthBtn = document.getElementById('prev-month-btn');
Â  Â  Â  const nextMonthBtn = document.getElementById('next-month-btn');
Â  Â  Â  const tableBody = document.getElementById('birthday-table-body');
Â  Â  Â  const searchInput = document.getElementById('search-input');
Â  Â  Â  const noResults = document.getElementById('no-results');
Â  Â  Â  const notificationToast = document.getElementById('notification-toast');
Â  Â  Â  const themeToggleBtn = document.getElementById('theme-toggle-btn');
Â  Â  Â  const confettiCanvas = document.getElementById('confetti-canvas');
Â  Â  Â  const celebrationContainer = document.getElementById('fullscreen-celebration');
Â  Â  Â  const calendarTooltip = document.getElementById('calendar-tooltip');
Â  Â  Â  const loadingIndicator = document.getElementById('loading-indicator');
Â  Â  Â  const contentWrapper = document.getElementById('content-wrapper');

Â  Â  Â  // Modal elements
Â  Â  Â  const modalOverlay = document.getElementById('modal-overlay');
Â  Â  Â  const modalForm = document.getElementById('modal-form');
Â  Â  Â  const modalTitle = document.getElementById('modal-title');
Â  Â  Â  const modalPersonId = document.getElementById('modal-person-id');
Â  Â  Â  const modalCancelBtn = document.getElementById('modal-cancel-btn');
Â  Â  Â  const addPersonBtn = document.getElementById('add-person-btn');
Â  Â  Â  const tableHeader = document.querySelector('#list-panel thead');

Â  Â  Â  // CSV elements
Â  Â  Â  const importCsvBtn = document.getElementById('import-csv-btn');
Â  Â  Â  const exportCsvBtn = document.getElementById('export-csv-btn');
Â  Â  Â  const csvFileInput = document.getElementById('csv-file-input');

Â  Â  Â  // Globals
Â  Â  Â  const monthNames = ["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
Â  Â  Â  const avatarColors = ['#003366','#009a74','#f0b400','#dc2626','#3b82f6','#f43f5e','#a855f7'];
Â  Â  Â  let db = null, auth = null, dbCollection = null, dataUnsub = null;
Â  Â  Â  let birthdayData = [];
Â  Â  Â  let currentDate = new Date();
Â  Â  Â  let isAdmin = false;
Â  Â  Â  let sortConfig = { key: 'date', direction: 'ascending' };
Â  Â  Â  let pendingDeletes = new Map();

Â  Â  Â  // confetti helper (respect prefers-reduced-motion)
Â  Â  Â  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
Â  Â  Â  const confettiCannon = (!prefersReduced && window.confetti) ? confetti.create(confettiCanvas, { resize: true }) : null;

Â  Â  Â  // Helpers
Â  Â  Â  const safeFinallyShowUI = () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  loadingIndicator.classList.add('hidden');
Â  Â  Â  Â  Â  contentWrapper.classList.remove('hidden');
Â  Â  Â  Â  Â  contentWrapper.setAttribute('aria-hidden', 'false');
Â  Â  Â  Â  } catch(e) { console.warn('Erro ao mostrar UI:', e); }
Â  Â  Â  };

Â  Â  Â  // toast with undo support
Â  Â  Â  const showNotification = (msg, isError=false, actions=[]) => {
Â  Â  Â  Â  notificationToast.innerHTML = ''; // clear
Â  Â  Â  Â  notificationToast.style.background = isError ? '#dc2626' : 'linear-gradient(90deg,#003366,#009a74)';
Â  Â  Â  Â  notificationToast.style.opacity = '1';
Â  Â  Â  Â  notificationToast.style.transform = 'translateY(0)';
Â  Â  Â  Â  // create message node safely
Â  Â  Â  Â  const msgNode = document.createElement('div');
Â  Â  Â  Â  msgNode.style.display = 'inline-block';
Â  Â  Â  Â  msgNode.style.marginRight = '8px';
Â  Â  Â  Â  msgNode.textContent = msg;
Â  Â  Â  Â  notificationToast.appendChild(msgNode);
Â  Â  Â  Â  // actions: array [{label, handler}]
Â  Â  Â  Â  actions.forEach(a => {
Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  btn.textContent = a.label;
Â  Â  Â  Â  Â  btn.addEventListener('click', a.handler);
Â  Â  Â  Â  Â  notificationToast.appendChild(btn);
Â  Â  Â  Â  });
Â  Â  Â  Â  // auto-hide
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  notificationToast.style.opacity = '0';
Â  Â  Â  Â  Â  notificationToast.style.transform = 'translateY(10px)';
Â  Â  Â  Â  }, 6000);
Â  Â  Â  };

Â  Â  Â  const getInitials = (name='') => {
Â  Â  Â  Â  if(!name) return '';
Â  Â  Â  Â  const parts = name.trim().split(/\s+/).slice(0,2);
Â  Â  Â  Â  return parts.map(p => p[0]?.toUpperCase() || '').join('');
Â  Â  Â  };
Â  Â  Â  const getColorForName = (name='') => {
Â  Â  Â  Â  const i = (name || '').split('').reduce((s,c)=>s + c.charCodeAt(0), 0);
Â  Â  Â  Â  return avatarColors[i % avatarColors.length];
Â  Â  Â  };
Â  Â  Â  const createAvatar = (name='') => {
Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  wrapper.className = 'avatar';
Â  Â  Â  Â  wrapper.style.background = getColorForName(name);
Â  Â  Â  Â  wrapper.textContent = getInitials(name);
Â  Â  Â  Â  return wrapper;
Â  Â  Â  };

Â  Â  Â  const createBalloons = (count=6) => {
Â  Â  Â  Â  if (prefersReduced) return;
Â  Â  Â  Â  for(let i=0;i<count;i++){
Â  Â  Â  Â  Â  const b = document.createElement('div');
Â  Â  Â  Â  Â  b.className = 'balloon';
Â  Â  Â  Â  Â  b.style.left = `${Math.random() * 90}%`;
Â  Â  Â  Â  Â  b.style.background = avatarColors[i % avatarColors.length];
Â  Â  Â  Â  Â  b.style.animationDuration = `${7 + Math.random()*4}s`;
Â  Â  Â  Â  Â  celebrationContainer.appendChild(b);
Â  Â  Â  Â  Â  setTimeout(()=> b.remove(), 11000);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const triggerCelebration = () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  createBalloons(7);
Â  Â  Â  Â  Â  if(confettiCannon) {
Â  Â  Â  Â  Â  Â  confettiCannon({ particleCount: 120, spread: 140, origin: { y: 0.6 } });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e){ console.warn('celebration error', e); }
Â  Â  Â  };

Â  Â  Â  // [SUBSTITUIÃ‡ÃƒO 1] - Nova funÃ§Ã£o mapFirebaseDoc
Â  Â  Â  // Mapeador robusto - lÃª campos pt/en e gera textoData se necessÃ¡rio
Â  Â  Â  const mapFirebaseDoc = (docSnapshot) => {
Â  Â  Â    const raw = (docSnapshot && typeof docSnapshot.data === 'function') ? docSnapshot.data() : (docSnapshot || {});
Â  Â  Â    const id = (docSnapshot && docSnapshot.id) ? docSnapshot.id : (raw.id || ('local_' + Date.now()));

Â  Â  Â    // aceita 'nome' ou 'name'
Â  Â  Â    const name = raw.nome ?? raw.name ?? raw.Nome ?? raw.NAME ?? '';
Â  Â  Â    // aceita 'setor' ou 'sector'
Â  Â  Â    const sector = raw.setor ?? raw.sector ?? raw.Setor ?? raw.SECTOR ?? '';
Â  Â  Â    // dia / mes (pode vir string ou number)
Â  Â  Â    const day = Number(raw.dia ?? raw.day ?? raw.Dia ?? raw.DAY) || 0;
Â  Â  Â    const month = Number(raw.mes ?? raw.month ?? raw.Mes ?? raw.MONTH) || 0;

Â  Â  Â    // textoData: usa o campo se existir, senÃ£o monta "15 de Janeiro"
Â  Â  Â    const textoData = raw.textoData ?? raw.texto_data ?? raw.texto ?? ((day && month && monthNames[month-1]) ? `${day} de ${monthNames[month-1]}` : '');

Â  Â  Â    return {
Â  Â  Â  Â  id,
Â  Â  Â  Â  name: String(name).trim(),
Â  Â  Â  Â  sector: String(sector).trim(),
Â  Â  Â  Â  day,
Â  Â  Â  Â  month,
Â  Â  Â  Â  textoData: String(textoData)
Â  Â  Â    };
Â  Â  Â  };

Â  Â  Â  // --- Firebase init with graceful fallback (robusto: aceita vÃ¡rios nomes) ---
Â  Â  Â  const initFirebase = async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // aceita window.firebaseConfig ou window.__firebase_config (ou variantes)
Â  Â  Â  Â  Â  const fbCfg = window.firebaseConfig || window.__firebase_config || window.__FIREBASE_CONFIG || null;
Â  Â  Â  Â  Â  if (fbCfg) {
Â  Â  Â  Â  Â  Â  const app = initializeApp(fbCfg);
Â  Â  Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  Â  Â  dbCollection = collection(db, 'aniversariantes');
Â  Â  Â  Â  Â  Â  setupAuthListener();
Â  Â  Â  Â  Â  Â  console.info('Firebase inicializado (client).');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.warn('firebaseConfig nÃ£o encontrado. Usando modo demo (dados mock).');
Â  Â  Â  Â  Â  Â  dbCollection = null; // marca modo demo
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error('Erro initFirebase', err);
Â  Â  Â  Â  Â  dbCollection = null;
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  // --- Fetch + realtime (tolerant) ---
Â  Â  Â  const fetchAndRenderData = async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (dbCollection) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const snap = await getDocs(dbCollection);
Â  Â  Â  Â  Â  Â  Â  birthdayData = snap.docs.map(mapFirebaseDoc);
Â  Â  Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  Â  console.error('Erro getDocs', err);
Â  Â  Â  Â  Â  Â  Â  showNotification('Falha ao carregar dados reais; usando modo offline.', true);
Â  Â  Â  Â  Â  Â  Â  birthdayData = sampleData();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  birthdayData = sampleData();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  console.error('fetchAndRenderData erro', err);
Â  Â  Â  Â  Â  showNotification('NÃ£o foi possÃ­vel carregar os dados.', true);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  safeFinallyShowUI();
Â  Â  Â  Â  Â  attachRealtimeListener();
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const attachRealtimeListener = () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (dbCollection) {
Â  Â  Â  Â  Â  Â  if (dataUnsub) dataUnsub();
Â  Â  Â  Â  Â  Â  dataUnsub = onSnapshot(dbCollection, snap => {
Â  Â  Â  Â  Â  Â  Â  birthdayData = snap.docs.map(mapFirebaseDoc);
Â  Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â  }, err => {
Â  Â  Â  Â  Â  Â  Â  console.warn('Realtime listener erro', err);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e) { console.warn('attachRealtimeListener', e); }
Â  Â  Â  };

Â  Â  Â  const setupAuthListener = () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (!auth) return;
Â  Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  // check claims example (requires admin to set custom claims)
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const token = await user.getIdTokenResult(true);
Â  Â  Â  Â  Â  Â  Â  Â  isAdmin = !!token.claims?.admin;
Â  Â  Â  Â  Â  Â  Â  } catch(e){ isAdmin = false; }
Â  Â  Â  Â  Â  Â  Â  document.body.classList.toggle('admin-mode', !!isAdmin);
Â  Â  Â  Â  Â  Â  Â  authBtn.textContent = isAdmin ? 'ğŸ”“ Sair' : 'ğŸ”’ Conta';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  isAdmin = false;
Â  Â  Â  Â  Â  Â  Â  document.body.classList.remove('admin-mode');
Â  Â  Â  Â  Â  Â  Â  authBtn.textContent = 'ğŸ”’ Acesso Restrito';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch(e){ console.warn('setupAuthListener', e); }
Â  Â  Â  };

Â  Â  Â  // --- Demo fallback data ---
Â  Â  Â  const sampleData = () => ([
Â  Â  Â  Â  { id:'s1', name: 'Ana Silva', sector: 'Engenharia', day: currentDate.getDate(), month: currentDate.getMonth() + 1 },
Â  Â  Â  Â  { id:'s2', name: 'Bruno Costa', sector: 'Comercial', day: ((currentDate.getDate()+3)%28)+1, month: currentDate.getMonth() + 1 },
Â  Â  Â  Â  { id:'s3', name: 'Carla Nunes', sector: 'RH', day: ((currentDate.getDate()+10)%28)+1, month: currentDate.getMonth() + 1 },
Â  Â  Â  ]);

Â  Â  Â  // ===== RENDER =====
Â  Â  Â  const renderAll = (searchTerm='') => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // sort
Â  Â  Â  Â  Â  birthdayData.sort((a,b)=>{
Â  Â  Â  Â  Â  Â  const dir = sortConfig.direction === 'ascending' ? 1 : -1;
Â  Â  Â  Â  Â  Â  const valA = sortConfig.key === 'date' ? (a.month*100 + a.day) : (a[sortConfig.key] || '');
Â  Â  Â  Â  Â  Â  const valB = sortConfig.key === 'date' ? (b.month*100 + b.day) : (b[sortConfig.key] || '');
Â  Â  Â  Â  Â  Â  if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
Â  Â  Â  Â  Â  Â  if (valA === valB) return (a.name || '').localeCompare(b.name || '') * dir;
Â  Â  Â  Â  Â  Â  return (valA - valB) * dir;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  renderToday();
Â  Â  Â  Â  Â  renderUpcoming();
Â  Â  Â  Â  Â  renderTable(searchTerm);
Â  Â  Â  Â  Â  renderCalendar();
Â  Â  Â  Â  Â  renderCharts();
Â  Â  Â  Â  } catch(e) { console.error('renderAll erro', e); }
Â  Â  Â  };

Â  Â  Â  const renderToday = () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  todayPanel.innerHTML = '';
Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  const day = today.getDate();
Â  Â  Â  Â  Â  const month = today.getMonth() + 1;
Â  Â  Â  Â  Â  const todays = birthdayData.filter(p => p.day === day && p.month === month);
Â  Â  Â  Â  Â  if (todays.length === 0) {
Â  Â  Â  Â  Â  Â  todayPanel.innerHTML = `<div class="bg-card p-4 text-center rounded-lg">Nenhum aniversÃ¡rio hoje.</div>`;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const grid = document.createElement('div');
Â  Â  Â  Â  Â  Â  grid.id = 'today-panel-grid';
Â  Â  Â  Â  Â  Â  todays.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  card.className = 'birthday-card bg-card';
Â  Â  Â  Â  Â  Â  Â  const avatar = createAvatar(p.name);
Â  Â  Â  Â  Â  Â  Â  const info = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  info.className = 'card-info';
Â  Â  Â  Â  Â  Â  Â  const nameEl = document.createElement('span'); nameEl.className='name'; nameEl.textContent = p.name;
Â  Â  Â  Â  Â  Â  Â  const sectorEl = document.createElement('span'); sectorEl.className='sector'; sectorEl.textContent = p.sector;
Â  Â  Â  Â  Â  Â  Â  const dateEl = document.createElement('span'); dateEl.className='date'; dateEl.textContent = `Dia: ${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}`;
Â  Â  Â  Â  Â  Â  Â  info.append(nameEl, sectorEl, dateEl);
Â  Â  Â  Â  Â  Â  Â  card.append(avatar, info);
Â  Â  Â  Â  Â  Â  Â  grid.appendChild(card);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  todayPanel.appendChild(grid);
Â  Â  Â  Â  Â  Â  if (todays.length) triggerCelebration();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e){ console.warn('renderToday', e); }
Â  Â  Â  };

Â  Â  Â  const renderUpcoming = () => {
Â  Â  Â  Â  upcomingPanel.innerHTML = '';
Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  const upcomingBdays = [];
Â  Â  Â  Â  for(let i=1;i<=15;i++){
Â  Â  Â  Â  Â  const futureDate = new Date();
Â  Â  Â  Â  Â  futureDate.setDate(today.getDate() + i);
Â  Â  Â  Â  Â  const day = futureDate.getDate(), month = futureDate.getMonth() + 1;
Â  Â  Â  Â  Â  const match = birthdayData.filter(p => p.day === day && p.month === month);
Â  Â  Â  Â  Â  if (match.length) upcomingBdays.push(...match);
Â  Â  Â  Â  }
Â  Â  Â  Â  if (upcomingBdays.length === 0) {
Â  Â  Â  Â  Â  upcomingPanel.innerHTML = `<div class="bg-card p-4 text-center rounded-lg">Nenhum aniversÃ¡rio nos prÃ³ximos 15 dias.</div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const grid = document.createElement('div');
Â  Â  Â  Â  Â  grid.id = 'upcoming-panel-grid';
Â  Â  Â  Â  Â  upcomingBdays.forEach(p => {
Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  card.className = 'birthday-card bg-card';
Â  Â  Â  Â  Â  Â  const avatar = createAvatar(p.name);
Â  Â  Â  Â  Â  Â  const info = document.createElement('div');
Â  Â  Â  Â  Â  Â  info.className = 'card-info';
Â  Â  Â  Â  Â  Â  const nameEl = document.createElement('span'); nameEl.className='name'; nameEl.textContent = p.name;
Â  Â  Â  Â  Â  Â  const sectorEl = document.createElement('span'); sectorEl.className='sector'; sectorEl.textContent = p.sector;
Â  Â  Â  Â  Â  Â  const dateEl = document.createElement('span'); dateEl.className='date'; dateEl.textContent = `Dia: ${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}`;
Â  Â  Â  Â  Â  Â  info.append(nameEl, sectorEl, dateEl);
Â  Â  Â  Â  Â  Â  card.append(avatar, info);
Â  Â  Â  Â  Â  Â  grid.appendChild(card);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  upcomingPanel.appendChild(grid);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const renderTable = (searchTerm='') => {
Â  Â  Â  Â  tableBody.innerHTML = '';
Â  Â  Â  Â  const q = (searchTerm || '').toLowerCase();
Â  Â  Â  Â  const filtered = q ? birthdayData.filter(p => (p.name || '').toLowerCase().includes(q) || (p.sector||'').toLowerCase().includes(q)) : birthdayData;
Â  Â  Â  Â  noResults.classList.toggle('hidden', filtered.length > 0);
Â  Â  Â  Â  filtered.forEach(p => {
Â  Â  Â  Â  Â  const tr = document.createElement('tr');

Â  Â  Â  Â  Â  // name cell
Â  Â  Â  Â  Â  const nameCell = document.createElement('td');
Â  Â  Â  Â  Â  nameCell.dataset.label = "Nome";
Â  Â  Â  Â  Â  nameCell.className = 'table-avatar-cell';
Â  Â  Â  Â  Â  const avatar = createAvatar(p.name);
Â  Â  Â  Â  Â  const nameSpan = document.createElement('span');
Â  Â  Â  Â  Â  nameSpan.textContent = p.name;
Â  Â  Â  Â  Â  nameCell.append(avatar, nameSpan);

Â  Â  Â  Â  Â  // sector + date cells
Â  Â  Â  Â  Â  const sectorCell = document.createElement('td');
Â  Â  Â  Â  Â  sectorCell.dataset.label = "Setor";
Â  Â  Â  Â  Â  sectorCell.textContent = p.sector;
Â  Â  Â  Â  Â  const dateCell = document.createElement('td');
Â  Â  Â  Â  Â  dateCell.dataset.label = "Data";
Â  Â  Â  Â  Â  dateCell.textContent = `${String(p.day).padStart(2,'0')}/${String(p.month).padStart(2,'0')}`;

Â  Â  Â  Â  Â  // actions cell
Â  Â  Â  Â  Â  const actionsCell = document.createElement('td');
Â  Â  Â  Â  Â  actionsCell.dataset.label = "AÃ§Ãµes";
Â  Â  Â  Â  Â  actionsCell.className = 'admin-only-table-cell';
Â  Â  Â  Â  Â  const editBtn = document.createElement('button');
Â  Â  Â  Â  Â  editBtn.className = 'edit-btn';
Â  Â  Â  Â  Â  editBtn.style.color = 'var(--eletro-blue)';
Â  Â  Â  Â  Â  editBtn.textContent = 'Editar';
Â  Â  Â  Â  Â  editBtn.addEventListener('click', () => openModal(p));
Â  Â  Â  Â  Â  const deleteBtn = document.createElement('button');
Â  Â  Â  Â  Â  deleteBtn.className = 'delete-btn';
Â  Â  Â  Â  Â  deleteBtn.style.color = '#dc2626';
Â  Â  Â  Â  Â  deleteBtn.textContent = 'Excluir';
Â  Â  Â  Â  Â  deleteBtn.addEventListener('click', () => deletePerson(p.id, p.name));
Â  Â  Â  Â  Â  actionsCell.append(editBtn, document.createTextNode(' '), deleteBtn);

Â  Â  Â  Â  Â  tr.append(nameCell, sectorCell, dateCell, actionsCell);
Â  Â  Â  Â  Â  tableBody.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  Â  updateSortIndicators();
Â  Â  Â  };

Â  Â  Â  const renderCalendar = () => {
Â  Â  Â  Â  calendarGrid.innerHTML = '';
Â  Â  Â  Â  const year = currentDate.getFullYear();
Â  Â  Â  Â  const month = currentDate.getMonth(); // 0-index
Â  Â  Â  Â  calendarMonthYear.textContent = `${monthNames[month]} ${year}`;

Â  Â  Â  Â  const firstDay = new Date(year, month, 1).getDay(); // 0..6 (Sun..Sat)
Â  Â  Â  Â  const daysInMonth = new Date(year, month+1, 0).getDate();

Â  Â  Â  Â  for(let i=0;i<firstDay;i++){
Â  Â  Â  Â  Â  const cell = document.createElement('div');
Â  Â  Â  Â  Â  cell.className = 'day-cell';
Â  Â  Â  Â  Â  cell.style.opacity = '0.25';
Â  Â  Â  Â  Â  calendarGrid.appendChild(cell);
Â  Â  Â  Â  }

Â  Â  Â  Â  for(let d=1; d<=daysInMonth; d++){
Â  Â  Â  Â  Â  const cell = document.createElement('div');
Â  Â  Â  Â  Â  cell.className = 'day-cell bg-card p-2 rounded-lg';
Â  Â  Â  Â  Â  const items = birthdayData.filter(b => b.day === d && b.month === month+1);
Â  Â  Â  Â  Â  const count = items.length;
Â  Â  Â  Â  Â  if (count > 0) cell.dataset.count = String(Math.min(count,3));
Â  Â  Â  Â  Â  cell.textContent = d;

Â  Â  Â  Â  Â  cell.addEventListener('mouseenter', (ev) => {
Â  Â  Â  Â  Â  Â  if (!items.length) return;
Â  Â  Â  Â  Â  Â  calendarTooltip.style.display = 'block';
Â  Â  Â  Â  Â  Â  calendarTooltip.innerHTML = '';
Â  Â  Â  Â  Â  Â  const title = document.createElement('strong'); title.textContent = `${d} ${monthNames[month]}`; calendarTooltip.appendChild(title);
Â  Â  Â  Â  Â  Â  const ul = document.createElement('ul');
Â  Â  Â  Â  Â  Â  items.forEach(it => {
Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  const name = document.createElement('span'); name.className = 'name'; name.textContent = it.name;
Â  Â  Â  Â  Â  Â  Â  const sector = document.createElement('span'); sector.className = 'sector'; sector.textContent = ` â€” ${it.sector}`;
Â  Â  Â  Â  Â  Â  Â  li.append(name, sector);
Â  Â  Â  Â  Â  Â  Â  ul.appendChild(li);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  calendarTooltip.appendChild(ul);
Â  Â  Â  Â  Â  Â  // position (clamped)
Â  Â  Â  Â  Â  Â  const rect = ev.target.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  const x = Math.min(window.innerWidth - calendarTooltip.offsetWidth - 8, rect.left + window.scrollX);
Â  Â  Â  Â  Â  Â  const y = rect.bottom + window.scrollY + 6;
Â  Â  Â  Â  Â  Â  calendarTooltip.style.left = `${Math.max(8, x)}px`;
Â  Â  Â  Â  Â  Â  calendarTooltip.style.top = `${Math.min(window.innerHeight - 40, y)}px`;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  cell.addEventListener('mouseleave', () => {
Â  Â  Â  Â  Â  Â  calendarTooltip.style.display = 'none';
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  calendarGrid.appendChild(cell);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const renderCharts = () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const bc = document.getElementById('birthday-chart');
Â  Â  Â  Â  Â  const sc = document.getElementById('sector-chart');
Â  Â  Â  Â  Â  if (!bc || !sc || typeof Chart === 'undefined') return;
Â  Â  Â  Â  Â  // birthdays per month
Â  Â  Â  Â  Â  const monthsCount = new Array(12).fill(0);
Â  Â  Â  Â  Â  birthdayData.forEach(b => monthsCount[(b.month||1)-1]++);
Â  Â  Â  Â  Â  if (window._birthdayChart) window._birthdayChart.destroy();
Â  Â  Â  Â  Â  window._birthdayChart = new Chart(bc.getContext('2d'), {
Â  Â  Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  Â  Â  data: { labels: monthNames, datasets: [{ label: 'Aniversariantes', data: monthsCount }] },
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  // sectors
Â  Â  Â  Â  Â  const sectorMap = {};
Â  Â  Â  Â  Â  birthdayData.forEach(b => sectorMap[b.sector] = (sectorMap[b.sector]||0)+1);
Â  Â  Â  Â  Â  if (window._sectorChart) window._sectorChart.destroy();
Â  Â  Â  Â  Â  window._sectorChart = new Chart(sc.getContext('2d'), {
Â  Â  Â  Â  Â  Â  type: 'doughnut',
Â  Â  Â  Â  Â  Â  data: { labels: Object.keys(sectorMap), datasets: [{ data: Object.values(sectorMap) }] },
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch(e){ console.warn('renderCharts', e); }
Â  Â  Â  };

Â  Â  Â  // ----- CRUD & Modal (accessible) -----
Â  Â  Â  let lastFocusedEl = null;
Â  Â  Â  const openModal = (person=null) => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  modalForm.reset();
Â  Â  Â  Â  Â  if (person) {
Â  Â  Â  Â  Â  Â  modalTitle.textContent = "Editar Aniversariante";
Â  Â  Â  Â  Â  Â  modalPersonId.value = person.id || '';
Â  Â  Â  Â  Â  Â  document.getElementById('person-name').value = person.name || '';
Â  Â  Â  Â  Â  Â  document.getElementById('person-sector').value = person.sector || '';
Â  Â  Â  Â  Â  Â  document.getElementById('person-day').value = person.day || '';
Â  Â  Â  Â  Â  Â  document.getElementById('person-month').value = person.month || '';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  modalTitle.textContent = "Adicionar Aniversariante";
Â  Â  Â  Â  Â  Â  modalPersonId.value = '';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  lastFocusedEl = document.activeElement;
Â  Â  Â  Â  Â  modalOverlay.classList.remove('hidden');
Â  Â  Â  Â  Â  modalOverlay.setAttribute('aria-hidden', 'false');
Â  Â  Â  Â  Â  const firstInput = modalOverlay.querySelector('input,button,select,textarea');
Â  Â  Â  Â  Â  firstInput?.focus();
Â  Â  Â  Â  Â  document.addEventListener('keydown', trapTabKey);
Â  Â  Â  Â  } catch(e){ console.warn('openModal', e); }
Â  Â  Â  };
Â  Â  Â  const closeModal = () => {
Â  Â  Â  Â  modalOverlay.classList.add('hidden');
Â  Â  Â  Â  modalOverlay.setAttribute('aria-hidden', 'true');
Â  Â  Â  Â  lastFocusedEl?.focus();
Â  Â  Â  Â  document.removeEventListener('keydown', trapTabKey);
Â  Â  Â  };
Â  Â  Â  function trapTabKey(e) {
Â  Â  Â  Â  if (e.key !== 'Tab') return;
Â  Â  Â  Â  const focusable = modalOverlay.querySelectorAll('a[href], button:not([disabled]), input, select, textarea, [tabindex]:not([tabindex="-1"])');
Â  Â  Â  Â  if (!focusable.length) return;
Â  Â  Â  Â  const first = focusable[0], last = focusable[focusable.length-1];
Â  Â  Â  Â  if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
Â  Â  Â  Â  else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
Â  Â  Â  }

Â  Â  Â  const isValidDate = (day, month) => {
Â  Â  Â  Â  day = Number(day); month = Number(month);
Â  Â  Â  Â  if (!day || !month) return false;
Â  Â  Â  Â  const y = 2000; // leap-year safe
Â  Â  Â  Â  const d = new Date(y, month-1, day);
Â  Â  Â  Â  return d.getMonth() === month-1 && d.getDate() === day;
Â  Â  Â  };

Â  Â  Â  const savePerson = async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const id = modalPersonId.value;
Â  Â  Â  Â  const personData = {
Â  Â  Â  Â  Â  name: document.getElementById('person-name').value.trim(),
Â  Â  Â  Â  Â  sector: document.getElementById('person-sector').value.trim(),
Â  Â  Â  Â  Â  day: Number(document.getElementById('person-day').value),
Â  Â  Â  Â  Â  month: Number(document.getElementById('person-month').value),
Â  Â  Â  Â  };
Â  Â  Â  Â  if (!personData.name || !personData.sector || !personData.day || !personData.month) {
Â  Â  Â  Â  Â  return showNotification("Todos os campos sÃ£o obrigatÃ³rios.", true);
Â  Â  Â  Â  }
Â  Â  Â  Â  if (!isValidDate(personData.day, personData.month)) {
Â  Â  Â  Â  Â  return showNotification("Data invÃ¡lida.", true);
Â  Â  Â  Â  }
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // [SUBSTITUIÃ‡ÃƒO 2] - Novo bloco de gravaÃ§Ã£o no Firestore
Â  Â  Â  Â  Â  if (dbCollection) {
Â  Â  Â  Â  Â  Â  // payload no formato PT â€” mantÃ©m compatibilidade com seus docs atuais
Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  nome: personData.name,
Â  Â  Â  Â  Â  Â  Â  setor: personData.sector,
Â  Â  Â  Â  Â  Â  Â  dia: personData.day,
Â  Â  Â  Â  Â  Â  Â  mes: personData.month,
Â  Â  Â  Â  Â  Â  Â  textoData: `${personData.day} de ${monthNames[(personData.month || 1) - 1] || ''}`,
Â  Â  Â  Â  Â  Â  Â  updatedAt: serverTimestamp()
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  if (id) {
Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, 'aniversariantes', id), payload);
Â  Â  Â  Â  Â  Â  Â  showNotification('Dados atualizados com sucesso!');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  await addDoc(dbCollection, { ...payload, createdAt: serverTimestamp() });
Â  Â  Â  Â  Â  Â  Â  showNotification('Aniversariante adicionado com sucesso!');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Modo demo: manter estrutura interna (name/sector/day/month) usada pelo app,
Â  Â  Â  Â  Â  Â  // mas tambÃ©m incluir textoData para consistÃªncia
Â  Â  Â  Â  Â  Â  if (id) {
Â  Â  Â  Â  Â  Â  Â  const idx = birthdayData.findIndex(x => x.id === id);
Â  Â  Â  Â  Â  Â  Â  if (idx >= 0) birthdayData[idx] = { ...birthdayData[idx], ...personData, textoData: `${personData.day} de ${monthNames[(personData.month||1)-1] || ''}` };
Â  Â  Â  Â  Â  Â  Â  showNotification('AlteraÃ§Ã£o local (demo).');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  birthdayData.push({ id: 'local_' + Date.now(), ...personData, textoData: `${personData.day} de ${monthNames[(personData.month||1)-1] || ''}` });
Â  Â  Â  Â  Â  Â  Â  showNotification('Adicionado local (demo).');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  renderAll(searchInput.value);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  console.error('savePerson', err);
Â  Â  Â  Â  Â  showNotification('Erro ao salvar. Tente novamente.', true);
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const deletePerson = async (id, name) => {
Â  Â  Â  Â  if (!confirm(`Tem certeza que deseja excluir ${name}?`)) return;
Â  Â  Â  Â  // optimistic remove + undo
Â  Â  Â  Â  const item = birthdayData.find(x => x.id === id);
Â  Â  Â  Â  birthdayData = birthdayData.filter(x => x.id !== id);
Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  let undone = false;
Â  Â  Â  Â  const undoHandler = () => {
Â  Â  Â  Â  Â  undone = true;
Â  Â  Â  Â  Â  birthdayData.push(item);
Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  showNotification('ExclusÃ£o desfeita.');
Â  Â  Â  Â  };
Â  Â  Â  Â  showNotification(`${name} excluÃ­do.`, false, [{ label: 'Desfazer', handler: undoHandler }]);
Â  Â  Â  Â  // schedule delete after timeout (and only if not undone)
Â  Â  Â  Â  setTimeout(async () => {
Â  Â  Â  Â  Â  if (undone) return;
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (dbCollection) {
Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, 'aniversariantes', id));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  showNotification(`${name} excluÃ­do (demo).`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  console.error('deletePerson', err);
Â  Â  Â  Â  Â  Â  showNotification('Erro ao excluir. Tente novamente.', true);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 6000);
Â  Â  Â  };

Â  Â  Â  // ----- CSV functions (PapaParse + safe export) -----
Â  Â  Â  const escapeCSV = s => `"${String(s).replace(/"/g,'""')}"`;

Â  Â  Â  const exportToCSV = () => {
Â  Â  Â  Â  let csv = 'Nome,Setor,Dia,MÃªs\n';
Â  Â  Â  Â  birthdayData.forEach(p => {
Â  Â  Â  Â  Â  csv += `${escapeCSV(p.name)},${escapeCSV(p.sector)},${p.day},${p.month}\n`;
Â  Â  Â  Â  });
Â  Â  Â  Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  a.download = 'aniversariantes.csv';
Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  a.click();
Â  Â  Â  Â  a.remove();
Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  showNotification('Dados exportados para CSV.');
Â  Â  Â  };

Â  Â  Â  const importFromCSV = (e) => {
Â  Â  Â  Â  const file = e.target.files && e.target.files[0];
Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  Papa.parse(file, {
Â  Â  Â  Â  Â  header: true,
Â  Â  Â  Â  Â  skipEmptyLines: true,
Â  Â  Â  Â  Â  complete: async (results) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const rows = results.data;
Â  Â  Â  Â  Â  Â  Â  const valid = rows.map(r => {
Â  Â  Â  Â  Â  Â  Â  Â  const name = r['Nome'] || r['name'] || r.nome;
Â  Â  Â  Â  Â  Â  Â  Â  const sector = r['Setor'] || r['sector'] || r.setor;
Â  Â  Â  Â  Â  Â  Â  Â  const day = Number(r['Dia'] || r['day']);
Â  Â  Â  Â  Â  Â  Â  Â  const month = Number(r['MÃªs'] || r['Mes'] || r.month);
Â  Â  Â  Â  Â  Â  Â  Â  return { name, sector, day, month };
Â  Â  Â  Â  Â  Â  Â  }).filter(x => x.name && x.sector && !isNaN(x.day) && !isNaN(x.month) && isValidDate(x.day, x.month));
Â  Â  Â  Â  Â  Â  Â  if (!valid.length) return showNotification('Nenhum registro vÃ¡lido encontrado.', true);
Â  Â  Â  Â  Â  Â  Â  // preview small sample
Â  Â  Â  Â  Â  Â  Â  const previewCount = Math.min(6, valid.length);
Â  Â  Â  Â  Â  Â  Â  const confirmTxt = `${valid.length} registros vÃ¡lidos encontrados (mostrando ${previewCount}). Deseja importar?`;
Â  Â  Â  Â  Â  Â  Â  if (!confirm(confirmTxt)) return;
Â  Â  Â  Â  Â  Â  Â  if (dbCollection) {
Â  Â  Â  Â  Â  Â  Â  Â  // commit sequentially or use batch (simplified addDoc loop)
Â  Â  Â  Â  Â  Â  Â  Â  for (const item of valid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(dbCollection, { ...item, createdAt: serverTimestamp() });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  valid.forEach(v => birthdayData.push({ id: 'local_'+Date.now()+Math.random(), ...v }));
Â  Â  Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  showNotification('ImportaÃ§Ã£o concluÃ­da.');
Â  Â  Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  Â  console.error('importFromCSV parsing', err);
Â  Â  Â  Â  Â  Â  Â  showNotification('Erro durante a importaÃ§Ã£o.', true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  error: (err) => {
Â  Â  Â  Â  Â  Â  console.error('PapaParse error', err);
Â  Â  Â  Â  Â  Â  showNotification('Erro ao ler CSV.', true);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  e.target.value = '';
Â  Â  Â  };

Â  Â  Â  // ----- Sorting UI -----
Â  Â  Â  const updateSortIndicators = () => {
Â  Â  Â  Â  if (!tableHeader) return;
Â  Â  Â  Â  tableHeader.querySelectorAll('th').forEach(th => {
Â  Â  Â  Â  Â  const span = th.querySelector('span');
Â  Â  Â  Â  Â  if (!span) return;
Â  Â  Â  Â  Â  if (th.dataset.sort === sortConfig.key) {
Â  Â  Â  Â  Â  Â  span.textContent = sortConfig.direction === 'ascending' ? ' â–²' : ' â–¼';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  span.textContent = '';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  };

Â  Â  Â  // ----- Utilities -----
Â  Â  Â  const debounce = (fn, delay=250) => {
Â  Â  Â  Â  let t;
Â  Â  Â  Â  return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), delay); };
Â  Â  Â  };

Â  Â  Â  // ----- Event listeners -----
Â  Â  Â  prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
Â  Â  Â  nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
Â  Â  Â  searchInput.addEventListener('input', debounce((e) => renderTable(e.target.value), 220));

Â  Â  Â  tabsContainer.addEventListener('click', (ev) => {
Â  Â  Â  Â  const btn = ev.target.closest('.tab-btn');
Â  Â  Â  Â  if (!btn) return;
Â  Â  Â  Â  const tab = btn.dataset.tab;
Â  Â  Â  Â  document.querySelectorAll('#tab-panels-container .tab-panel').forEach(p => p.classList.add('hidden'));
Â  Â  Â  Â  document.querySelectorAll('#tabs-container .tab-btn').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  const panelMap = { today: '#today-panel', upcoming: '#upcoming-panel', calendar: '#calendar-panel', list: '#list-panel', chart: '#chart-panel' };
Â  Â  Â  Â  const sel = panelMap[tab];
Â  Â  Â  Â  if (sel) document.querySelector(sel).classList.remove('hidden');
Â  Â  Â  Â  // animate underline
Â  Â  Â  Â  activeTabUnderline.style.width = `${btn.offsetWidth}px`;
Â  Â  Â  Â  activeTabUnderline.style.left = `${btn.offsetLeft}px`;
Â  Â  Â  Â  if (tab === 'chart') renderCharts();
Â  Â  Â  });

Â  Â  Â  const initTheme = () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const saved = localStorage.getItem('theme');
Â  Â  Â  Â  Â  if (saved === 'dark' || (!saved && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
Â  Â  Â  Â  Â  Â  document.documentElement.classList.add('dark');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.documentElement.classList.remove('dark');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e){ console.warn('initTheme', e); }
Â  Â  Â  };
Â  Â  Â  themeToggleBtn.addEventListener('click', () => {
Â  Â  Â  Â  const isDark = document.documentElement.classList.toggle('dark');
Â  Â  Â  Â  localStorage.setItem('theme', isDark ? 'dark' : 'light');
Â  Â  Â  });

Â  Â  Â  // modal & CSV listeners
Â  Â  Â  addPersonBtn && addPersonBtn.addEventListener('click', () => openModal());
Â  Â  Â  modalCancelBtn.addEventListener('click', closeModal);
Â  Â  Â  modalOverlay.addEventListener('click', (ev) => { if (ev.target === modalOverlay) closeModal(); });
Â  Â  Â  modalForm.addEventListener('submit', savePerson);

Â  Â  Â  importCsvBtn && importCsvBtn.addEventListener('click', () => csvFileInput.click());
Â  Â  Â  csvFileInput && csvFileInput.addEventListener('change', importFromCSV);
Â  Â  Â  exportCsvBtn && exportCsvBtn.addEventListener('click', exportToCSV);

Â  Â  Â  tableHeader && tableHeader.addEventListener('click', (e) => {
Â  Â  Â  Â  const th = e.target.closest('th');
Â  Â  Â  Â  if (!th || th.dataset.sort === 'none') return;
Â  Â  Â  Â  const key = th.dataset.sort;
Â  Â  Â  Â  if (sortConfig.key === key) sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
Â  Â  Â  Â  else { sortConfig.key = key; sortConfig.direction = 'ascending'; }
Â  Â  Â  Â  renderAll(searchInput.value);
Â  Â  Â  });

Â  Â  Â  // calendar tooltip follow
Â  Â  Â  calendarGrid.addEventListener('mousemove', debounce((e) => {
Â  Â  Â  Â  if (calendarTooltip.style.display === 'block') {
Â  Â  Â  Â  Â  const x = Math.min(window.innerWidth - calendarTooltip.offsetWidth - 8, e.pageX + 12);
Â  Â  Â  Â  Â  calendarTooltip.style.left = `${x}px`;
Â  Â  Â  Â  }
Â  Â  Â  }, 20));

Â  Â  Â  // underline sizing on resize
Â  Â  Â  const updateUnderline = () => {
Â  Â  Â  Â  const active = document.querySelector('.tab-btn.active');
Â  Â  Â  Â  if (active) {
Â  Â  Â  Â  Â  activeTabUnderline.style.width = `${active.offsetWidth}px`;
Â  Â  Â  Â  Â  activeTabUnderline.style.left = `${active.offsetLeft}px`;
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  window.addEventListener('resize', debounce(updateUnderline, 120));
Â  Â  Â  try {
Â  Â  Â  Â  const ro = new ResizeObserver(debounce(updateUnderline, 120));
Â  Â  Â  Â  ro.observe(tabsContainer);
Â  Â  Â  } catch(e){ /* ignore if ResizeObserver not available */ }

Â  Â  Â  // initial activation
Â  Â  Â  const firstTab = tabsContainer.querySelector('.tab-btn');
Â  Â  Â  if (firstTab) {
Â  Â  Â  Â  firstTab.click();
Â  Â  Â  Â  requestAnimationFrame(()=> {
Â  Â  Â  Â  Â  activeTabUnderline.style.width = `${firstTab.offsetWidth}px`;
Â  Â  Â  Â  Â  activeTabUnderline.style.left = `${firstTab.offsetLeft}px`;
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // init flow
Â  Â  Â  initTheme();
Â  Â  Â  (async () => {
Â  Â  Â  Â  await initFirebase();
Â  Â  Â  Â  await fetchAndRenderData();
Â  Â  Â  })();

Â  Â  Â  // global error handler: ensure loader not stuck
Â  Â  Â  window.addEventListener('error', (ev) => {
Â  Â  Â  Â  console.error('Global error:', ev.error || ev.message);
Â  Â  Â  Â  safeFinallyShowUI();
Â  Â  Â  });
Â  Â  Â  window.addEventListener('unhandledrejection', (ev) => {
Â  Â  Â  Â  console.error('Unhandled rejection:', ev.reason);
Â  Â  Â  Â  safeFinallyShowUI();
Â  Â  Â  });

Â  Â  Â  // debug helper
Â  Â  Â  window.__reRenderBirthdays = () => renderAll();

Â  Â  });
Â  </script>
</body>
</html>
