<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel de Aniversariantes</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="/firebase-config.js"></script>

    <style>
        :root{
            --eletro-blue: #003366;
            --eletro-teal: #009a74;
            --muted: #6b7280;
            --bg-page: #ffffff;
            --card-bg: #ffffff;
            --soft-border: #e6eef6;
            --shadow-1: 0 6px 18px rgba(11, 22, 39, 0.06);
            --radius: 10px;
        }
        html,body{ height:100%; margin:0; padding:0; font-family: "Segoe UI", Inter, system-ui, -apple-system, "Helvetica Neue", Arial; background: var(--bg-page); color: #0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
        .container{ max-width: 1200px; margin: 0 auto; padding: 28px 20px; }
        header { text-align: left; display:flex; gap:18px; align-items:center; justify-content:space-between; padding-bottom:18px; border-bottom: 1px solid var(--soft-border); margin-bottom: 22px; }
        header .title-group { display:flex; gap:18px; align-items:center; }
        header svg { width:56px; height:56px; border-radius:8px; padding:6px; background: linear-gradient(135deg,var(--eletro-blue),var(--eletro-teal)); color:white; }
        h1 { font-size:22px; margin:0; color:var(--eletro-blue); font-weight:600; letter-spacing: -0.2px; }
        header p { margin:0; color:var(--muted); font-size:13px; }
        #tabs-container { gap:8px; margin-bottom: 12px; display:flex; flex-wrap:wrap; }
        .tab-btn { background: transparent; border: 1px solid transparent; padding:10px 14px; border-radius:8px; color: var(--muted); font-weight:600; cursor:pointer; transition: all .18s ease; }
        .tab-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-1); }
        .tab-btn.active { background: linear-gradient(180deg, rgba(0,114,198,0.08), rgba(0,114,198,0.02)); border: 1px solid rgba(0,114,198,0.12); color: var(--eletro-blue); }
        .tab-panel { margin-top:12px; }
        .bg-white { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow-1); border: 1px solid var(--soft-border); }
        table { border-collapse: collapse; width: 100%; font-size: 14px; }
        thead th { background: rgba(6,34,63,0.03); color: #334155; font-weight:700; padding:14px; position:sticky; top:0; z-index:3; }
        tbody td { padding:12px 14px; border-top: 1px solid rgba(15,23,42,0.04); color:#0f172a; }
        button { font-family:inherit; cursor:pointer; }
        .primary { background: var(--eletro-blue); color:#fff; border-radius:10px; padding:10px 12px; border: none; box-shadow:none; transition: background-color .2s; display:inline-block; text-decoration:none; }
        .primary:hover { background: #004488; }
        .secondary { background: var(--eletro-teal); color:#fff; border-radius:10px; padding:10px 12px; border:none; }
        .tertiary { background: #f1f5f9; color:#475569; font-weight:600; border-radius:10px; padding:10px 12px; border:none; }
        .modal-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(2,6,23,0.45); }
        .admin-only { display: none !important; }
        body.admin-mode .admin-only { display: block !important; }
        .admin-only-table-cell { display: none !important; }
        body.admin-mode .admin-only-table-cell { display: table-cell !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }

        /* Banner para iframe embed */
        .embed-admin-banner {
          display:flex;
          gap:12px;
          align-items:center;
          justify-content:center;
          padding:12px;
          background: linear-gradient(90deg,#ffffff,#fbfdff);
          border-bottom: 1px solid var(--soft-border);
          font-size:14px;
        }
        .embed-admin-banner .hint { color:var(--muted); font-size:13px; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Banner / CTA para abrir √°rea administrativa em nova aba quando embutido (iframe) -->
    <script>
      (function(){
        try {
          if (window.self !== window.top) {
            // Link absoluto para o hosting (substitua se for outro dom√≠nio)
            const adminUrl = "https://aniversariantes-automation.web.app/?admin=1";

            const banner = document.createElement('div');
            banner.className = 'embed-admin-banner';
            banner.innerHTML = `
              <a class="primary" href="${adminUrl}" target="_blank" rel="noopener noreferrer">üîí Abrir √°rea administrativa (nova aba)</a>
              <span class="hint">(Para editar, abra em nova aba ‚Äî evita erros de autentica√ß√£o ao usar iframe)</span>
            `;
            // inserir antes do primeiro elemento do body para ficar vis√≠vel no topo
            document.addEventListener('DOMContentLoaded', () => {
              if (document.body.firstChild) document.body.insertBefore(banner, document.body.firstChild);
              else document.body.appendChild(banner);
            });
          }
        } catch (e) {
          // se houver qualquer erro, n√£o trava a p√°gina
          console.warn('embed banner init failed', e);
        }
      })();
    </script>

    <div class="container">
        <header>
            <div class="title-group">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.975M15 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <div>
                    <h1>Painel de Aniversariantes</h1>
                    <p class="mt-1">Celebre com a nossa equipe.</p>
                </div>
            </div>
            <div>
                <button id="auth-btn" class="tertiary text-sm">üîí Acesso Restrito</button>
            </div>
        </header>

        <div id="tabs-container">
            <button data-tab="today" class="tab-btn">üéÇ Aniversariantes do Dia</button>
            <button data-tab="calendar" class="tab-btn">üóìÔ∏è Calend√°rio</button>
            <button data-tab="list" class="tab-btn">üìã Lista Completa</button>
            <button data-tab="chart" class="tab-btn">üìä An√°lises & Gest√£o</button>
        </div>

        <main id="tab-panels-container">
            <div id="today-panel" class="tab-panel"></div>
            <div id="calendar-panel" class="tab-panel hidden">
                 <div class="bg-white p-4 md:p-6 rounded-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-slate-700">Calend√°rio de Anivers√°rios</h2>
                        <div class="flex items-center gap-2 mt-4 sm:mt-0">
                             <button id="today-btn" class="px-3 py-1 text-sm bg-slate-200 hover:bg-slate-300 rounded-md">Hoje</button>
                            <button id="prev-month-btn" class="px-3 py-1 text-sm bg-slate-200 hover:bg-slate-300 rounded-md">&lt;</button>
                            <h3 id="calendar-month-year" class="text-lg font-semibold text-slate-600 w-32 text-center"></h3>
                            <button id="next-month-btn" class="px-3 py-1 text-sm bg-slate-200 hover:bg-slate-300 rounded-md">&gt;</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 text-center font-semibold text-xs text-gray-500 border-b pb-2">
                        <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7"></div>
                </div>
            </div>
            <div id="list-panel" class="tab-panel hidden space-y-8">
                 <div class="bg-white p-4 md:p-6 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="month-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por M√™s:</label>
                            <select id="month-filter" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm"><option value="all">Todos os Meses</option></select>
                        </div>
                        <div>
                            <label for="sector-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Setor:</label>
                            <select id="sector-filter" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm"><option value="all">Todos os Setores</option></select>
                        </div>
                        <div>
                            <label for="name-search" class="block text-sm font-medium text-gray-700 mb-1">Buscar por Nome:</label>
                            <input type="text" id="name-search" placeholder="Digite um nome..." class="w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-slate-700">Lista de Aniversariantes</h2>
                        <button id="add-person-btn" class="primary admin-only">+ Adicionar</button>
                     </div>
                     <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 sticky top-0">
                                <tr>
                                    <th class="p-4">Nome Completo</th><th class="p-4">Setor</th><th class="p-4">Data</th>
                                    <th class="p-4 text-center admin-only-table-cell">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="birthday-table-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="no-results" class="text-center p-8 text-gray-500 hidden"><p>Nenhum resultado encontrado.</p></div>
                    </div>
                </div>
            </div>
            <div id="chart-panel" class="tab-panel hidden space-y-8">
                <div class="bg-white p-4 md:p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4">An√°lises Quantitativas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-gray-50 p-6 rounded-xl flex flex-col justify-center items-center">
                            <p class="text-lg text-gray-600">Total de Colaboradores</p>
                            <p id="total-personnel" class="text-5xl font-bold" style="color: var(--eletro-blue);"></p>
                        </div>
                        <div class="md:col-span-2"><div class="h-64 md:h-80"><canvas id="sector-chart"></canvas></div></div>
                    </div>
                </div>
                <div id="import-section" class="bg-white p-4 md:p-6 rounded-lg admin-only">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4">Importar Dados em Lote</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-800">A partir de arquivo CSV</h3>
                            <p class="text-sm text-gray-500 mt-1 mb-3">Arquivo .csv com colunas: Nome, Setor, Data (DD/MM).</p>
                            <label for="csv-file-input" class="cursor-pointer inline-block px-4 py-2 text-sm font-semibold text-white rounded-lg shadow-md secondary">Selecionar Arquivo</label>
                            <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Colar dados de uma planilha</h3>
                             <p class="text-sm text-gray-500 mt-1 mb-3">Copie (Nome, Setor, Data) e cole abaixo.</p>
                            <textarea id="paste-data-input" rows="4" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Jo√£o da Silva\tTI\t22/09"></textarea>
                            <button id="paste-data-btn" class="mt-2 px-4 py-2 w-full text-sm font-semibold text-white rounded-lg secondary">Importar Dados Colados</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4">Resumo Mensal de Anivers√°rios</h2>
                    <div><canvas id="birthday-chart"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <div id="person-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold text-slate-800 mb-6"></h2>
            <form id="person-form">
                <input type="hidden" id="person-id">
                <div class="space-y-4">
                    <div>
                        <label for="person-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="person-name" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="person-sector" class="block text-sm font-medium text-gray-700">Setor</label>
                        <input type="text" id="person-sector" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                           <label for="person-day" class="block text-sm font-medium text-gray-700">Dia</label>
                           <input type="number" id="person-day" required min="1" max="31" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                         <div>
                           <label for="person-month" class="block text-sm font-medium text-gray-700">M√™s</label>
                           <select id="person-month" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></select>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-btn" class="tertiary">Cancelar</button>
                    <button type="submit" class="primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="auth-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Acesso Restrito</h2>
            <form id="auth-form">
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="password" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                </div>
                <div id="auth-error" class="mt-4 text-red-600 text-sm min-h-[20px]"></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="auth-cancel-btn" class="tertiary">Cancelar</button>
                    <button type="submit" class="primary">Entrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification-toast" class="fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        document.addEventListener("DOMContentLoaded", () => {
            // === VARI√ÅVEIS GLOBAIS ===
            let db, auth, dbCollection, currentUser, isAdmin = false;
            let birthdayData = [];
            let currentDate = new Date();
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            let useDemoMode = false;
            let authUnsubscribe, dataUnsubscribe = null;
            let birthdayChartInstance, sectorChartInstance;

            // === MAPEAMENTO DE ELEMENTOS DOM ===
            const authBtn = document.getElementById("auth-btn"), authModal = document.getElementById("auth-modal"), authForm = document.getElementById("auth-form"), authCancelBtn = document.getElementById("auth-cancel-btn"), authError = document.getElementById("auth-error");
            const tabsContainer = document.getElementById("tabs-container"), tableBody = document.getElementById("birthday-table-body"), noResultsDiv = document.getElementById("no-results");
            const monthFilter = document.getElementById("month-filter"), sectorFilter = document.getElementById("sector-filter"), nameSearch = document.getElementById("name-search");
            const birthdayChartCanvas = document.getElementById("birthday-chart"), sectorChartCanvas = document.getElementById("sector-chart"), totalPersonnelEl = document.getElementById("total-personnel");
            const calendarGrid = document.getElementById("calendar-grid"), monthYearHeader = document.getElementById("calendar-month-year"), prevMonthBtn = document.getElementById("prev-month-btn"), nextMonthBtn = document.getElementById("next-month-btn"), todayBtn = document.getElementById("today-btn");
            const todayPanel = document.getElementById("today-panel");
            const modal = document.getElementById("person-modal"), modalTitle = document.getElementById("modal-title"), personForm = document.getElementById("person-form"), cancelBtn = document.getElementById("cancel-btn"), addPersonBtn = document.getElementById("add-person-btn"), personMonthSelect = document.getElementById("person-month");
            const csvFileInput = document.getElementById("csv-file-input"), pasteDataInput = document.getElementById("paste-data-input"), pasteDataBtn = document.getElementById("paste-data-btn");
            const notificationToast = document.getElementById("notification-toast");
            
            /* ================================================== */
            /* === BLOCO DE AUTENTICA√á√ÉO E INICIALIZA√á√ÉO FIREBASE === */
            /* ================================================== */

            async function checkAdminAndApplyUI(user) {
                if (!user) { isAdmin = false; updateAdminUI(null); return; }
                try {
                    const idTokenResult = await getIdTokenResult(user, true); // true para for√ßar refresh
                    isAdmin = idTokenResult?.claims?.admin === true;
                } catch (err) { console.error('Erro ao verificar permiss√µes:', err); isAdmin = false; }
                updateAdminUI(user);
            }

            function updateAdminUI(user) {
                document.body.classList.toggle("admin-mode", isAdmin);
                if (user) { authBtn.textContent = (isAdmin ? 'üîì ' : 'üîí ') + user.email; }
                else { authBtn.textContent = "üîí Acesso Restrito"; }
            }

            function initFirebase() {
                try {
                    if (typeof window.__firebase_config !== "undefined") {
                        const firebaseConfig = JSON.parse(window.__firebase_config);
                        const app = initializeApp(firebaseConfig);
                        db = getFirestore(app); auth = getAuth(app);
                        dbCollection = collection(db, "aniversariantes");
                        if (authUnsubscribe) authUnsubscribe();
                        authUnsubscribe = onAuthStateChanged(auth, async (user) => {
                            currentUser = user; await checkAdminAndApplyUI(user); loadBirthdays();
                        });
                    } else { throw new Error("Configura√ß√£o n√£o encontrada"); }
                } catch (e) {
                    console.warn("Firebase n√£o inicializado. Rodando em modo demonstra√ß√£o.", e.message);
                    useDemoMode = true; updateAdminUI(null); loadBirthdays();
                }
            }
            
            async function handleAuth(e) {
                e.preventDefault();
                const email = document.getElementById("email").value, password = document.getElementById("password").value;
                const submitBtn = authForm.querySelector('button[type="submit"]');
                authError.textContent = "";
                const originalBtnText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Verificando...';

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    closeModal(authModal);
                    authForm.reset();
                } catch (error) {
                    console.error("Erro de Autentica√ß√£o:", error);
                    authError.textContent = `Falha no login. (Erro: ${error.code})`;
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            }

            function handleSignOut() {
                signOut(auth).then(() => showNotification('Sess√£o encerrada.')).catch(err => showNotification('Erro ao sair.', true));
            }

            /* =============================== */
            /* === BLOCO DE CARREGAMENTO DE DADOS === */
            /* =============================== */

            function loadBirthdays() {
                if (useDemoMode) {
                    birthdayData = [{ id: "d1", name: "Maria Silva (Demo)", sector: "Comercial", day: new Date().getDate(), month: new Date().getMonth() + 1 }, { id: "d2", name: "Jo√£o Santos (Demo)", sector: "TI", day: 15, month: 8 }];
                    processData(birthdayData); return;
                }
                if (dataUnsubscribe) dataUnsubscribe();
                const q = query(dbCollection, orderBy("month"), orderBy("day"));
                dataUnsubscribe = onSnapshot(q, snapshot => {
                    processData(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, error => {
                    console.error("Erro ao carregar do Firestore:", error);
                    showNotification("Erro de conex√£o com o banco de dados.", true);
                    processData([]);
                });
            }
            
            function processData(data){
                birthdayData = data;
                renderAllViews(data);
                populateFilters(data);
            }

            /* ================================= */
            /* === BLOCO DE RENDERIZA√á√ÉO DA UI === */
            /* ================================= */
            
            function renderAllViews(data){
                renderTodaysBirthdays(data);
                renderCalendar();
                applyFilters();
                renderAnalytics(data);
            }

            function renderTodaysBirthdays(data) {
                const today = new Date(), currentDay = today.getDate(), currentMonth = today.getMonth() + 1;
                const todaysBirthdays = data.filter(p => p.day === currentDay && p.month === currentMonth);
                let content = `<div class="bg-white p-4 md:p-6 rounded-lg"><h2 class="text-2xl font-bold text-slate-800 mb-4">Aniversariantes de Hoje (${monthNames[currentMonth-1]})</h2>`;
                if (todaysBirthdays.length > 0) {
                    content += `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">`;
                    todaysBirthdays.forEach(p => content += `<div class="bg-slate-50 rounded-xl p-5 text-center shadow-sm"><p class="text-lg font-semibold text-blue-800">${p.name}</p><p class="text-sm text-gray-600">${p.sector}</p></div>`);
                    content += `</div>`;
                } else { content += `<p class="text-center text-gray-500 py-8">Ningu√©m faz anivers√°rio hoje.</p>`; }
                todayPanel.innerHTML = content + `</div>`;
            }

            function renderCalendar() {
                calendarGrid.innerHTML = "";
                monthYearHeader.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
                const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) calendarGrid.insertAdjacentHTML('beforeend', `<div class="border"></div>`);
                for (let day = 1; day <= daysInMonth; day++) {
                    const bdays = birthdayData.filter(p => p.day === day && p.month === (currentDate.getMonth() + 1));
                    const isToday = day === new Date().getDate() && currentDate.getMonth() === new Date().getMonth() && currentDate.getFullYear() === new Date().getFullYear();
                    let bdayHtml = bdays.map(p => `<p class="truncate text-blue-700">${p.name}</p>`).join('');
                    calendarGrid.insertAdjacentHTML('beforeend', `<div class="border p-2 h-24 overflow-hidden ${isToday ? 'bg-blue-100' : ''}"><div class="font-bold">${day}</div><div class="text-xs mt-1">${bdayHtml}</div></div>`);
                }
            }

            function renderTable(data) {
                tableBody.innerHTML = "";
                const showNoResults = data.length === 0;
                noResultsDiv.classList.toggle("hidden", !showNoResults);
                tableBody.classList.toggle("hidden", showNoResults);
                if(showNoResults) return;
                const fragment = document.createDocumentFragment();
                data.forEach(p => {
                    const tr = document.createElement("tr");
                    tr.className = "hover:bg-gray-50";
                    tr.innerHTML = `<td class="p-4">${p.name}</td><td class="p-4 text-gray-600">${p.sector}</td><td class="p-4">${String(p.day).padStart(2, '0')}/${String(p.month).padStart(2, '0')}</td><td class="p-4 text-center admin-only-table-cell"><button data-id="${p.id}" class="edit-btn text-blue-600 hover:text-blue-800 mr-2" title="Editar">‚úèÔ∏è</button><button data-id="${p.id}" class="delete-btn text-red-600 hover:text-red-800" title="Excluir">üóëÔ∏è</button></td>`;
                    fragment.appendChild(tr);
                });
                tableBody.appendChild(fragment);
            }

            function renderAnalytics(data) {
                totalPersonnelEl.textContent = data.length;
                const monthsCount = Array(12).fill(0), sectorsCount = {};
                data.forEach(p => { monthsCount[p.month - 1]++; sectorsCount[p.sector] = (sectorsCount[p.sector] || 0) + 1; });
                
                if (birthdayChartInstance) birthdayChartInstance.destroy();
                birthdayChartInstance = new Chart(birthdayChartCanvas, { type: 'bar', data: { labels: monthNames, datasets: [{ label: 'Aniversariantes por M√™s', data: monthsCount, backgroundColor: 'rgba(0, 51, 102, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: {y: {ticks: {stepSize: 1}}} } });

                if (sectorChartInstance) sectorChartInstance.destroy();
                sectorChartInstance = new Chart(sectorChartCanvas, { type: 'doughnut', data: { labels: Object.keys(sectorsCount), datasets: [{ data: Object.values(sectorsCount), backgroundColor: ['#003366','#0072C6','#009a74','#f59e0b','#ef4444','#6366f1'] }] }, options: { responsive: true, maintainAspectRatio: false } });
            }

            /* ===================================== */
            /* === BLOCO DE MANIPULA√á√ÉO DE DADOS (CRUD) === */
            /* ===================================== */

            async function handlePersonFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById("person-id").value;
                const personData = { name: document.getElementById("person-name").value.trim(), sector: document.getElementById("person-sector").value.trim(), day: parseInt(document.getElementById("person-day").value), month: parseInt(document.getElementById("person-month").value) };
                if (!personData.name || !personData.sector) { showNotification("Nome e setor s√£o obrigat√≥rios.", true); return; }
                
                try {
                    const operation = id ? setDoc(doc(db, "aniversariantes", id), personData) : addDoc(dbCollection, personData);
                    await operation;
                    showNotification(`Dados ${id ? 'atualizados' : 'adicionados'} com sucesso!`);
                    closeModal(modal);
                } catch (error) { console.error("Erro ao salvar:", error); showNotification("Erro ao salvar os dados. Verifique suas permiss√µes.", true); }
            }

            function deletePersonFromTable(id) {
                if (confirm("Tem certeza que deseja excluir esta pessoa?")) {
                    deleteDoc(doc(db, "aniversariantes", id))
                        .then(() => showNotification("Pessoa exclu√≠da com sucesso."))
                        .catch(err => { console.error(err); showNotification("Erro ao excluir. Verifique suas permiss√µes.", true); });
                }
            }
            
            /* =============================== */
            /* === BLOCO DE IMPORTA√á√ÉO EM LOTE === */
            /* =============================== */

            function processImportedData(dataToImport) {
                if (dataToImport.length === 0) { showNotification("Nenhum dado v√°lido para importar.", true); return; }
                if (!confirm(`Voc√™ est√° prestes a adicionar ${dataToImport.length} novos registros. Continuar?`)) return;
                
                const batch = writeBatch(db);
                dataToImport.forEach(person => { const newDocRef = doc(collection(db, "aniversariantes")); batch.set(newDocRef, person); });
                
                batch.commit()
                    .then(() => showNotification(`${dataToImport.length} registros importados com sucesso!`))
                    .catch(err => { console.error(err); showNotification("Ocorreu um erro na importa√ß√£o.", true); });
            }

            function handleCsvImport(event) {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const dataToImport = e.target.result.split('\n').slice(1).map(line => {
                        const [name, sector, date] = line.split(',').map(s => s.trim());
                        if (!date || !date.includes('/')) return null;
                        const [day, month] = date.split('/').map(Number);
                        return { name, sector, day, month };
                    }).filter(Boolean);
                    processImportedData(dataToImport);
                };
                reader.readAsText(file);
                event.target.value = '';
            }
            
            function handlePasteImport() {
                const dataToImport = pasteDataInput.value.trim().split('\n').map(line => {
                    const [name, sector, date] = line.split('\t').map(s => s.trim());
                    if (!date || !date.includes('/')) return null;
                    const [day, month] = date.split('/').map(Number);
                    return { name, sector, day, month };
                }).filter(Boolean);
                processImportedData(dataToImport);
                pasteDataInput.value = '';
            }

            /* =============================== */
            /* === BLOCO DE MODAL E FILTROS === */
            /* =============================== */
            
            function openModal(targetModal, data = null) {
                if (targetModal === modal) {
                    personForm.reset(); document.getElementById("person-id").value = "";
                    if (data) {
                        modalTitle.textContent = "Editar Dados";
                        Object.entries(data).forEach(([key, value]) => { const el = document.getElementById(`person-${key}`); if (el) el.value = value; });
                    } else { modalTitle.textContent = "Adicionar Nova Pessoa"; }
                }
                targetModal.classList.remove("hidden");
            }
            
            function closeModal(targetModal) { targetModal.classList.add("hidden"); }
            
            function showNotification(message, isError = false) {
                notificationToast.textContent = message;
                notificationToast.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl transition-all duration-300 ${isError ? "bg-red-500" : "bg-green-500"}`;
                notificationToast.classList.remove("opacity-0", "translate-y-10");
                setTimeout(() => notificationToast.classList.add("opacity-0", "translate-y-10"), 3000);
            }

            function populateFilters(data) {
                const sectors = [...new Set(data.map(p => p.sector))].sort();
                sectorFilter.innerHTML = '<option value="all">Todos os Setores</option>';
                sectors.forEach(s => sectorFilter.innerHTML += `<option value="${s}">${s}</option>`);
                if (monthFilter.options.length <= 1) monthNames.forEach((name, i) => monthFilter.innerHTML += `<option value="${i+1}">${name}</option>`);
                if (personMonthSelect.options.length === 0) monthNames.forEach((name, i) => personMonthSelect.innerHTML += `<option value="${i+1}">${name}</option>`);
            }

            function applyFilters() {
                const month = monthFilter.value, sector = sectorFilter.value, search = nameSearch.value.toLowerCase();
                const filteredData = birthdayData.filter(p => (month === 'all' || p.month == month) && (sector === 'all' || p.sector == sector) && (p.name.toLowerCase().includes(search)));
                renderTable(filteredData);
            }
            
            /* ================================== */
            /* === BLOCO DE LISTENERS DE EVENTOS === */
            /* ================================== */

            // Auth button behavior: if embedded (iframe) and not logged in, open admin page in new tab (avoid cookie/auth issues)
            authBtn.addEventListener("click", () => {
                if (window.self !== window.top && !currentUser) {
                    // open hosted site in new tab so Firebase auth can work in top-level context
                    window.open("https://aniversariantes-automation.web.app/?admin=1", "_blank", "noopener");
                    return;
                }
                // fallback to default behavior
                if (currentUser) {
                    if (confirm("Deseja realmente sair?")) handleSignOut();
                } else {
                    openModal(authModal);
                }
            });

            authForm.addEventListener("submit", handleAuth);
            authCancelBtn.addEventListener("click", () => closeModal(authModal));
            tabsContainer.addEventListener("click", (e) => {
                if (e.target.matches(".tab-btn")) {
                    tabsContainer.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
                    document.querySelectorAll(".tab-panel").forEach(panel => panel.classList.add("hidden"));
                    e.target.classList.add("active");
                    document.getElementById(`${e.target.dataset.tab}-panel`).classList.remove("hidden");
                }
            });
            [monthFilter, sectorFilter, nameSearch].forEach(el => el.addEventListener('input', applyFilters));
            addPersonBtn.addEventListener("click", () => openModal(modal));
            personForm.addEventListener("submit", handlePersonFormSubmit);
            cancelBtn.addEventListener("click", () => closeModal(modal));
            tableBody.addEventListener("click", e => {
                const editBtn = e.target.closest(".edit-btn"), deleteBtn = e.target.closest(".delete-btn");
                if (isAdmin && editBtn) openModal(modal, birthdayData.find(p => p.id === editBtn.dataset.id));
                if (isAdmin && deleteBtn) deletePersonFromTable(deleteBtn.dataset.id);
            });
            prevMonthBtn.addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            todayBtn.addEventListener("click", () => { currentDate = new Date(); renderCalendar(); });
            csvFileInput.addEventListener("change", handleCsvImport);
            pasteDataBtn.addEventListener("click", handlePasteImport);

            // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
            initFirebase();
            tabsContainer.querySelector(".tab-btn").click();
            monthFilter.value = new Date().getMonth() + 1;
            // A chamada inicial do applyFilters() j√° √© feita dentro de processData(),
            // ent√£o n√£o precisamos de outra aqui para evitar uma renderiza√ß√£o dupla.
        });
    </script>
</body>
</html>
